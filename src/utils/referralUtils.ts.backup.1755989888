<<<<<<< HEAD
import { safeStorage } from './safeStorage';
import { logErrorToProduction } from '@/utils/productionLogger';

=======
import { format } from 'date-fns';
import { apiClient } from './apiClient';
>>>>>>> origin/8arrdw-codex/centralize-fetch-error-handling

/**
 * Formats a date for display in the referral system
 * @param date Date or string to format
 * @returns Formatted date string
 */
export function formatDate(date: Date | string | undefined): string {
  if (!date) return '-';
  try {
    const d = typeof date === 'string' ? new Date(date) : date;
    return new Intl.DateTimeFormat('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
    }).format(d);
  } catch (e) {
    logErrorToProduction('Error formatting date:', { data:  e });
    return '-';
  }
}

/**
 * Stores referral code in localStorage when detected in URL
 */
export function checkUrlForReferralCode(): string | null {
  if (typeof window === 'undefined') return null;
  
  const url = new URL(window.location.href);
  const refCode = url.searchParams.get('ref');
  
  if (refCode) {
    safeStorage.setItem('referral_code', refCode);
    // Remove it from URL to keep it clean
    url.searchParams.delete('ref');
    window.history.replaceState({}, document.title, url.toString());
    return refCode;
  }
  
  return safeStorage.getItem('referral_code');
}

/**
 * Track referral when a user signs up
 */
import api from '@/lib/api';

export async function trackReferral(userId: string, email: string) {
  try {
    const refCode = safeStorage.getItem('referral_code');
    if (!refCode) return false;
    
    // Call API to record the referral
<<<<<<< HEAD
    const response = await api.post('/api/track-referral', {
      refCode,
      userId,
      email,
      ipAddress: '', // This will be captured by the server
=======
    const response = await apiClient('/api/track-referral', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        refCode,
        userId,
        email,
        ipAddress: '', // This will be captured by the server
      }),
>>>>>>> origin/8arrdw-codex/centralize-fetch-error-handling
    });

    if (response.status >= 200 && response.status < 300) {
      // Clear the stored referral code
      safeStorage.removeItem('referral_code');
      return true;
    }
  } catch (error) {
    logErrorToProduction('Error tracking referral:', { data: error });
  }
  return false;
}
