# Logging Guidelines

This project uses a centralized, structured logger defined in `src/utils/productionLogger.ts`. Avoid using `console.log` directly. Instead, import the specific logging functions (e.g., `logInfo`, `logError`) and use the appropriate log level.

```typescript
import { logDebug, logInfo, logWarn, logError, timeStart, timeEnd } from '@/utils/productionLogger';

logDebug('This is a debug message with context', { data: 'someValue' });
logInfo('This is an info message.');
logWarn('This is a warning message.', { userId: 'user123' });

try {
  // ... some operation that might fail
  throw new Error("Something went wrong!");
} catch (e) {
  // logError handles the error object, an optional message, and additional context
  logError('Operation failed', e as Error, { component: 'MyComponent' });
}

// For performance timing
const timerLabel = 'MyOperation';
timeStart(timerLabel);
// ... some operation
const duration = timeEnd(timerLabel); // duration is also automatically logged
if (duration !== undefined) {
  logInfo(\`Operation ${timerLabel} took ${duration.toFixed(2)}ms\`);
}
```

## Key Features of `productionLogger`

*   **Structured Logging**: Logs can include additional context objects.
*   **Log Levels**: Supports `debug`, `info`, `warn`, `error`.
*   **Error Reporting**: `logError` automatically reports errors to configured services (Sentry, Datadog, LogRocket, and a custom webhook via `src/utils/logError.ts`).
*   **Performance Timing**: `timeStart` and `timeEnd` for measuring code execution duration.
*   **Client-Side Buffering**: Logs are buffered on the client and sent to a backend endpoint (`/api/logs`) periodically, which can then persist them and/or forward them.
*   **Console Output**: Logs are also output to the browser console during development (and errors/warnings typically in production too).

## Log Levels and Output

*   **`logDebug`**: Only outputs to console in development mode (or if `DEBUG=true` in `.env.local`). Buffered and sent to `/api/logs`.
*   **`logInfo`**: Outputs to console in development. Buffered and sent to `/api/logs`.
*   **`logWarn`**: Outputs to console. Buffered and sent to `/api/logs`. Warnings sent to `/api/logs` may also be forwarded to Sentry as messages.
*   **`logError`**: Outputs to console. Directly reported to Sentry, Datadog, LogRocket, and the custom webhook. **Not** sent via the `/api/logs` buffering system to avoid duplication.

## Enabling Debug Logs in Console

Debug logs (`logDebug`) are shown in the browser console automatically in development environments. You can also force more verbose debug output from various parts of the system by setting `DEBUG=true` in your `.env.local` file.

## Server-Side Logging

*   Next.js API routes and server-side components primarily use Sentry for error capture, initialized via `instrumentation.ts`.
*   The `/api/logs` endpoint handles logs sent from the client-side `productionLogger`. It can write these to local files (e.g., `logs/client-YYYY-MM-DD.log`) if the filesystem is writable and forward them to Sentry or other webhooks.

## Specialized Log Files

The system may also generate specialized log files, typically through scheduled scripts or background processes:

*   `logs/self-heal.log`: Log file for the `scripts/watchdog.js` monitoring script.
*   `logs/perf/hourly.log`: Contains performance metrics from backend endpoint checks. Generated by `scripts/perf/monitor.js` (requires setup with a process manager like PM2).
*   `logs/security/hourly-fix.log`: Logs results from the hourly NPM audit script. Generated by `scripts/hourly_audit.sh` (requires cron job setup).
  These directories are also scanned by `npm run logs:collect:enhanced` to include performance and security logs in consolidated reports.

Refer to `docs/hourly_audit_setup.md` and `docs/performance_monitoring_setup.md` (once created) for details on setting up these scripts.

## Collecting Logs for Troubleshooting

To gather various log files for troubleshooting or to share with support, run:

```bash
npm run logs:collect
```

This command creates a timestamped archive under `logs/archive/` and includes:

*   General logs from the `logs/` directory (including any `client-*.log` files, `self-heal.log`, `perf/hourly.log`, `security/hourly-fix.log` if present).
*   Server logs from `server/logs/` (if applicable).
*   Test run outputs from `playwright-logs/` and `cypress/results/`.
*   Any `.log` files in the project root.
*   Test results from `test-results/` and `test_results.json` if present.

Always check the `AGENTS.md` file for any project-specific conventions or automated checks related to logging.

## Analyzing Logs for Errors

After collecting logs, you can quickly scan them for common issues using the built-in analyzer:

```bash
npm run logs:summary
```

This command searches all log files for error patterns and now also extracts any **missing translation keys** it finds. A summary report along with a `missing-keys-<timestamp>.log` file will be generated under `logs/summary/`.

## One-Stop Log Collection

For convenience you can run the full log collection and summary process in one step:

```bash
npm run logs:auto
```

This runs the enhanced log collector followed by the summary analyzer so you always have up-to-date reports in the `logs` directory.

## Log Maintenance

To prevent the `logs/` directory from growing indefinitely, you can purge old log files based on their modification date:

```bash
npm run logs:purge
```

This command deletes any `.log` files older than 30 days (configurable via the `LOG_RETENTION_DAYS` environment variable) from the `logs/` folder and its subdirectories.
