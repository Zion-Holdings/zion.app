const fs = require('fs');
const path = require('path');
const PDFDocument = require('pdfkit');

function ensureDir(p) {
  fs.mkdirSync(p, { recursive: true });
}

function readMarkdown() {
  const mdPath = path.resolve(__dirname, '../../../docs/zion-protocol-whitepaper.md');
  return fs.readFileSync(mdPath, 'utf8');
}

function mdToTextBlocks(md) {
  return md.split(/\n\n+/).map((b) => b.replace(/^#\s*/gm, '').replace(/^##\s*/gm, '').trim()).filter(Boolean);
}

function writePdf(blocks, outPath) {
  const doc = new PDFDocument({ autoFirstPage: true, margins: { top: 50, left: 50, right: 50, bottom: 50 } });
  const stream = fs.createWriteStream(outPath);
  doc.pipe(stream);
  doc.fontSize(18).text('Zion Protocol Whitepaper', { underline: true });
  doc.moveDown();
  doc.fontSize(10).fillColor('#666666').text('Static export generated by Cloud Automations');
  doc.moveDown();
  doc.fontSize(11).fillColor('#222222');
  blocks.forEach((b) => {
    doc.text(b, { width: 500, align: 'left' });
    doc.moveDown();
  });
  doc.end();
  return new Promise((resolve) => stream.on('close', resolve));
}

async function main() {
  const startedAt = new Date().toISOString();
  const outDir = path.resolve(__dirname, '../../../public/docs');
  ensureDir(outDir);
  const outPath = path.join(outDir, 'zion-protocol.pdf');

  let success = false; let error = null; let bytes = 0;
  try {
    const md = readMarkdown();
    const blocks = mdToTextBlocks(md);
    await writePdf(blocks, outPath);
    bytes = fs.statSync(outPath).size;
    success = true;
  } catch (e) {
    error = String(e);
  }

  const status = {
    name: 'Static Whitepaper PDF Exporter',
    key: 'whitepaper-static-pdf-exporter',
    startedAt,
    finishedAt: new Date().toISOString(),
    success,
    metrics: { output: '/docs/zion-protocol.pdf', bytes },
    error,
  };
  const statusDir = path.resolve(__dirname, '../../../data/cloud-automations');
  ensureDir(statusDir);
  fs.writeFileSync(path.join(statusDir, 'whitepaper-static-pdf-exporter.json'), JSON.stringify(status, null, 2));
  console.log('[whitepaper-static-pdf-exporter] ' + (success ? 'ok' : 'failed'));
}

main();