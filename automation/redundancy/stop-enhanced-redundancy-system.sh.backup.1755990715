#!/bin/bash

<<<<<<< HEAD
# Enhanced Redundancy Automation System Shutdown Script
# This script gracefully shuts down the comprehensive redundancy system
=======
# Enhanced Redundancy System Stop Script
# This script stops the comprehensive redundancy automation system
# Created by Enhanced Master Redundancy Orchestrator
>>>>>>> origin/cursor/automate-deployment-redundancy-and-clean-up-e342

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
<<<<<<< HEAD
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
LOG_DIR="$PROJECT_ROOT/automation/logs"
REDUNDANCY_DIR="$SCRIPT_DIR"
PID_FILE="$REDUNDANCY_DIR/enhanced-redundancy.pid"
ENHANCED_ORCHESTRATOR="$REDUNDANCY_DIR/enhanced-master-redundancy-orchestrator.cjs"

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}[$(date '+%Y-%m-%d %H:%M:%S')] ${message}${NC}"
}

# Function to check if system is running
check_if_running() {
    if [ ! -f "$PID_FILE" ]; then
        print_status $YELLOW "⚠️  No PID file found, checking for running processes..."
        
        # Look for any enhanced redundancy processes
        local pids=$(pgrep -f "enhanced-master-redundancy-orchestrator" || true)
        if [ -n "$pids" ]; then
            print_status $YELLOW "⚠️  Found running enhanced redundancy processes: $pids"
            return 0
        else
            print_status $BLUE "ℹ️  No enhanced redundancy processes found running"
            return 1
        fi
    fi
    
    local pid=$(cat "$PID_FILE")
    if kill -0 $pid 2>/dev/null; then
        print_status $GREEN "✅ Found running Enhanced Redundancy Automation System (PID: $pid)"
        return 0
    else
        print_status $YELLOW "⚠️  PID file exists but process is not running, cleaning up..."
        rm -f "$PID_FILE"
=======
NC='\033[0m' # No Color

# Script configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"
LOG_DIR="$WORKSPACE_DIR/automation/logs"
ORCHESTRATOR_SCRIPT="$SCRIPT_DIR/enhanced-master-redundancy-orchestrator.cjs"
PID_FILE="$LOG_DIR/enhanced-orchestrator.pid"

# Function to print colored output
print_status() {
    local level=$1
    local message=$2
    case $level in
        "INFO")
            echo -e "${BLUE}[INFO]${NC} $message"
            ;;
        "SUCCESS")
            echo -e "${GREEN}[SUCCESS]${NC} $message"
            ;;
        "WARNING")
            echo -e "${YELLOW}[WARNING]${NC} $message"
            ;;
        "ERROR")
            echo -e "${RED}[ERROR]${NC} $message"
            ;;
        *)
            echo "[$level] $message"
            ;;
    esac
}

# Function to check if system is running
check_system_status() {
    print_status "INFO" "Checking system status..."
    
    local system_running=false
    
    # Check if orchestrator process is running
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE" 2>/dev/null || echo "")
        if [ -n "$pid" ] && kill -0 $pid 2>/dev/null; then
            print_status "INFO" "Found running orchestrator process (PID: $pid)"
            system_running=true
        else
            print_status "WARNING" "PID file exists but process is not running. Cleaning up PID file."
            rm -f "$PID_FILE"
        fi
    fi
    
    # Check for any enhanced redundancy processes
    if pgrep -f "enhanced-master-redundancy-orchestrator" > /dev/null; then
        print_status "INFO" "Found enhanced redundancy orchestrator processes"
        system_running=true
    fi
    
    # Check PM2 processes
    if command -v pm2 &> /dev/null; then
        local pm2_processes=$(pm2 list | grep -c "enhanced-backup" || echo "0")
        if [ "$pm2_processes" -gt 0 ]; then
            print_status "INFO" "Found $pm2_processes enhanced backup PM2 processes"
            system_running=true
        fi
    fi
    
    if [ "$system_running" = false ]; then
        print_status "INFO" "Enhanced redundancy system is not running."
        return 1
    fi
    
    return 0
}

# Function to stop the orchestrator gracefully
stop_orchestrator() {
    print_status "INFO" "Stopping enhanced master redundancy orchestrator..."
    
    if [ -f "$ORCHESTRATOR_SCRIPT" ]; then
        # Try to stop gracefully first
        if node "$ORCHESTRATOR_SCRIPT" stop > /dev/null 2>&1; then
            print_status "SUCCESS" "Orchestrator stopped gracefully."
            return 0
        else
            print_status "WARNING" "Graceful stop failed, attempting force stop..."
            return 1
        fi
    else
        print_status "WARNING" "Orchestrator script not found, will use force stop."
>>>>>>> origin/cursor/automate-deployment-redundancy-and-clean-up-e342
        return 1
    fi
}

<<<<<<< HEAD
# Function to stop PM2 backup processes
stop_pm2_backup_processes() {
    print_status $BLUE "🛑 Stopping PM2 backup processes..."
    
    # Get list of backup processes
    local backup_processes=$(pm2 list | grep -E "(backup|enhanced)" | awk '{print $2}' || true)
    
    if [ -n "$backup_processes" ]; then
        print_status $CYAN "📋 Found PM2 backup processes: $backup_processes"
        
        for process in $backup_processes; do
            print_status $CYAN "🛑 Stopping PM2 process: $process"
            pm2 stop "$process" 2>/dev/null || true
            pm2 delete "$process" 2>/dev/null || true
        done
        
        print_status $GREEN "✅ PM2 backup processes stopped"
    else
        print_status $BLUE "ℹ️  No PM2 backup processes found"
    fi
}

# Function to stop the enhanced orchestrator
stop_enhanced_orchestrator() {
    if [ -f "$PID_FILE" ]; then
        local pid=$(cat "$PID_FILE")
        
        print_status $BLUE "🛑 Stopping Enhanced Redundancy Orchestrator (PID: $pid)..."
        
        # Try graceful shutdown first
        kill -TERM $pid 2>/dev/null || true
        
        # Wait for graceful shutdown
        local count=0
        while kill -0 $pid 2>/dev/null && [ $count -lt 10 ]; do
            print_status $CYAN "⏳ Waiting for graceful shutdown... ($count/10)"
            sleep 1
            count=$((count + 1))
        done
        
        # Force kill if still running
        if kill -0 $pid 2>/dev/null; then
            print_status $YELLOW "⚠️  Force killing process..."
            kill -KILL $pid 2>/dev/null || true
            sleep 1
        fi
        
        # Verify process is stopped
        if kill -0 $pid 2>/dev/null; then
            print_status $RED "❌ Failed to stop process $pid"
            return 1
        else
            print_status $GREEN "✅ Enhanced Redundancy Orchestrator stopped successfully"
            rm -f "$PID_FILE"
            return 0
        fi
    else
        print_status $BLUE "ℹ️  No PID file found for enhanced orchestrator"
        return 0
    fi
}

# Function to stop any remaining enhanced redundancy processes
stop_remaining_processes() {
    print_status $BLUE "🔍 Looking for any remaining enhanced redundancy processes..."
    
    # Look for processes by name pattern
    local pids=$(pgrep -f "enhanced-master-redundancy-orchestrator" || true)
    
    if [ -n "$pids" ]; then
        print_status $YELLOW "⚠️  Found remaining processes: $pids"
        
        for pid in $pids; do
            print_status $CYAN "🛑 Stopping remaining process: $pid"
            kill -TERM $pid 2>/dev/null || true
            
            # Wait a moment
            sleep 1
            
            # Force kill if still running
            if kill -0 $pid 2>/dev/null; then
                print_status $YELLOW "⚠️  Force killing remaining process: $pid"
                kill -KILL $pid 2>/dev/null || true
            fi
        done
        
        print_status $GREEN "✅ Remaining processes stopped"
    else
        print_status $BLUE "ℹ️  No remaining processes found"
    fi
}

# Function to cleanup backup files (optional)
cleanup_backup_files() {
    print_status $BLUE "🧹 Cleaning up backup files..."
    
    read -p "Do you want to remove backup workflows and functions? (y/N): " -n 1 -r
    echo
    
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        print_status $YELLOW "⚠️  Removing backup workflows..."
        
        # Remove backup workflows
        if [ -d ".github/workflows/backup" ]; then
            rm -rf .github/workflows/backup
            print_status $GREEN "✅ Backup workflows removed"
        fi
        
        # Remove backup functions
        if [ -d "netlify/functions/backup" ]; then
            rm -rf netlify/functions/backup
            print_status $GREEN "✅ Backup functions removed"
        fi
        
        # Remove backup PM2 processes
        stop_pm2_backup_processes
        
        print_status $GREEN "✅ All backup files cleaned up"
    else
        print_status $BLUE "ℹ️  Skipping backup file cleanup"
    fi
}

# Function to show shutdown summary
show_shutdown_summary() {
    print_status $BLUE "📋 Enhanced Redundancy Automation System Shutdown Summary"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "🛑 System Status: Shutdown Complete"
    echo "📁 Log Files: $LOG_DIR/enhanced-redundancy-*.log"
    echo "📊 PM2 Status: $(pm2 list | grep -c "backup\|enhanced" || echo "0") backup processes"
    echo "🔧 GitHub Actions: $(ls -1 .github/workflows/backup/ 2>/dev/null | wc -l || echo "0") backup workflows"
    echo "⚡ Netlify Functions: $(ls -1 netlify/functions/backup/ 2>/dev/null | wc -l || echo "0") backup functions"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

# Function to emergency shutdown
emergency_shutdown() {
    print_status $RED "🚨 EMERGENCY SHUTDOWN INITIATED"
    
    # Force stop all processes
    local pids=$(pgrep -f "enhanced.*redundancy" || true)
    if [ -n "$pids" ]; then
        print_status $RED "🚨 Force killing all enhanced redundancy processes: $pids"
        for pid in $pids; do
            kill -KILL $pid 2>/dev/null || true
        done
    fi
    
    # Stop PM2 backup processes
    stop_pm2_backup_processes
    
    # Remove PID file
    rm -f "$PID_FILE"
    
    print_status $RED "🚨 Emergency shutdown completed"
}

# Function to graceful shutdown
graceful_shutdown() {
    print_status $BLUE "🛑 Initiating graceful shutdown..."
    
    # Stop PM2 backup processes first
    stop_pm2_backup_processes
    
    # Stop the enhanced orchestrator
    stop_enhanced_orchestrator
    
    # Stop any remaining processes
    stop_remaining_processes
    
    # Verify all processes are stopped
    local remaining_pids=$(pgrep -f "enhanced.*redundancy" || true)
    if [ -n "$remaining_pids" ]; then
        print_status $YELLOW "⚠️  Some processes still running, attempting force stop..."
        for pid in $remaining_pids; do
            kill -KILL $pid 2>/dev/null || true
        done
    fi
    
    print_status $GREEN "✅ Graceful shutdown completed"
=======
# Function to force stop orchestrator processes
force_stop_orchestrator() {
    print_status "INFO" "Force stopping orchestrator processes..."
    
    # Kill processes by name
    local pids=$(pgrep -f "enhanced-master-redundancy-orchestrator" || echo "")
    if [ -n "$pids" ]; then
        print_status "INFO" "Killing orchestrator processes: $pids"
        echo $pids | xargs kill -TERM 2>/dev/null || true
        
        # Wait a moment for graceful shutdown
        sleep 3
        
        # Force kill if still running
        local still_running=$(pgrep -f "enhanced-master-redundancy-orchestrator" || echo "")
        if [ -n "$still_running" ]; then
            print_status "WARNING" "Processes still running, force killing: $still_running"
            echo $still_running | xargs kill -KILL 2>/dev/null || true
        fi
    fi
    
    # Remove PID file
    if [ -f "$PID_FILE" ]; then
        rm -f "$PID_FILE"
        print_status "SUCCESS" "Removed PID file."
    fi
}

# Function to stop PM2 processes
stop_pm2_processes() {
    print_status "INFO" "Stopping enhanced backup PM2 processes..."
    
    if command -v pm2 &> /dev/null; then
        # List enhanced backup processes
        local enhanced_processes=$(pm2 list | grep "enhanced-backup" | awk '{print $2}' || echo "")
        
        if [ -n "$enhanced_processes" ]; then
            print_status "INFO" "Found enhanced backup processes: $enhanced_processes"
            
            # Stop each process
            for process in $enhanced_processes; do
                print_status "INFO" "Stopping PM2 process: $process"
                pm2 stop "$process" 2>/dev/null || true
                pm2 delete "$process" 2>/dev/null || true
            done
            
            print_status "SUCCESS" "All enhanced backup PM2 processes stopped."
        else
            print_status "INFO" "No enhanced backup PM2 processes found."
        fi
        
        # Stop all PM2 processes if requested
        if [ "$1" = "all" ]; then
            print_status "INFO" "Stopping all PM2 processes..."
            pm2 stop all 2>/dev/null || true
            pm2 delete all 2>/dev/null || true
            print_status "SUCCESS" "All PM2 processes stopped."
        fi
    else
        print_status "WARNING" "PM2 not found, skipping PM2 cleanup."
    fi
}

# Function to cleanup backup files
cleanup_backup_files() {
    print_status "INFO" "Cleaning up backup files..."
    
    local cleanup_count=0
    
    # Clean up GitHub Actions backup workflows
    local workflows_dir="$WORKSPACE_DIR/.github/workflows"
    if [ -d "$workflows_dir" ]; then
        local backup_workflows=$(find "$workflows_dir" -name "*-enhanced-backup.yml" -o -name "*-emergency-backup.yml" -o -name "*-health-check.yml" || echo "")
        if [ -n "$backup_workflows" ]; then
            print_status "INFO" "Removing backup workflow files..."
            echo "$backup_workflows" | xargs rm -f 2>/dev/null || true
            cleanup_count=$((cleanup_count + $(echo "$backup_workflows" | wc -l)))
        fi
    fi
    
    # Clean up Netlify backup functions
    local functions_dir="$WORKSPACE_DIR/netlify/functions"
    if [ -d "$functions_dir" ]; then
        local backup_functions=$(find "$functions_dir" -name "*-enhanced-backup" -o -name "*-emergency-backup" -o -name "*-health-check" -type d || echo "")
        if [ -n "$backup_functions" ]; then
            print_status "INFO" "Removing backup function directories..."
            echo "$backup_functions" | xargs rm -rf 2>/dev/null || true
            cleanup_count=$((cleanup_count + $(echo "$backup_functions" | wc -l)))
        fi
    fi
    
    if [ $cleanup_count -gt 0 ]; then
        print_status "SUCCESS" "Cleaned up $cleanup_count backup files/directories."
    else
        print_status "INFO" "No backup files to clean up."
    fi
}

# Function to cleanup log files
cleanup_log_files() {
    print_status "INFO" "Cleaning up log files..."
    
    local log_cleanup=false
    
    # Remove enhanced redundancy log files
    if [ -d "$LOG_DIR" ]; then
        local enhanced_logs=$(find "$LOG_DIR" -name "*enhanced*" -type f || echo "")
        if [ -n "$enhanced_logs" ]; then
            print_status "INFO" "Removing enhanced redundancy log files..."
            echo "$enhanced_logs" | xargs rm -f 2>/dev/null || true
            log_cleanup=true
        fi
    fi
    
    # Remove automation logs directory if empty
    local automation_logs="$WORKSPACE_DIR/automation/logs"
    if [ -d "$automation_logs" ] && [ -z "$(ls -A "$automation_logs" 2>/dev/null)" ]; then
        print_status "INFO" "Removing empty automation logs directory..."
        rmdir "$automation_logs" 2>/dev/null || true
        log_cleanup=true
    fi
    
    if [ "$log_cleanup" = true ]; then
        print_status "SUCCESS" "Log files cleaned up."
    else
        print_status "INFO" "No log files to clean up."
    fi
}

# Function to generate final status report
generate_final_report() {
    print_status "INFO" "Generating final status report..."
    
    local report_file="$LOG_DIR/enhanced-system-shutdown-report.json"
    local report_data=$(cat <<EOF
{
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "action": "system_shutdown",
  "status": "completed",
  "cleanup": {
    "orchestrator_stopped": true,
    "pm2_processes_stopped": true,
    "backup_files_cleaned": true,
    "log_files_cleaned": true
  },
  "shutdown_method": "$1"
}
EOF
)
    
    echo "$report_data" > "$report_file"
    print_status "SUCCESS" "Final status report generated: $report_file"
}

# Function to handle force stop
handle_force_stop() {
    print_status "WARNING" "Force stop requested. This will immediately terminate all processes."
    
    if [ "$1" != "force" ]; then
        read -p "Are you sure you want to force stop? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_status "INFO" "Force stop cancelled by user."
            exit 0
        fi
    fi
    
    print_status "INFO" "Executing force stop..."
    
    # Force stop orchestrator
    force_stop_orchestrator
    
    # Force stop all PM2 processes
    stop_pm2_processes "all"
    
    # Cleanup all backup files
    cleanup_backup_files
    
    # Cleanup log files
    cleanup_log_files
    
    print_status "SUCCESS" "Force stop completed."
}

# Function to perform graceful shutdown
perform_graceful_shutdown() {
    print_status "INFO" "Performing graceful shutdown..."
    
    # Try to stop orchestrator gracefully
    if ! stop_orchestrator; then
        print_status "WARNING" "Graceful stop failed, using force stop."
        force_stop_orchestrator
    fi
    
    # Stop PM2 processes
    stop_pm2_processes
    
    # Cleanup backup files
    cleanup_backup_files
    
    # Cleanup log files
    cleanup_log_files
    
    print_status "SUCCESS" "Graceful shutdown completed."
}

# Function to display shutdown information
display_shutdown_info() {
    print_status "INFO" "Enhanced redundancy system shutdown completed."
    print_status "INFO" "Shutdown actions performed:"
    print_status "INFO" "  - Enhanced Master Redundancy Orchestrator stopped"
    print_status "INFO" "  - Enhanced PM2 Redundancy Manager stopped"
    print_status "INFO" "  - Enhanced GitHub Actions Redundancy Manager stopped"
    print_status "INFO" "  - Enhanced Netlify Functions Redundancy Manager stopped"
    print_status "INFO" "  - Backup files cleaned up"
    print_status "INFO" "  - Log files cleaned up"
    
    print_status "INFO" "To restart the system, use:"
    print_status "INFO" "  $SCRIPT_DIR/start-enhanced-redundancy-system.sh"
    
    print_status "SUCCESS" "Enhanced redundancy system is now stopped!"
>>>>>>> origin/cursor/automate-deployment-redundancy-and-clean-up-e342
}

# Main execution
main() {
<<<<<<< HEAD
    echo ""
    print_status $PURPLE "🛑 Enhanced Redundancy Automation System Shutdown"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    
    # Check if system is running
    if ! check_if_running; then
        print_status $BLUE "ℹ️  Enhanced Redundancy Automation System is not running"
        exit 0
    fi
    
    # Ask user for shutdown type
    echo "Choose shutdown method:"
    echo "1) Graceful shutdown (recommended)"
    echo "2) Emergency shutdown (force kill all processes)"
    echo "3) Cancel shutdown"
    echo ""
    read -p "Enter your choice (1-3): " -n 1 -r
    echo ""
    
    case $REPLY in
        1)
            print_status $BLUE "🔄 Performing graceful shutdown..."
            graceful_shutdown
            ;;
        2)
            print_status $RED "🚨 Performing emergency shutdown..."
            emergency_shutdown
            ;;
        3)
            print_status $BLUE "ℹ️  Shutdown cancelled"
            exit 0
            ;;
        *)
            print_status $RED "❌ Invalid choice, performing graceful shutdown..."
            graceful_shutdown
            ;;
    esac
    
    # Show shutdown summary
    show_shutdown_summary
    
    # Ask about cleanup
    cleanup_backup_files
    
    echo ""
    print_status $GREEN "🎉 Enhanced Redundancy Automation System shutdown completed!"
    echo ""
    print_status $CYAN "📊 To restart the system:"
    echo "   • Run: $REDUNDANCY_DIR/start-enhanced-redundancy-system.sh"
    echo ""
    print_status $CYAN "📋 To check system status:"
    echo "   • PM2 status: pm2 status"
    echo "   • Process check: ps aux | grep enhanced"
    echo "   • Log files: ls -la $LOG_DIR/enhanced-redundancy-*.log"
    echo ""
}

# Handle command line arguments
case "${1:-}" in
    --emergency|-e)
        print_status $RED "🚨 Emergency shutdown requested via command line"
        emergency_shutdown
        show_shutdown_summary
        exit 0
        ;;
    --force|-f)
        print_status $YELLOW "⚠️  Force shutdown requested via command line"
        graceful_shutdown
        show_shutdown_summary
        exit 0
        ;;
    --help|-h)
        echo "Usage: $0 [OPTIONS]"
        echo ""
        echo "Options:"
        echo "  --emergency, -e    Force emergency shutdown (kill all processes)"
        echo "  --force, -f        Force graceful shutdown"
        echo "  --help, -h         Show this help message"
        echo ""
        echo "If no options provided, interactive shutdown will be performed."
        exit 0
        ;;
    "")
        # No arguments, run interactive shutdown
        main
        ;;
    *)
        print_status $RED "❌ Unknown option: $1"
        echo "Use --help for usage information"
        exit 1
        ;;
esac
=======
    local force_stop=false
    local cleanup_all=false
    
    # Parse command line arguments
    while [[ $# -gt 0 ]]; do
        case $1 in
            --force|-f)
                force_stop=true
                shift
                ;;
            --cleanup-all|-c)
                cleanup_all=true
                shift
                ;;
            --help|-h)
                echo "Usage: $0 [OPTIONS]"
                echo "Options:"
                echo "  --force, -f        Force stop all processes immediately"
                echo "  --cleanup-all, -c  Clean up all backup files and logs"
                echo "  --help, -h         Show this help message"
                exit 0
                ;;
            *)
                print_status "ERROR" "Unknown option: $1"
                exit 1
                ;;
        esac
    done
    
    print_status "INFO" "Stopping Enhanced Redundancy System..."
    print_status "INFO" "Script directory: $SCRIPT_DIR"
    print_status "INFO" "Workspace directory: $WORKSPACE_DIR"
    print_status "INFO" "Log directory: $LOG_DIR"
    
    # Check if system is running
    if ! check_system_status; then
        print_status "INFO" "System is not running. Nothing to stop."
        exit 0
    fi
    
    # Perform shutdown based on options
    if [ "$force_stop" = true ]; then
        handle_force_stop "force"
    else
        perform_graceful_shutdown
    fi
    
    # Generate final report
    generate_final_report "$([ "$force_stop" = true ] && echo "force" || echo "graceful")"
    
    # Display shutdown information
    display_shutdown_info
    
    print_status "SUCCESS" "Enhanced redundancy system shutdown completed successfully!"
}

# Check if script is being sourced or executed
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    # Script is being executed
    main "$@"
else
    # Script is being sourced
    print_status "INFO" "Enhanced redundancy stop script sourced. Use main function to stop the system."
fi
>>>>>>> origin/cursor/automate-deployment-redundancy-and-clean-up-e342
