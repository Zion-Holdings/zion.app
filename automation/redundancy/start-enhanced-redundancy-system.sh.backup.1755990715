#!/bin/bash

<<<<<<< HEAD
# Enhanced Redundancy Automation System Startup Script
# This script starts the comprehensive redundancy system for all PM2, GitHub Actions, and Netlify Functions automations
=======
# Enhanced Redundancy System Startup Script
# This script starts the comprehensive redundancy automation system
# Created by Enhanced Master Redundancy Orchestrator
>>>>>>> origin/cursor/automate-deployment-redundancy-and-clean-up-e342

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
<<<<<<< HEAD
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"
LOG_DIR="$PROJECT_ROOT/automation/logs"
REDUNDANCY_DIR="$SCRIPT_DIR"
ENHANCED_ORCHESTRATOR="$REDUNDANCY_DIR/enhanced-master-redundancy-orchestrator.cjs"

# Function to print colored output
print_status() {
    local color=$1
    local message=$2
    echo -e "${color}[$(date '+%Y-%m-%d %H:%M:%S')] ${message}${NC}"
=======
NC='\033[0m' # No Color

# Script configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
WORKSPACE_DIR="$(dirname "$(dirname "$SCRIPT_DIR")")"
LOG_DIR="$WORKSPACE_DIR/automation/logs"
ORCHESTRATOR_SCRIPT="$SCRIPT_DIR/enhanced-master-redundancy-orchestrator.cjs"

# Function to print colored output
print_status() {
    local level=$1
    local message=$2
    case $level in
        "INFO")
            echo -e "${BLUE}[INFO]${NC} $message"
            ;;
        "SUCCESS")
            echo -e "${GREEN}[SUCCESS]${NC} $message"
            ;;
        "WARNING")
            echo -e "${YELLOW}[WARNING]${NC} $message"
            ;;
        "ERROR")
            echo -e "${RED}[ERROR]${NC} $message"
            ;;
        *)
            echo "[$level] $message"
            ;;
    esac
>>>>>>> origin/cursor/automate-deployment-redundancy-and-clean-up-e342
}

# Function to check prerequisites
check_prerequisites() {
<<<<<<< HEAD
    print_status $BLUE "🔍 Checking prerequisites..."
    
    # Check if Node.js is available
    if ! command -v node &> /dev/null; then
        print_status $RED "❌ Node.js is not installed or not in PATH"
=======
    print_status "INFO" "Checking prerequisites..."
    
    # Check if Node.js is installed
    if ! command -v node &> /dev/null; then
        print_status "ERROR" "Node.js is not installed. Please install Node.js 20.18.1 or higher."
>>>>>>> origin/cursor/automate-deployment-redundancy-and-clean-up-e342
        exit 1
    fi
    
    # Check Node.js version
<<<<<<< HEAD
    local node_version=$(node --version | cut -d'v' -f2)
    local required_version="20.18.1"
    
    if ! node -e "
        const current = process.version.slice(1).split('.').map(Number);
        const required = '$required_version'.split('.').map(Number);
        const isCompatible = current[0] > required[0] || 
                           (current[0] === required[0] && current[1] > required[1]) ||
                           (current[0] === required[0] && current[1] === required[1] && current[2] >= required[2]);
        process.exit(isCompatible ? 0 : 1);
    "; then
        print_status $RED "❌ Node.js version $node_version is below required version $required_version"
        exit 1
    fi
    
    print_status $GREEN "✅ Node.js version $node_version is compatible"
    
    # Check if npm is available
    if ! command -v npm &> /dev/null; then
        print_status $RED "❌ npm is not installed or not in PATH"
        exit 1
    fi
    
    print_status $GREEN "✅ npm is available"
    
    # Check if PM2 is available
    if ! command -v pm2 &> /dev/null; then
        print_status $YELLOW "⚠️  PM2 is not installed, will attempt to install it"
        npm install -g pm2 || {
            print_status $RED "❌ Failed to install PM2"
            exit 1
        }
    fi
    
    print_status $GREEN "✅ PM2 is available"
    
    # Check if required directories exist
    if [ ! -d "$PROJECT_ROOT" ]; then
        print_status $RED "❌ Project root directory not found: $PROJECT_ROOT"
        exit 1
    fi
    
    if [ ! -d "$REDUNDANCY_DIR" ]; then
        print_status $RED "❌ Redundancy directory not found: $REDUNDANCY_DIR"
        exit 1
    fi
    
    # Create log directory if it doesn't exist
    mkdir -p "$LOG_DIR"
    
    print_status $GREEN "✅ All prerequisites satisfied"
}

# Function to install dependencies
install_dependencies() {
    print_status $BLUE "📦 Installing dependencies..."
    
    cd "$PROJECT_ROOT"
    
    # Install node-cron if not already installed
    if ! node -e "require('node-cron')" 2>/dev/null; then
        print_status $YELLOW "Installing node-cron..."
        npm install node-cron || {
            print_status $RED "❌ Failed to install node-cron"
            exit 1
        }
    fi
    
    print_status $GREEN "✅ Dependencies installed"
}

# Function to start the enhanced redundancy system
start_enhanced_system() {
    print_status $BLUE "🚀 Starting Enhanced Redundancy Automation System..."
    
    cd "$PROJECT_ROOT"
    
    # Check if the enhanced orchestrator exists
    if [ ! -f "$ENHANCED_ORCHESTRATOR" ]; then
        print_status $RED "❌ Enhanced orchestrator not found: $ENHANCED_ORCHESTRATOR"
        exit 1
    fi
    
    # Start the enhanced master redundancy orchestrator
    print_status $CYAN "🎯 Launching Enhanced Master Redundancy Orchestrator..."
    
    # Create a startup script that will run the orchestrator
    local startup_script="$REDUNDANCY_DIR/startup-enhanced-orchestrator.js"
    
    cat > "$startup_script" << 'EOF'
#!/usr/bin/env node
'use strict';

const EnhancedMasterRedundancyOrchestrator = require('./enhanced-master-redundancy-orchestrator.cjs');

async function main() {
    console.log('🚀 Enhanced Redundancy Automation System Starting...');
    
    try {
        const orchestrator = new EnhancedMasterRedundancyOrchestrator();
        
        // Start all enhanced managers
        await orchestrator.startAllEnhancedManagers();
        
        // Start enhanced health monitoring
        await orchestrator.startEnhancedHealthMonitoring();
        
        console.log('✅ Enhanced Redundancy Automation System started successfully');
        console.log('📊 System is now monitoring and managing all automation redundancies');
        console.log('🔍 Health checks will run every 2 minutes');
        console.log('📈 Full system health checks will run every 30 minutes');
        console.log('🔍 Comprehensive audits will run every 2 hours');
        console.log('🧹 Daily maintenance will run at 2 AM');
        
        // Keep the process running
        process.on('SIGINT', async () => {
            console.log('\n🛑 Received SIGINT, shutting down gracefully...');
            await orchestrator.stopAllEnhancedManagers();
            process.exit(0);
        });
        
        process.on('SIGTERM', async () => {
            console.log('\n🛑 Received SIGTERM, shutting down gracefully...');
            await orchestrator.stopAllEnhancedManagers();
            process.exit(0);
        });
        
        // Log system status every 5 minutes
        setInterval(async () => {
            try {
                const status = await orchestrator.getEnhancedStatus();
                console.log(`📊 System Status: ${status.systemHealth} | Emergency Mode: ${status.emergencyMode} | Uptime: ${Math.floor(status.uptime / 60)}m`);
            } catch (error) {
                console.error('❌ Failed to get system status:', error.message);
            }
        }, 5 * 60 * 1000);
        
    } catch (error) {
        console.error('❌ Failed to start Enhanced Redundancy Automation System:', error);
        process.exit(1);
    }
}

main().catch(error => {
    console.error('❌ Fatal error in Enhanced Redundancy Automation System:', error);
    process.exit(1);
});
EOF
    
    chmod +x "$startup_script"
    
    # Start the system in the background
    print_status $CYAN "🎯 Starting enhanced redundancy orchestrator in background..."
    
    nohup node "$startup_script" > "$LOG_DIR/enhanced-redundancy-startup.log" 2>&1 &
    local pid=$!
    
    # Wait a moment for the system to start
    sleep 3
    
    # Check if the process is running
    if kill -0 $pid 2>/dev/null; then
        print_status $GREEN "✅ Enhanced Redundancy Automation System started successfully (PID: $pid)"
        echo $pid > "$REDUNDANCY_DIR/enhanced-redundancy.pid"
        
        # Show initial status
        print_status $CYAN "📊 Checking initial system status..."
        sleep 2
        
        if [ -f "$LOG_DIR/enhanced-redundancy-startup.log" ]; then
            tail -n 20 "$LOG_DIR/enhanced-redundancy-startup.log" | while read line; do
                if [[ $line == *"✅"* ]]; then
                    print_status $GREEN "$line"
                elif [[ $line == *"❌"* ]]; then
                    print_status $RED "$line"
                elif [[ $line == *"⚠️"* ]]; then
                    print_status $YELLOW "$line"
                else
                    print_status $CYAN "$line"
                fi
            done
        fi
        
    else
        print_status $RED "❌ Failed to start Enhanced Redundancy Automation System"
        exit 1
    fi
}

# Function to show system information
show_system_info() {
    print_status $BLUE "📋 Enhanced Redundancy Automation System Information"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "🎯 Purpose: Comprehensive redundancy coverage for all automation systems"
    echo "🔧 Components: PM2, GitHub Actions, Netlify Functions"
    echo "📁 Project Root: $PROJECT_ROOT"
    echo "📁 Redundancy Dir: $REDUNDANCY_DIR"
    echo "📁 Log Directory: $LOG_DIR"
    echo "🚀 Enhanced Orchestrator: $ENHANCED_ORCHESTRATOR"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
}

# Function to check if system is already running
check_if_running() {
    local pid_file="$REDUNDANCY_DIR/enhanced-redundancy.pid"
    
    if [ -f "$pid_file" ]; then
        local pid=$(cat "$pid_file")
        if kill -0 $pid 2>/dev/null; then
            print_status $YELLOW "⚠️  Enhanced Redundancy Automation System is already running (PID: $pid)"
            read -p "Do you want to restart it? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                print_status $BLUE "🔄 Stopping existing system..."
                kill $pid 2>/dev/null || true
                rm -f "$pid_file"
                sleep 2
            else
                print_status $BLUE "ℹ️  System already running, exiting"
                exit 0
            fi
        else
            print_status $YELLOW "⚠️  Found stale PID file, removing..."
            rm -f "$pid_file"
        fi
    fi
=======
    NODE_VERSION=$(node --version | cut -d'v' -f2)
    REQUIRED_VERSION="20.18.1"
    
    if [ "$(printf '%s\n' "$REQUIRED_VERSION" "$NODE_VERSION" | sort -V | head -n1)" != "$REQUIRED_VERSION" ]; then
        print_status "WARNING" "Node.js version $NODE_VERSION detected. Version $REQUIRED_VERSION or higher is recommended."
    else
        print_status "SUCCESS" "Node.js version $NODE_VERSION is compatible."
    fi
    
    # Check if npm is installed
    if ! command -v npm &> /dev/null; then
        print_status "ERROR" "npm is not installed. Please install npm."
        exit 1
    fi
    
    # Check if PM2 is installed
    if ! command -v pm2 &> /dev/null; then
        print_status "WARNING" "PM2 is not installed. Installing PM2..."
        npm install -g pm2
        if [ $? -eq 0 ]; then
            print_status "SUCCESS" "PM2 installed successfully."
        else
            print_status "ERROR" "Failed to install PM2."
            exit 1
        fi
    else
        print_status "SUCCESS" "PM2 is already installed."
    fi
    
    # Check if required npm packages are installed
    if [ ! -f "$WORKSPACE_DIR/node_modules/node-cron/package.json" ]; then
        print_status "WARNING" "node-cron package not found. Installing dependencies..."
        cd "$WORKSPACE_DIR"
        npm install node-cron
        if [ $? -eq 0 ]; then
            print_status "SUCCESS" "Dependencies installed successfully."
        else
            print_status "ERROR" "Failed to install dependencies."
            exit 1
        fi
    fi
    
    print_status "SUCCESS" "All prerequisites are satisfied."
}

# Function to create necessary directories
create_directories() {
    print_status "INFO" "Creating necessary directories..."
    
    # Create logs directory
    if [ ! -d "$LOG_DIR" ]; then
        mkdir -p "$LOG_DIR"
        print_status "SUCCESS" "Created logs directory: $LOG_DIR"
    else
        print_status "INFO" "Logs directory already exists: $LOG_DIR"
    fi
    
    # Create automation logs directory
    AUTOMATION_LOG_DIR="$WORKSPACE_DIR/automation/logs"
    if [ ! -d "$AUTOMATION_LOG_DIR" ]; then
        mkdir -p "$AUTOMATION_LOG_DIR"
        print_status "SUCCESS" "Created automation logs directory: $AUTOMATION_LOG_DIR"
    fi
    
    print_status "SUCCESS" "All necessary directories are ready."
}

# Function to check if system is already running
check_system_status() {
    print_status "INFO" "Checking system status..."
    
    # Check if orchestrator is already running
    if pgrep -f "enhanced-master-redundancy-orchestrator" > /dev/null; then
        print_status "WARNING" "Enhanced redundancy system appears to be already running."
        read -p "Do you want to continue anyway? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_status "INFO" "Startup cancelled by user."
            exit 0
        fi
    fi
    
    # Check PM2 processes
    if command -v pm2 &> /dev/null; then
        PM2_PROCESSES=$(pm2 list | grep -c "enhanced-backup" || true)
        if [ "$PM2_PROCESSES" -gt 0 ]; then
            print_status "WARNING" "Found $PM2_PROCESSES existing enhanced backup PM2 processes."
            read -p "Do you want to stop them and start fresh? (y/N): " -n 1 -r
            echo
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                print_status "INFO" "Stopping existing PM2 processes..."
                pm2 stop all 2>/dev/null || true
                pm2 delete all 2>/dev/null || true
                print_status "SUCCESS" "Existing PM2 processes stopped."
            fi
        fi
    fi
    
    print_status "SUCCESS" "System status check completed."
}

# Function to start the enhanced redundancy system
start_system() {
    print_status "INFO" "Starting enhanced redundancy system..."
    
    # Change to workspace directory
    cd "$WORKSPACE_DIR"
    
    # Start the enhanced master orchestrator
    if [ -f "$ORCHESTRATOR_SCRIPT" ]; then
        print_status "INFO" "Starting enhanced master redundancy orchestrator..."
        
        # Start the orchestrator in the background
        nohup node "$ORCHESTRATOR_SCRIPT" start > "$LOG_DIR/enhanced-orchestrator-startup.log" 2>&1 &
        ORCHESTRATOR_PID=$!
        
        # Wait a moment for startup
        sleep 5
        
        # Check if orchestrator started successfully
        if kill -0 $ORCHESTRATOR_PID 2>/dev/null; then
            print_status "SUCCESS" "Enhanced master redundancy orchestrator started with PID: $ORCHESTRATOR_PID"
            
            # Save PID to file for later use
            echo $ORCHESTRATOR_PID > "$LOG_DIR/enhanced-orchestrator.pid"
            
            # Wait a bit more for full initialization
            sleep 10
            
            # Check system status
            print_status "INFO" "Checking system status..."
            if node "$ORCHESTRATOR_SCRIPT" status > /dev/null 2>&1; then
                print_status "SUCCESS" "Enhanced redundancy system is running successfully."
                
                # Display status summary
                print_status "INFO" "System status summary:"
                node "$ORCHESTRATOR_SCRIPT" status | jq '.' 2>/dev/null || node "$ORCHESTRATOR_SCRIPT" status
                
            else
                print_status "WARNING" "System status check failed, but orchestrator is running."
            fi
            
        else
            print_status "ERROR" "Failed to start enhanced master redundancy orchestrator."
            exit 1
        fi
        
    else
        print_status "ERROR" "Enhanced master redundancy orchestrator script not found: $ORCHESTRATOR_SCRIPT"
        exit 1
    fi
}

# Function to display startup information
display_startup_info() {
    print_status "INFO" "Enhanced redundancy system startup completed."
    print_status "INFO" "System components:"
    print_status "INFO" "  - Enhanced PM2 Redundancy Manager"
    print_status "INFO" "  - Enhanced GitHub Actions Redundancy Manager"
    print_status "INFO" "  - Enhanced Netlify Functions Redundancy Manager"
    print_status "INFO" "  - Enhanced Master Redundancy Orchestrator"
    
    print_status "INFO" "Log files location: $LOG_DIR"
    print_status "INFO" "Orchestrator PID file: $LOG_DIR/enhanced-orchestrator.pid"
    
    print_status "INFO" "Useful commands:"
    print_status "INFO" "  - Check status: node $ORCHESTRATOR_SCRIPT status"
    print_status "INFO" "  - Generate report: node $ORCHESTRATOR_SCRIPT report"
    print_status "INFO" "  - Stop system: $SCRIPT_DIR/stop-enhanced-redundancy-system.sh"
    
    print_status "SUCCESS" "Enhanced redundancy system is now operational!"
}

# Function to handle startup errors
handle_startup_error() {
    local error_code=$1
    local error_message=$2
    
    print_status "ERROR" "Startup failed: $error_message"
    print_status "ERROR" "Error code: $error_code"
    
    # Cleanup any partially started processes
    if [ -f "$LOG_DIR/enhanced-orchestrator.pid" ]; then
        local pid=$(cat "$LOG_DIR/enhanced-orchestrator.pid")
        if kill -0 $pid 2>/dev/null; then
            print_status "INFO" "Cleaning up orchestrator process (PID: $pid)..."
            kill $pid 2>/dev/null || true
        fi
        rm -f "$LOG_DIR/enhanced-orchestrator.pid"
    fi
    
    # Stop any PM2 processes that might have been started
    if command -v pm2 &> /dev/null; then
        print_status "INFO" "Cleaning up PM2 processes..."
        pm2 stop all 2>/dev/null || true
        pm2 delete all 2>/dev/null || true
    fi
    
    print_status "ERROR" "Startup cleanup completed. Please check logs and try again."
    exit $error_code
>>>>>>> origin/cursor/automate-deployment-redundancy-and-clean-up-e342
}

# Main execution
main() {
<<<<<<< HEAD
    echo ""
    print_status $PURPLE "🚀 Enhanced Redundancy Automation System Startup"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    
    show_system_info
    
    # Check if system is already running
    check_if_running
    
    # Check prerequisites
    check_prerequisites
    
    # Install dependencies
    install_dependencies
    
    # Start the enhanced system
    start_enhanced_system
    
    echo ""
    print_status $GREEN "🎉 Enhanced Redundancy Automation System startup completed!"
    echo ""
    print_status $CYAN "📊 To monitor the system:"
    echo "   • View logs: tail -f $LOG_DIR/enhanced-redundancy-startup.log"
    echo "   • Check status: pm2 status"
    echo "   • View backup workflows: ls -la .github/workflows/backup/"
    echo "   • View backup functions: ls -la netlify/functions/backup/"
    echo ""
    print_status $CYAN "🛑 To stop the system:"
    echo "   • Run: $REDUNDANCY_DIR/stop-enhanced-redundancy-system.sh"
    echo "   • Or manually: kill \$(cat $REDUNDANCY_DIR/enhanced-redundancy.pid)"
    echo ""
}

# Run main function
main "$@"
=======
    print_status "INFO" "Starting Enhanced Redundancy System..."
    print_status "INFO" "Script directory: $SCRIPT_DIR"
    print_status "INFO" "Workspace directory: $WORKSPACE_DIR"
    print_status "INFO" "Log directory: $LOG_DIR"
    
    # Set up error handling
    trap 'handle_startup_error $? "Unexpected error occurred"' ERR
    
    # Execute startup steps
    check_prerequisites
    create_directories
    check_system_status
    start_system
    display_startup_info
    
    print_status "SUCCESS" "Enhanced redundancy system startup completed successfully!"
}

# Check if script is being sourced or executed
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    # Script is being executed
    main "$@"
else
    # Script is being sourced
    print_status "INFO" "Enhanced redundancy startup script sourced. Use main function to start the system."
fi
>>>>>>> origin/cursor/automate-deployment-redundancy-and-clean-up-e342
