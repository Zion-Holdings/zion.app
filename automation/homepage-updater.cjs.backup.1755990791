#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

<<<<<<< HEAD
const REPO_ROOT = path.join(__dirname, '..');
const PAGES_DIR = path.join(REPO_ROOT, 'pages');
const HOME_PATH = path.join(PAGES_DIR, 'index.tsx');
=======
const PROJECT_ROOT = process.cwd();
const PAGES_DIR = path.join(PROJECT_ROOT, 'pages');
const HOME_PAGE = path.join(PAGES_DIR, 'index.tsx');
>>>>>>> origin/cursor/autonomous-cloud-page-enhancer-and-advertiser-c4d6

const START_MARK = '{/* AUTO-GENERATED: HOME_UPDATER_START */}';
const END_MARK = '{/* AUTO-GENERATED: HOME_UPDATER_END */}';

<<<<<<< HEAD
/**
 * Discover top-level pages and key sections to promote.
 * Only include routes that actually exist to avoid broken links.
 */
function discoverPromotions() {
  /** Map of route -> { title, tagline } */
  const candidates = new Map([
    ['/automation', { title: 'Automation Status', tagline: 'live agents & reports' }],
    ['/newsroom', { title: 'Newsroom', tagline: 'latest autonomous updates' }],
    ['/site-health', { title: 'Site Health', tagline: 'audits & insights' }],
  ]);

  // Validate existence of each route
  const existing = [];
  for (const [route, meta] of candidates.entries()) {
    const parts = route.split('/').filter(Boolean);
    let exists = false;
    if (parts.length === 1) {
      const name = parts[0];
      // pages/name.(tsx|jsx|js|mdx)
      exists = ['tsx', 'jsx', 'js', 'mdx', 'ts', 'md'].some((ext) =>
        fs.existsSync(path.join(PAGES_DIR, `${name}.${ext}`))
      );
      // pages/name/index.(tsx|...)
      exists = exists || ['tsx', 'jsx', 'js', 'mdx', 'ts', 'md'].some((ext) =>
        fs.existsSync(path.join(PAGES_DIR, name, `index.${ext}`))
      );
    } else {
      // nested route, e.g. /automation/index.tsx
      const fileBase = path.join(PAGES_DIR, ...parts);
      exists = ['tsx', 'jsx', 'js', 'mdx', 'ts', 'md'].some((ext) =>
        fs.existsSync(`${fileBase}.${ext}`)
      );
      exists = exists || ['tsx', 'jsx', 'js', 'mdx', 'ts', 'md'].some((ext) =>
        fs.existsSync(path.join(fileBase, `index.${ext}`))
      );
    }
    if (exists) existing.push({ route, ...meta });
  }

  // Sort by preferred order
  const order = ['/automation', '/newsroom', '/site-health'];
  existing.sort((a, b) => order.indexOf(a.route) - order.indexOf(b.route));

  return existing;
}

function buildCardsTsx(items) {
  // Build card grid using Next Link with nested <a> for Next.js v11 compatibility
  const cards = items
    .map((it) => {
      const label = `${it.title} — ${it.tagline}`;
      return (
        `            <Link href="${it.route}"><a className="bg-white/5 hover:bg-white/10 rounded-lg p-4 transition-colors border border-white/10"><span className="text-white/90">${label}</span></a></Link>`
      );
    })
    .join('\n\n');

  return [
    '<section className="mx-auto max-w-7xl px-6 pb-16">',
    '  <h2 className="text-center text-2xl font-bold tracking-wide text-white/90">Explore more</h2>',
    '  <div className="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">',
    '',
    cards,
    '  ',
    '  </div>',
    '</section>'
  ].join('\n');
}

function replaceBetweenMarkers(source, replacementBlock) {
  const startIdx = source.indexOf(START_MARK);
  const endIdx = source.indexOf(END_MARK);
  if (startIdx === -1 || endIdx === -1 || endIdx <= startIdx) {
    throw new Error('Auto-generation markers not found or malformed in pages/index.tsx');
  }

  // Find the next newline after the start marker and the previous newline before the end marker
  const afterStart = source.indexOf('\n', startIdx) + 1;
  const beforeEnd = source.lastIndexOf('\n', endIdx);

  const newContent =
    source.slice(0, afterStart) +
    replacementBlock +
    '\n' +
    source.slice(beforeEnd);

  return newContent;
}

function main() {
  if (!fs.existsSync(HOME_PATH)) {
    console.error('Homepage not found at', HOME_PATH);
    process.exit(1);
  }

  const homepage = fs.readFileSync(HOME_PATH, 'utf8');
  const items = discoverPromotions();

  if (items.length === 0) {
    console.log('No promotional items discovered. Skipping edit.');
    process.exit(0);
  }

  const replacement = buildCardsTsx(items);
  const updated = replaceBetweenMarkers(homepage, replacement);

  if (updated === homepage) {
    console.log('Homepage auto-generated block already up to date.');
    process.exit(0);
  }

  fs.writeFileSync(HOME_PATH, updated, 'utf8');
  console.log('Homepage auto-generated promotional section updated successfully.');
}

try {
  main();
} catch (err) {
  console.error('Failed to update homepage:', err && err.message ? err.message : err);
  process.exit(1);
}
=======
function fileExists(p) { try { return fs.existsSync(p); } catch { return false; } }
function readFile(p) { return fs.readFileSync(p, 'utf8'); }
function writeFile(p, c) { fs.writeFileSync(p, c, 'utf8'); }

function discoverInternalPages() {
  const links = [];
  // Top-level pages
  const topFiles = fs.readdirSync(PAGES_DIR, { withFileTypes: true });
  for (const entry of topFiles) {
    if (entry.isFile()) {
      if (!/\.tsx?$/.test(entry.name)) continue;
      const base = entry.name.replace(/\.(tsx|ts|jsx|js)$/i, '');
      if (base === 'index' || base.startsWith('_')) continue;
      links.push({ href: `/${base}`, label: toTitle(base) });
    } else if (entry.isDirectory()) {
      // directory with index.tsx
      const idx = path.join(PAGES_DIR, entry.name, 'index.tsx');
      if (fileExists(idx)) {
        links.push({ href: `/${entry.name}`, label: toTitle(entry.name) });
      }
    }
  }
  // Sort for stable output
  links.sort((a, b) => a.href.localeCompare(b.href));
  return links;
}

function toTitle(slug) {
  return slug
    .replace(/[-_]+/g, ' ')
    .replace(/\b\w/g, (m) => m.toUpperCase());
}

function curatedCards(existing) {
  const byHref = new Set(existing.map(x => x.href));
  const cards = [];
  // Always include Automation Hub if exists
  if (byHref.has('/automation')) {
    cards.push({ href: '/automation', text: 'Automation Hub — live agents & reports' });
  }
  if (byHref.has('/newsroom')) {
    cards.push({ href: '/newsroom', text: 'Newsroom — latest autonomous updates' });
  }
  if (byHref.has('/site-health')) {
    cards.push({ href: '/site-health', text: 'Site Health — audits & insights' });
  }
  // Add any other discovered pages (up to 5)
  for (const p of existing) {
    if (['/automation','/newsroom','/site-health'].includes(p.href)) continue;
    if (cards.length >= 7) break;
    cards.push({ href: p.href, text: `${p.label} — explore` });
  }
  return cards;
}

function renderBlock(cards) {
  const lines = [];
  lines.push('<section className="mx-auto max-w-7xl px-6 pb-16">');
  lines.push('  <h2 className="text-center text-2xl font-bold tracking-wide text-white/90">Explore more</h2>');
  lines.push('  <div className="mt-6 grid grid-cols-1 gap-4 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4">');
  lines.push('');
  for (const c of cards) {
    lines.push(`            <Link href="${c.href}"><a className="bg-white/5 hover:bg-white/10 rounded-lg p-4 transition-colors border border-white/10"><span className="text-white/90">${escapeHtml(c.text)}</span></a></Link>`);
    lines.push('  ');
    lines.push('');
  }
  lines.push('  </div>');
  lines.push('</section>');
  return lines.join('\n');
}

function escapeHtml(s) {
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function replaceBetween(source, startMark, endMark, replacement) {
  const startIdx = source.indexOf(startMark);
  const endIdx = source.indexOf(endMark);
  if (startIdx === -1 || endIdx === -1 || endIdx <= startIdx) {
    throw new Error('Marker block not found in pages/index.tsx');
  }
  const before = source.slice(0, startIdx + startMark.length);
  const after = source.slice(endIdx);
  // ensure newline formatting similar to existing file
  const content = '\n' + replacement + '\n';
  return before + '\n' + content + after;
}

function main() {
  if (!fileExists(HOME_PAGE)) {
    console.error('Homepage not found at', HOME_PAGE);
    process.exit(0);
  }
  const src = readFile(HOME_PAGE);
  const pages = discoverInternalPages();
  const cards = curatedCards(pages);
  const block = renderBlock(cards);
  const updated = replaceBetween(src, START_MARK, END_MARK, block);
  if (updated !== src) {
    writeFile(HOME_PAGE, updated);
    console.log(`Homepage auto-generated block updated with ${cards.length} card(s).`);
  } else {
    console.log('Homepage auto-generated block already up-to-date.');
  }
}

main();
>>>>>>> origin/cursor/autonomous-cloud-page-enhancer-and-advertiser-c4d6
