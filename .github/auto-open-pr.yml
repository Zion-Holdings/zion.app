name: Auto Open PR

on:
  push:
    branches:
      - 'cursor/**'
  workflow_dispatch:

jobs:
  open-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create PR if missing
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = process.env.GITHUB_REF_NAME;
            const [owner, repo] = process.env.GITHUB_REPOSITORY.split('/');

            // Check for existing open PR from this branch
            const prs = await github.rest.pulls.list({ owner, repo, state: 'open', head: `${owner}:${branch}` });
            if (prs.data && prs.data.length > 0) {
              core.info(`PR already exists: #${prs.data[0].number}`);
              return;
            }

            const title = `feat(autonomy): ${branch} â†’ main`;
            const body = [
              'Automated PR to merge autonomous cloud automation updates into main.',
              '',
              '- Adds new Netlify scheduled functions (a11y, internal anchors, SEO schema, orphan pages)',
              '- Adds rapid git sync function',
              '- Advertises these tools on the homepage',
            ].join('\n');

            const created = await github.rest.pulls.create({
              owner,
              repo,
              base: 'main',
              head: branch,
              title,
              body,
              maintainer_can_modify: true,
              draft: false,
            });
            core.info(`Opened PR #${created.data.number}`);