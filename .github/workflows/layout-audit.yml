name: layout-audit

on:
  pull_request:
    paths:
      - 'pages/**'
      - 'components/**'
      - 'styles/**'
      - 'automation/layout-*.cjs'
  workflow_dispatch: {}
  schedule:
    - cron: '0 4 * * *'

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install deps
        run: npm ci
      - name: Build
        run: npm run build
      - name: Install Playwright Browsers
        run: npx --yes playwright install chromium
      - name: Start Next server
        run: npm run start &
      - name: Crawl & Audit
        run: node automation/layout-crawler.cjs
        env:
          BASE_URL: http://localhost:3000
      - name: Suggest Fixes
        run: node automation/layout-fixer.cjs
      - name: Generate Agent Proposals
        run: node automation/agent-factory-suggester.cjs
      - name: Upload Layout Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: layout-audit-report
          path: |
            data/reports/layout-audit
            data/reports/agent-suggestions
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            Layout audit completed. Artifacts uploaded as 'layout-audit-report'.
            If issues were detected, see suggestions in data/reports/agent-suggestions.