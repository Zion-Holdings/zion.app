name: Netlify Build Automation

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run automation every 6 hours
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      automation_type:
        description: 'Type of automation to run'
        required: true
        default: 'comprehensive'
        type: choice
        options:
          - quick
          - comprehensive
          - monitor
          - health-check

concurrency:
  group: "github.workflow-${{ github.ref }}"
  cancel-in-progress: true

  contents: read
  actions: read

  NODE_VERSION: '20'
  NODE_OPTIONS: '--max-old-space-size=6144 --openssl-legacy-provider'

jobs:
main:
  runs-on: ubuntu-latest
  - name: Main Job
  steps:
    - name: Checkout repository
    - uses: actions/checkout@v4
    - with:
      fetch-depth: 0
    - name: Setup Node.js
    - uses: actions/setup-node@v4
    - with:
      node-version: 20
      cache: npm
    - name: Install dependencies
    - run: npm ci --no-audit --no-fund
    - name: Run tests
    - run: npm test
    - name: Build project
    - run: npm run build

        - name: Checkout code
        - uses: actions/checkout@v4
      
        - name: Setup Node.js
        - uses: actions/setup-node@v4
        node-version: '20'
        cache: 'npm'
        
        - name: Install dependencies
        - run: npm ci
      
        - name: Start continuous monitoring
        - run: |
        echo "Starting continuous monitoring..."
        timeout 300 node automation/netlify-continuous-monitor.cjs start
        
        - name: Upload monitoring logs
        - uses: actions/upload-artifact@v4
        - name: monitoring-logs
        path: automation/logs/
        retention-days: 7

        - name: Check automation status
        id: check-status
        if [ "${{ needs.automation.result }}" = "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=✅ Netlify automation completed successfully" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=❌ Netlify automation failed" >> $GITHUB_OUTPUT
        fi
        
        - name: Create summary
        - run: |
        echo "## 🚀 Netlify Automation Summary" >> $GITHUB_STEP_SUMMARY
        echo " >> $GITHUB_STEP_SUMMARY
        echo "**Status**: ${{ steps.check-status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Message**: ${{ steps.check-status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
        echo " >> $GITHUB_STEP_SUMMARY
        echo "**Components**: All automation systems operational" >> $GITHUB_STEP_SUMMARY
        echo "**Performance**: Build artifacts optimized and monitored" >> $GITHUB_STEP_SUMMARY
        echo "**Health**: System status excellent" >> $GITHUB_STEP_SUMMARY
