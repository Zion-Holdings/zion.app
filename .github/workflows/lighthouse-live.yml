name: Lighthouse Live

on:
  schedule:
    - cron: '23 */6 * * *'
    - cron: '20 2 * * *'
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: lighthouse-live-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Lighthouse on production URLs (non-blocking on schedule)
        if: ${{ github.event_name == 'schedule' }}
        uses: treosh/lighthouse-ci-action@v11
        continue-on-error: true
        with:
          urls: |
            https://ziontechgroup.com/
            https://ziontechgroup.com/explore
            https://ziontechgroup.com/front
            https://ziontechgroup.com/newsroom
            https://ziontechgroup.com/reports
            https://ziontechgroup.com/site-health
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3
          configPath: lighthouserc.json

      - name: Run Lighthouse on production URLs (strict)
        if: ${{ github.event_name != 'schedule' }}
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            https://ziontechgroup.com/
            https://ziontechgroup.com/explore
            https://ziontechgroup.com/front
            https://ziontechgroup.com/newsroom
            https://ziontechgroup.com/reports
            https://ziontechgroup.com/site-health
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3
          configPath: lighthouserc.json

  lhci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Lighthouse CI
        run: npm i -g @lhci/cli@0.12.x
      - name: Run against production
        run: |
          lhci autorun --collect.url=https://ziontechgroup.com --upload.target=temporary-public-storage || echo "LHCI finished with non-zero (report only)"
