name: Lighthouse Live

on:
  schedule:
    - cron: '23 */6 * * *'
    - cron: '20 2 * * *'
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: lighthouse-live-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Lighthouse on production URLs
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            https://ziontechgroup.com/
            https://ziontechgroup.com/explore
            https://ziontechgroup.com/front
            https://ziontechgroup.com/newsroom
            https://ziontechgroup.com/reports
            https://ziontechgroup.com/site-health
          uploadArtifacts: true
          temporaryPublicStorage: true
          runs: 3
          configPath: ''
          # Assert reasonable budgets; non-blocking on schedule, blocking on PR
          assert: |
            preset: lighthouse:recommended
            assertions:
              categories:performance: [error, {minScore: 0.90}]
              categories:accessibility: [error, {minScore: 0.95}]
              categories:seo: [error, {minScore: 0.95}]
              categories:best-practices: [error, {minScore: 0.95}]
              uses-responsive-images: [warn, {maxLength: 0}]

  lhci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Lighthouse CI
        run: npm i -g @lhci/cli@0.12.x
      - name: Run against production
        env:
          LHCI_TOKEN: ${{ secrets.LHCI_TOKEN }}
        run: |
          lhci autorun --collect.url=https://ziontechgroup.com --upload.target=temporary-public-storage || echo "LHCI finished with non-zero (report only)"
