name: Security Gates & Compliance

on:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main"]
  workflow_dispatch: {}
  schedule:
    # Run security checks daily at 2 AM UTC
    - cron: '0 2 * * *'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  security-scan:
    name: Security & Compliance Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      matrix:
        node-version: ['20.18.1']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Generate SBOM
        run: |
          echo "ğŸ” Generating Software Bill of Materials..."
          node automation/helpers/security-manager.js sbom
        env:
          NODE_ENV: production

      - name: Check License Compliance
        run: |
          echo "ğŸ“‹ Checking license compliance..."
          node automation/helpers/security-manager.js compliance
        env:
          NODE_ENV: production

      - name: Audit Content Security Policy
        run: |
          echo "ğŸ›¡ï¸ Auditing Content Security Policy..."
          node automation/helpers/security-manager.js csp
        env:
          NODE_ENV: production

      - name: Run Security Manager
        run: |
          echo "ğŸ” Running comprehensive security scan..."
          node -e "
            const SecurityManager = require('./automation/helpers/security-manager.js');
            const security = new SecurityManager();
            security.generateSecurityReport().then(result => {
              if (result.success) {
                console.log('âœ… Security report generated:', result.reportFile);
                process.exit(0);
              } else {
                console.error('âŒ Security scan failed:', result.reason);
                process.exit(1);
              }
            }).catch(error => {
              console.error('âŒ Security scan error:', error.message);
              process.exit(1);
            });
          "
        env:
          NODE_ENV: production

      - name: Upload security artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports-${{ github.run_number }}
          path: |
            automation/security/
            public/reports/automation/
          retention-days: 30

  dependency-scan:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Run npm audit
        run: npm audit --audit-level=moderate

      - name: Check for known vulnerabilities
        run: |
          echo "ğŸ” Checking for known vulnerabilities..."
          npm audit --json > audit-report.json || true
          
          # Check if there are high or critical vulnerabilities
          if node -e "
            const audit = require('./audit-report.json');
            const highVulns = audit.metadata.vulnerabilities.high || 0;
            const criticalVulns = audit.metadata.vulnerabilities.critical || 0;
            
            if (highVulns > 0 || criticalVulns > 0) {
              console.error(\`âŒ Found \${highVulns} high and \${criticalVulns} critical vulnerabilities\`);
              process.exit(1);
            } else {
              console.log('âœ… No high or critical vulnerabilities found');
              process.exit(0);
            }
          "; then
            echo "âœ… Security check passed"
          else
            echo "âŒ Security check failed - vulnerabilities found"
            exit 1
          fi

      - name: Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: audit-report-${{ github.run_number }}
          path: audit-report.json
          retention-days: 30

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Check license compliance
        run: |
          echo "ğŸ“‹ Checking license compliance..."
          node -e "
            const SecurityManager = require('./automation/helpers/security-manager.js');
            const security = new SecurityManager();
            
            security.checkLicenseCompliance().then(result => {
              if (result.success) {
                const compliance = result.complianceReport;
                console.log(\`ğŸ“Š License Compliance Summary:\`);
                console.log(\`   Total Dependencies: \${compliance.totalDependencies}\`);
                console.log(\`   Allowed: \${compliance.summary.allowed}\`);
                console.log(\`   Restricted: \${compliance.summary.restricted}\`);
                console.log(\`   Forbidden: \${compliance.summary.forbidden}\`);
                
                if (compliance.summary.forbidden > 0) {
                  console.error('âŒ Forbidden licenses found - compliance check failed');
                  process.exit(1);
                } else if (compliance.summary.restricted > 0) {
                  console.warn('âš ï¸ Restricted licenses found - review required');
                  process.exit(0);
                } else {
                  console.log('âœ… License compliance check passed');
                  process.exit(0);
                }
              } else {
                console.error('âŒ License compliance check failed:', result.reason);
                process.exit(1);
              }
            }).catch(error => {
              console.error('âŒ License compliance check error:', error.message);
              process.exit(1);
            });
          "

  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-scan, license-compliance]
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security Gate Check
        run: |
          echo "ğŸšª Running security gate check..."
          
          # Check if all previous jobs succeeded
          if [[ "${{ needs.security-scan.result }}" == "success" && 
                "${{ needs.dependency-scan.result }}" == "success" && 
                "${{ needs.license-compliance.result }}" == "success" ]]; then
            echo "âœ… All security checks passed - gate is open"
            echo "ğŸš€ Proceeding with deployment..."
          else
            echo "âŒ Security gate is closed - some checks failed"
            echo "ğŸ”’ Deployment blocked until security issues are resolved"
            exit 1
          fi

      - name: Security Summary
        run: |
          echo "ğŸ“Š Security Gate Summary:"
          echo "   Security Scan: ${{ needs.security-scan.result }}"
          echo "   Dependency Scan: ${{ needs.dependency-scan.result }}"
          echo "   License Compliance: ${{ needs.license-compliance.result }}"
          echo ""
          echo "ğŸ¯ Overall Status: ${{ needs.security-gate.result }}"

  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [security-scan, dependency-scan, license-compliance]
    if: always()
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Generate comprehensive security report
        run: |
          echo "ğŸ“‹ Generating comprehensive security report..."
          node -e "
            const SecurityManager = require('./automation/helpers/security-manager.js');
            const security = new SecurityManager();
            
            security.generateSecurityReport().then(result => {
              if (result.success) {
                console.log('âœ… Security report generated:', result.reportFile);
                
                // Also generate a summary for GitHub
                const report = result.report;
                console.log('\\nğŸ“Š Security Report Summary:');
                console.log('   SBOM Generated:', report.summary.sbomGenerated ? 'âœ…' : 'âŒ');
                console.log('   License Compliant:', report.summary.licenseCompliant ? 'âœ…' : 'âŒ');
                console.log('   CSP Score:', report.summary.cspScore + '/100');
                console.log('   Recommendations:', report.summary.recommendations.length);
                
                process.exit(0);
              } else {
                console.error('âŒ Security report generation failed:', result.reason);
                process.exit(1);
              }
            }).catch(error => {
              console.error('âŒ Security report generation error:', error.message);
              process.exit(1);
            });
          "

      - name: Upload security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-report-${{ github.run_number }}
          path: |
            automation/security/
            public/reports/automation/
          retention-days: 90

  notify-security-issues:
    name: Notify Security Issues
    runs-on: ubuntu-latest
    needs: [security-gate]
    if: failure()
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security Issue Notification
        run: |
          echo "ğŸš¨ Security issues detected in the pipeline!"
          echo "ğŸ”’ Deployment has been blocked"
          echo ""
          echo "ğŸ“‹ Failed Security Checks:"
          echo "   Security Scan: ${{ needs.security-scan.result }}"
          echo "   Dependency Scan: ${{ needs.dependency-scan.result }}"
          echo "   License Compliance: ${{ needs.license-compliance.result }}"
          echo ""
          echo "ğŸ” Please review the security artifacts and resolve issues before retrying"
          echo "ğŸ“ Check the uploaded artifacts for detailed reports"

      - name: Create security issue
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Security Gate Failed - PR #${context.payload.pull_request.number}`,
              body: `## Security Gate Failure
            
            The security gate has blocked this pull request due to security issues.
            
            ### Failed Checks:
            - **Security Scan**: ${{ needs.security-scan.result }}
            - **Dependency Scan**: ${{ needs.dependency-scan.result }}
            - **License Compliance**: ${{ needs.license-compliance.result }}
            
            ### Required Actions:
            1. Review the security artifacts uploaded in this workflow run
            2. Resolve all security issues
            3. Re-run the security checks
            4. Ensure all checks pass before merging
            
            ### Security Artifacts:
            - Security Reports: [Download](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - SBOM and Compliance Data: Check the uploaded artifacts
            
            ---
            *This issue was automatically created by the Security Gate workflow*
            `,
              labels: ['security', 'blocked', 'automation'],
              assignees: ['${{ github.repository_owner }}']
            });
            
            console.log(`Created security issue: ${issue.html_url}`);

  security-success:
    name: Security Success
    runs-on: ubuntu-latest
    needs: [security-gate]
    if: success()
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Security Success Notification
        run: |
          echo "âœ… All security checks passed successfully!"
          echo "ğŸšª Security gate is open"
          echo "ğŸš€ Deployment can proceed"
          echo ""
          echo "ğŸ“Š Security Summary:"
          echo "   SBOM: Generated âœ…"
          echo "   Dependencies: Scanned âœ…"
          echo "   Licenses: Compliant âœ…"
          echo "   CSP: Audited âœ…"
          echo ""
          echo "ğŸ¯ Security posture: EXCELLENT"

      - name: Comment on PR
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: `## âœ… Security Gate Passed!
            
            All security checks have passed successfully. This PR is ready for deployment.
            
            ### Security Status:
            - **SBOM Generation**: âœ… Complete
            - **Dependency Scan**: âœ… Clean
            - **License Compliance**: âœ… Verified
            - **Content Security Policy**: âœ… Audited
            
            ğŸš€ **Security Gate: OPEN** - Deployment can proceed
            
            ---
            *Security check completed at ${{ github.event.head_commit.timestamp }}*
            `
            });
