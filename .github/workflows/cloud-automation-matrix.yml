name: Cloud Automations Matrix

on:
  schedule:
    - cron: '15 * * * *' # hourly stagger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  matrix:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        group: [ lint, syntax, design, content, git ]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run group ${{ matrix.group }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CLOUD_TASKS: ${{
            matrix.group == 'lint' && 'type-check lint linting:check linting:fix' ||
            matrix.group == 'syntax' && 'syntax:build-check syntax:continuous' ||
            matrix.group == 'design' && 'design:status design:analyze ui-evolution:analyze ui-evolution:beautify' ||
            matrix.group == 'content' && 'sitemap responsive:analyze variation:analyze frontend-sync:analyze' ||
            matrix.group == 'git' && 'automation:git-sync git:sync' || ''
          }}
        run: |
          chmod +x scripts/run-cloud-automations.sh
          ./scripts/run-cloud-automations.sh || true

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: automation-logs-${{ matrix.group }}
          path: automation_logs/cloud

      - name: Configure git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Commit and push changes (if any)
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            git commit -m "chore(automation): matrix cloud automation outputs [skip ci]"
            git push
          fi