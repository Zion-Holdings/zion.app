name: Security
true:
  push:
    branches:
    - main
    - develop
  pull_request:
    branches:
    - main
    - develop
  workflow_dispatch: {}
  schedule:
  - cron: 0 6 * * *
permissions:
  contents: read
  actions: read
  security-events: write
concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true
jobs:
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: npm
    - name: Install dependencies
      run: npm ci --no-audit --no-fund
    - name: Run npm audit
      run: npm audit --audit-level=high --json > npm-audit.json
      continue-on-error: true
    - name: Run security scanner
      run: npm run security:scan
      continue-on-error: true
    - name: Check for secrets in code
      uses: trufflesecurity/trufflehog@main
      with:
        path: .
        base: ${{ github.event.before }}
        head: ${{ github.event.after }}
        extra_args: --only-verified
      continue-on-error: true
    - name: Run Snyk security scan
      uses: snyk/actions/node@master
      env:
        SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      with:
        args: --severity-threshold=high
      continue-on-error: true
    - name: Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: 'npm-audit.json

          security-scan-results.json

          snyk-report.json

          '
        retention-days: 30
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: npm
    - name: Check for outdated dependencies
      run: npm outdated --json > outdated-deps.json || echo "All packages are up to
        date" > outdated-deps.json
    - name: Check for vulnerable dependencies
      run: npm audit --json > audit-report.json || echo "No vulnerabilities found"
        > audit-report.json
    - name: Check for known vulnerabilities
      run: 'echo "Checking for known vulnerabilities in dependencies..."

        npx audit-ci --moderate --report --format json > audit-ci-report.json || echo
        "Audit CI completed" > audit-ci-report.json

        '
    - name: Upload dependency reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: 'outdated-deps.json

          audit-report.json

          audit-ci-report.json

          '
        retention-days: 30
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
    - security-audit
    - dependency-check
    if: always()
    timeout-minutes: 5
    steps:
    - name: Generate security summary
      run: "echo \"## \U0001F512 Security Scan Summary\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\necho \"### Status:\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"- Security Audit: ${{ needs.security-audit.result }}\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"- Dependency Check: ${{ needs.dependency-check.result }}\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"\" >> $GITHUB_STEP_SUMMARY\n\nif [ \"${{ needs.security-audit.result\
        \ }}\" == \"success\" ]; then\n  echo \"\u2705 Security audit completed successfully\"\
        \ >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u26A0\uFE0F Security audit completed\
        \ with warnings\" >> $GITHUB_STEP_SUMMARY\nfi\n\nif [ \"${{ needs.dependency-check.result\
        \ }}\" == \"success\" ]; then\n  echo \"\u2705 Dependency check completed\
        \ successfully\" >> $GITHUB_STEP_SUMMARY\nelse\n  echo \"\u26A0\uFE0F Dependency\
        \ check completed with warnings\" >> $GITHUB_STEP_SUMMARY\nfi\n\necho \"\"\
        \ >> $GITHUB_STEP_SUMMARY\necho \"### Next Steps:\" >> $GITHUB_STEP_SUMMARY\n\
        echo \"1. Review security reports\" >> $GITHUB_STEP_SUMMARY\necho \"2. Address\
        \ high-severity vulnerabilities\" >> $GITHUB_STEP_SUMMARY\necho \"3. Update\
        \ outdated dependencies\" >> $GITHUB_STEP_SUMMARY\necho \"4. Monitor for new\
        \ security issues\" >> $GITHUB_STEP_SUMMARY\n"
