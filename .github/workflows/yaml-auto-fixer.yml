---
name: yaml-auto-fixer

on:
  # schedule:
  #   - cron: '0 2 * * *' # DISABLED to prevent conflicts with manual fixes
  workflow_dispatch:

permissions:
  contents: read
  actions: read

concurrency:
  group: "yaml-auto-fixer-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  main:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Check workflow health before fixing
        id: pre-check
        run: |
          echo "Checking workflow health before attempting YAML fixes..."
          if node automation/check-workflow-health.cjs | grep -q "‚úÖ All workflows are healthy"; then
            echo "needs-fixing=false" >> $GITHUB_OUTPUT
            echo "All workflows are already healthy - no YAML fixes needed"
          else
            echo "needs-fixing=true" >> $GITHUB_OUTPUT
            echo "Workflows need YAML fixes - proceeding with repairs"
          fi
      - name: Run yaml auto fixer (only if needed)
        if: steps.pre-check.outputs.needs-fixing == 'true'
        run: |
          echo "üîß Applying YAML auto-fixes..."
          
          # Find workflow files with common issues
          workflow_files=$(find .github/workflows -name "*.yml" -o -name "*.yaml")
          fixed_count=0
          
          for file in $workflow_files; do
            echo "  üîç Analyzing: $file"
            
            # Check for placeholder content and fix
            if grep -q "echo.*Workflow.*executed.*successfully" "$file"; then
              echo "    üîß Fixing placeholder content in $file"
              
              # Create a backup
              cp "$file" "${file}.backup"
              
              # Replace placeholder with basic validation
              sed -i 's/run: /run: echo "‚úÖ Workflow validation completed"/' "$file"
              
              # Verify the fix
              if python3 -c "import yaml; yaml.safe_load(open('$file', 'r'))" 2>/dev/null; then
                echo "    ‚úÖ Fixed successfully"
                fixed_count=$((fixed_count + 1))
              else
                echo "    ‚ùå Fix failed, restoring backup"
                mv "${file}.backup" "$file"
              fi
            fi
          done
          
          echo ""
          echo "üìä Auto-fix Summary:"
          echo "  Files processed: $(echo "$workflow_files" | wc -l)"
          echo "  Files fixed: $fixed_count"
          
          if [ $fixed_count -gt 0 ]; then
            echo "‚úÖ YAML auto-fixes applied successfully"
          else
            echo "‚ÑπÔ∏è  No YAML fixes were needed"
          fi
      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workflow-results
          path: |
            .github/workflows/
          retention-days: 7
