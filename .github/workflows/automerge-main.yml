name: Auto-merge to main
true:
  pull_request:
    types:
    - labeled
    - opened
    - synchronize
    - reopened
    branches:
    - main
permissions:
  contents: write
  pull-requests: write
jobs:
  automerge:
    if: contains(github.event.pull_request.labels.*.name, 'automerge')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Ensure no conflicts with base
      run: "git fetch origin ${{ github.base_ref }}\ngit merge --no-commit --no-ff\
        \ --no-edit origin/${{ github.base_ref }} || {\n  echo \"Conflicts exist.\
        \ Aborting automerge.\";\n  exit 1;\n}\ngit merge --abort || true\n"
    - name: Enable auto-merge
      uses: peter-evans/enable-pull-request-automerge@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        pull-request-number: ${{ github.event.pull_request.number }}
        merge-method: squash
    timeout-minutes: 30
concurrency:
  group: automerge-main.yml-${{ github.ref }}
  cancel-in-progress: true
