name: Netlify Monitor

on:
  push:
    branches: [ main ]
  pull_request:
    types: [opened, synchronize, reopened]
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  monitor-and-fix:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'npm'
      - name: Install dependencies
        run: npm ci
      - name: Netlify status check
        id: netlify_check
        continue-on-error: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: node automation/netlify-monitor.cjs check
      - name: Run fixers (on failure)
        if: steps.netlify_check.outcome == 'failure'
        run: |
          npm run fix:all || true
          npm run type-check || true
          npm run build || true
      - name: Create Pull Request (on failure)
        id: cpr
        if: steps.netlify_check.outcome == 'failure'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(netlify): automated attempt to remediate Netlify build issues"
          title: "fix(netlify): attempt automated remediation"
          body: |
            The Netlify monitor detected a failing deploy. This PR applies automated fixes.

            - ESLint --fix
            - TypeScript/common error corrections
            - Build validations (best-effort)
          branch: automation/netlify-fix
          delete-branch: true
          signoff: false
          labels: |
            automation
            netlify
            auto-merge
      - name: Enable Auto-merge
        if: steps.netlify_check.outcome == 'failure' && steps.cpr.outputs.pull-request-number
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
      - name: Trigger Netlify rebuild (on failure)
        if: steps.netlify_check.outcome == 'failure'
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${NETLIFY_AUTH_TOKEN}" \
            "https://api.netlify.com/api/v1/sites/${NETLIFY_SITE_ID}/builds" | cat