---
name: Workflow Manager

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'status'
        type: choice
        options:
          - status
          - health-check
          - cleanup
          - optimize
  schedule:
    - cron: '0 1 * * *' # Daily at 1 AM UTC

permissions:
  contents: read
  actions: read

concurrency:
  group: "workflow-manager"
  cancel-in-progress: false

jobs:
  manage-workflows:
    name: Workflow Management
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Analyze workflow status
        id: workflow-analysis
        run: |
          echo "Analyzing workflow status..."
          
          # Count total workflows
          WORKFLOW_COUNT=$(find .github/workflows -name "*.yml" | wc -l)
          echo "Total workflows: $WORKFLOW_COUNT"
          
          # List all workflows
          echo "## Available Workflows" > workflow-status.md
          echo "Generated: $(date)" >> workflow-status.md
          echo "" >> workflow-status.md
          
          echo "### Core Workflows" >> workflow-status.md
          echo "- CI (ci.yml) - Main test suite" >> workflow-status.md
          echo "- Test Runner (test.yml) - Code quality checks" >> workflow-status.md
          echo "- Playwright Smoke Tests (playwright-smoke.yml) - Critical functionality tests" >> workflow-status.md
          echo "- Deploy (deploy.yml) - Production deployment" >> workflow-status.md
          echo "" >> workflow-status.md
          
          echo "### Quality Assurance" >> workflow-status.md
          echo "- Security Audit (security.yml) - Security scanning" >> workflow-status.md
          echo "- Accessibility Testing (pa11y.yml) - WCAG compliance" >> workflow-status.md
          echo "- Performance Monitoring (performance-monitoring.yml) - Lighthouse audits" >> workflow-status.md
          echo "" >> workflow-status.md
          
          echo "### Maintenance" >> workflow-status.md
          echo "- Dependency Maintenance (dependency-maintenance.yml) - Package updates" >> workflow-status.md
          echo "- System Maintenance (maintenance.yml) - Repository cleanup" >> workflow-status.md
          echo "- Stale Issues (stale.yml) - Issue/PR management" >> workflow-status.md
          echo "" >> workflow-status.md
          
          echo "### Analysis" >> workflow-status.md
          echo "- Knowledge Graph Radar (knowledge-graph-radar.yml) - Content analysis" >> workflow-status.md
          echo "- Full Stack Analysis (agent-agent-1755381089845-2-full-stack-advanced.yml) - Code analysis" >> workflow-status.md
          echo "- CodeQL Security (codeql.yml) - Security analysis" >> workflow-status.md
          echo "" >> workflow-status.md
          
          echo "### Specialized" >> workflow-status.md
          echo "- Netlify Functions Trigger (netlify-functions-trigger.yml) - Function automation" >> workflow-status.md
          echo "- Release Management (release.yml) - Version releases" >> workflow-status.md
          echo "" >> workflow-status.md
          
          echo "## Workflow Statistics" >> workflow-status.md
          echo "- Total workflows: $WORKFLOW_COUNT" >> workflow-status.md
          
          # Check for potential issues
          echo "" >> workflow-status.md
          echo "## Potential Issues" >> workflow-status.md
          
          # Check for high-frequency schedules
          HIGH_FREQ=$(grep -r "cron.*\*/[0-9]" .github/workflows/ | wc -l)
          if [ "$HIGH_FREQ" -gt 0 ]; then
            echo "- ⚠️ Found $HIGH_FREQ high-frequency workflows" >> workflow-status.md
          else
            echo "- ✅ No high-frequency workflows detected" >> workflow-status.md
          fi
          
          # Check for duplicate concurrency groups
          DUPLICATE_GROUPS=$(grep -r "group:" .github/workflows/ | sed 's/.*group: *//' | sed 's/["'\'']//g' | sort | uniq -d | wc -l)
          if [ "$DUPLICATE_GROUPS" -gt 0 ]; then
            echo "- ⚠️ Found $DUPLICATE_GROUPS duplicate concurrency groups" >> workflow-status.md
          else
            echo "- ✅ No duplicate concurrency groups detected" >> workflow-status.md
          fi
          
          echo "Workflow analysis completed"

      - name: Generate recommendations
        run: |
          echo "## Recommendations" >> workflow-status.md
          echo "" >> workflow-status.md
          echo "### Performance" >> workflow-status.md
          echo "- Monitor workflow execution times" >> workflow-status.md
          echo "- Review timeout settings" >> workflow-status.md
          echo "- Optimize high-frequency workflows" >> workflow-status.md
          echo "" >> workflow-status.md
          
          echo "### Security" >> workflow-status.md
          echo "- Regular security audits" >> workflow-status.md
          echo "- Update dependencies" >> workflow-status.md
          echo "- Monitor for vulnerabilities" >> workflow-status.md
          echo "" >> workflow-status.md
          
          echo "### Maintenance" >> workflow-status.md
          echo "- Regular cleanup of artifacts" >> workflow-status.md
          echo "- Monitor disk usage" >> workflow-status.md
          echo "- Review and update workflows" >> workflow-status.md

      - name: Upload workflow status
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: workflow-status-report
          path: workflow-status.md
          retention-days: 7

      - name: Display summary
        run: |
          echo "## Workflow Management Summary"
          echo "📊 Total workflows: $(find .github/workflows -name "*.yml" | wc -l)"
          echo "📋 Status report generated: workflow-status.md"
          echo "✅ Workflow management completed"
