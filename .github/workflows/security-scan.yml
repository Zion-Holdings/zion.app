name: ğŸ”’ Security Scanning

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - codeql
          - dependencies
          - secrets
          - containers
          - infrastructure

permissions:
  contents: read
  security-events: write
  pull-requests: write
  actions: read

concurrency:
  group: "security-scan-${{ github.ref }}"
  cancel-in-progress: true

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  codeql-analysis:
    name: ğŸ” CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”’ Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript, typescript
          queries: security-extended, security-and-quality

      - name: ğŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{matrix.language}}"

      - name: ğŸ“Š CodeQL results
        if: always()
        run: |
          echo "âœ… CodeQL analysis completed"
          echo "ğŸ“‹ Job: ${{ job.name }}"
          echo "ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  dependency-scan:
    name: ğŸ“¦ Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --prefer-offline

      - name: ğŸ”’ Run npm audit
        run: |
          echo "Running npm security audit..."
          npm audit --audit-level=moderate --json > audit-report.json || echo "Audit completed with findings"
        continue-on-error: true

      - name: ğŸ”’ Run Snyk security scan
        uses: snyk/actions/node@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high
        continue-on-error: true

      - name: ğŸ“Š Dependency scan results
        if: always()
        run: |
          echo "âœ… Dependency vulnerability scan completed"
          echo "ğŸ“‹ Job: ${{ job.name }}"
          echo "ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      - name: ğŸ“¤ Upload audit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit-report
          path: audit-report.json
          retention-days: 30

  secret-scan:
    name: ğŸ” Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: .
          base: HEAD~1
          head: HEAD
          extra_args: --only-verified --json

      - name: ğŸ” Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: --verbose --redact

      - name: ğŸ“Š Secret scan results
        if: always()
        run: |
          echo "âœ… Secret detection completed"
          echo "ğŸ“‹ Job: ${{ job.name }}"
          echo "ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  container-scan:
    name: ğŸ³ Container Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check for Dockerfile
        run: |
          if [ -f "Dockerfile" ] || [ -f "docker-compose.yml" ]; then
            echo "Container files found, proceeding with scan"
          else
            echo "No container files found, skipping container scan"
            exit 0
          fi

      - name: ğŸ³ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: ğŸ“¤ Upload Trivy results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trivy-scan-results
          path: trivy-results.sarif
          retention-days: 30

      - name: ğŸ“Š Container scan results
        if: always()
        run: |
          echo "âœ… Container security scan completed"
          echo "ğŸ“‹ Job: ${{ job.name }}"
          echo "ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  infrastructure-scan:
    name: ğŸ—ï¸ Infrastructure Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ”’ Install security tools
        run: |
          pip install bandit safety

      - name: ğŸ” Run Bandit security linter
        run: |
          echo "Running Bandit security linter..."
          bandit -r . -f json -o bandit-report.json || echo "Bandit scan completed with findings"
        continue-on-error: true

      - name: ğŸ”’ Run Safety check
        run: |
          echo "Running Safety dependency check..."
          safety check --json --output safety-report.json || echo "Safety check completed with findings"
        continue-on-error: true

      - name: ğŸ“¤ Upload infrastructure scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: infrastructure-scan-results
          path: |
            bandit-report.json
            safety-report.json
          retention-days: 30

      - name: ğŸ“Š Infrastructure scan results
        if: always()
        run: |
          echo "âœ… Infrastructure security scan completed"
          echo "ğŸ“‹ Job: ${{ job.name }}"
          echo "ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  security-policy-check:
    name: ğŸ“‹ Security Policy Compliance
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [codeql-analysis, dependency-scan, secret-scan, container-scan, infrastructure-scan]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Check security policy
        run: |
          echo "Checking security policy compliance..."
          
          # Check for security policy file
          if [ -f "SECURITY.md" ]; then
            echo "âœ… SECURITY.md found"
          else
            echo "âš ï¸ SECURITY.md not found - consider creating one"
          fi
          
          # Check for security advisories
          if [ -f ".github/security/advisories.md" ]; then
            echo "âœ… Security advisories found"
          else
            echo "â„¹ï¸ No security advisories found"
          fi
          
          # Check for dependency policy
          if [ -f ".github/dependabot.yml" ]; then
            echo "âœ… Dependabot configuration found"
          else
            echo "â„¹ï¸ No Dependabot configuration found"
          fi

      - name: ğŸ“Š Policy compliance results
        if: always()
        run: |
          echo "âœ… Security policy compliance check completed"
          echo "ğŸ“‹ Job: ${{ job.name }}"
          echo "ğŸ”— Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  security-summary:
    name: ğŸ“‹ Security Scan Summary
    runs-on: ubuntu-latest
    needs: [codeql-analysis, dependency-scan, secret-scan, container-scan, infrastructure-scan, security-policy-check]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate security summary
        run: |
          echo "ğŸ”’ Security Scanning Summary"
          echo "============================"
          echo "ğŸ“… Run: $(date)"
          echo "ğŸ”— Workflow: ${{ github.workflow }}"
          echo "ğŸ”— Run ID: ${{ github.run_id }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ”— Branch: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ“‹ Security Scan Results:"
          echo "âœ… CodeQL Analysis: ${{ needs.codeql-analysis.result }}"
          echo "âœ… Dependency Scan: ${{ needs.dependency-scan.result }}"
          echo "âœ… Secret Detection: ${{ needs.secret-scan.result }}"
          echo "âœ… Container Scan: ${{ needs.container-scan.result }}"
          echo "âœ… Infrastructure Scan: ${{ needs.infrastructure-scan.result }}"
          echo "âœ… Policy Compliance: ${{ needs.security-policy-check.result }}"
          echo ""
          if [[ "${{ needs.codeql-analysis.result }}" == "success" && "${{ needs.dependency-scan.result }}" == "success" ]]; then
            echo "ğŸ‰ Core security scans completed successfully!"
          else
            echo "âš ï¸ Some security scans failed. Please review the logs above."
          fi

      - name: ğŸ“¤ Upload security summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-scan-summary
          path: |
            security-summary.txt
          retention-days: 30
