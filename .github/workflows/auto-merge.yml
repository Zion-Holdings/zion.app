name: Auto Merge Automation PRs

on:
  workflow_run:
    workflows: ["Autonomous Orchestrator", "Auto Dependency Bump"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  merge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Merge PRs with label automation
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prs = await github.paginate(github.rest.pulls.list, { owner, repo, state: 'open' });
            for (const pr of prs) {
              const labels = pr.labels.map(l => l.name);
              if (labels.includes('automation')) {
                try {
                  await github.rest.pulls.merge({ owner, repo, pull_number: pr.number, merge_method: 'squash' });
                  core.info(`Merged PR #${pr.number}`);
                } catch (e) {
                  core.info(`Skip merge PR #${pr.number}: ${e.message}`);
                }
              }
            }