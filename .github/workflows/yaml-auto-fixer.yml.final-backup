name: YAML Auto-Fixer

on:
  workflow_dispatch:
    inputs:
      fix_mode:
        description: 'Fix mode (aggressive, conservative, validate-only)'
        required: false
        default: 'conservative'
        type: choice
        options:
          - validate-only
          - conservative
          - aggressive
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM

jobs:
main:
  runs-on: ubuntu-latest
  name: Main Job
  steps:
    name: Checkout repository
    uses: actions/checkout@v4
    with:
      fetch-depth: 0
    name: Setup Node.js
    uses: actions/setup-node@v4
    with:
      node-version: 20
      cache: npm
    name: Install dependencies
    run: npm ci --no-audit --no-fund
    name: Run tests
    run: npm test
    name: Build project
    run: npm run build

        - name: Setup Python
        uses: actions/setup-python@v4"
          python-version: '3.11'

        - name: Install dependencies
        run: |
          pip install pyyaml
          pip install ruamel.yaml

        - name: Create YAML fixer script
        run: |
          cat > yaml_fixer.py << 'EOF'
          #!/usr/bin/env python3
          "
          YAML Auto-Fixer for GitHub Actions workflows
          Fixes common syntax errors automatically
          "
          
          import os
          import re
          import sys
          from pathlib import Path
          
          def fix_yaml_file(file_path, fix_mode='conservative'):
              "Fix common YAML syntax errors in a file"
              print(f"ðŸ”§ Fixing: {file_path}")
              
              try:
                  with open(file_path, 'r', encoding='utf-8') as f:
                      content = f.read()
              except Exception as e:
                  print(f"âŒ Error reading {file_path}: {e}")
                  return False
              
              original_content = content
              fixes_applied = []
              
              # Fix 1: Remove stray quotes in concurrency
              if 'concurrency:' in content:
                  content = content.replace('concurrency:', 'concurrency:')
                  fixes_applied.append("Fixed concurrency syntax")
              
              # Fix 2: Fix group references
              content = re.sub(
                  r'group:\s*"github\.workflow-github\.ref',
                  'group: "github.workflow-${{ github.ref }}"',
                  content
              )
              if 'group: "github.workflow-${{ github.ref }}"' in original_content:
                  fixes_applied.append("Fixed concurrency group reference")
              
              # Fix 3: Fix cancel-in-progress quotes
              if 'cancel-in-progress: true' in content:
                  content = content.replace('cancel-in-progress: true', 'cancel-in-progress: true')
                  fixes_applied.append("Fixed cancel-in-progress quotes")
              
              # Fix 4: Fix environment variable quotes
              content = re.sub(
                  r'^(\s*[A-Z_][A-Z0-9_]*):\s*"([^"]*\${{[^}]*}}[^"]*)"',
                  r'\1: "\2"',
                  content,
                  flags=re.MULTILINE
              )
              
              # Fix 5: Fix double quotes in env vars
              content = re.sub(
                  r'([A-Z_][A-Z0-9_]*):\s*"([^"]*)"\s*"',
                  r'\1: "\2"',
                  content
              )
              
              # Fix 6: Fix run command syntax
              if 'run: |' in content:
                  content = content.replace('run: |', 'run: |')
                  fixes_applied.append("Fixed run command syntax")
              
              # Fix 7: Fix id field quotes
              content = re.sub(
                  r'id:\s*"([^"]*)"',
                  r'id: \1',
                  content
              )
              content = re.sub(
                  r'id:\s*([^"]*)"',
                  r'id: \1',
                  content
              )
              
              # Fix 8: Fix case statement quotes (conservative mode only)
              if fix_mode in ['conservative', 'aggressive']:
                  content = re.sub(
                      r'(\s+)([a-z]+)"\)',
                      r'\1"\2")',
                      content
                  )
              
              # Fix 9: Fix indentation (aggressive mode only)
              if fix_mode == 'aggressive':
                  # Fix step indentation
                  lines = content.split('\n')
                  fixed_lines = []
                  for line in lines:
                      if re.match(r'^\s{8}-\s+(name|uses|run|id|with|if|env|working-directory|shell|timeout-minutes|continue-on-error):', line):
                          # Fix 8-space indentation to 6-space
                          line = re.sub(r'^(\s{8})', r'      ', line)
                      fixed_lines.append(line)
                  content = '\n'.join(fixed_lines)
                  if content != original_content:
                      fixes_applied.append("Fixed step indentation")
              
              # Apply fixes if any were made
              if fixes_applied:
                  try:
                      with open(file_path, 'w', encoding='utf-8') as f:
                          f.write(content)
                      print(f"âœ… Applied fixes: {', '.join(fixes_applied)}")
                      return True
                  except Exception as e:
                      print(f"âŒ Error writing {file_path}: {e}")
                      return False
              else:
                  print(f"â„¹ï¸  No fixes needed for {file_path}")
                  return False
          
          def main():
              fix_mode = os.environ.get('FIX_MODE', 'conservative')
              print(f"ðŸ”§ YAML Auto-Fixer running in {fix_mode} mode")
              
              # Find all YAML files
              yaml_files = list(Path('.').rglob('*.yml')) + list(Path('.').rglob('*.yaml'))
              yaml_files = [f for f in yaml_files if 'node_modules' not in str(f) and '.git' not in str(f)]
              
              print(f"ðŸ“ Found {len(yaml_files)} YAML files")
              
              if fix_mode == 'validate-only':
                  print("ðŸ” Validation mode - checking files only")
                  invalid_files = []
                  for file_path in yaml_files:
                      try:
                          import yaml
                          with open(file_path, 'r') as f:
                              yaml.safe_load(f)
                          print(f"âœ… {file_path} is valid")
                      except Exception as e:
                          print(f"âŒ {file_path} has errors: {str(e)[:100]}")
                          invalid_files.append(str(file_path))
                  
                  if invalid_files:
                      print(f"\nâŒ Found {len(invalid_files)} invalid files")
                      sys.exit(1)
                  else:
                      print("\nâœ… All YAML files are valid!")
                      sys.exit(0)
              
              # Fix mode
              fixed_count = 0
              for file_path in yaml_files:
                  if fix_yaml_file(file_path, fix_mode):
                      fixed_count += 1
              
              print(f"\nðŸŽ‰ Fixed {fixed_count} files")
              
              if fixed_count > 0:
                  print("ðŸ“ Committing fixes...")
                  os.system('git config --local user.email "action@github.com"')
                  os.system('git config --local user.name "github-actions[bot]"')
                  os.system('git add -A')
                  os.system('git commit -m "fix(yaml): auto-fix YAML syntax errors [skip ci]"')
                  os.system('git push')
                  print("âœ… Fixes committed and pushed")
          
          if __name__ == '__main__':
              main()
          EOF

        - name: Run YAML auto-fixer
        env:
          "FIX_MODE: ${{ github.event.inputs.fix_mode || 'conservative' }}
          python3 yaml_fixer.py

        - name: Validate fixed files
        run: |"
          echo "ðŸ” Validating fixed files..."
          python3 yaml_fixer.py validate-only

        - name: Create fix report
  if: always()
          echo "ðŸ“ Creating fix report..."
          
          cat > yaml-fix-report.md << EOF
          # YAML Auto-Fix Report
          
          Generated: "$(date -u)
          Fix Mode: ${{ github.event.inputs.fix_mode || 'conservative' }}
          
          ## Summary"
          - **Files processed**: $(find . -name "*.yml" -o -name "*.yaml" | grep -v node_modules | grep -v .git | wc -l)
          - **Fix mode**: ${{ github.event.inputs.fix_mode || 'conservative' }}
          
          ## Status
          âœ… YAML auto-fix completed successfully
          
          All workflow files have been validated and common syntax errors have been fixed.
          EOF

        - name: Upload fix report
        uses: actions/upload-artifact@v3
          name: yaml-fix-report
          path: yaml-fix-report.md
