name: üó∫Ô∏è Sitemap Auto-Commit

on:
  schedule:
    - cron: '12 3 * * *'  # Daily at 3:12 AM
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force sitemap update even if no changes detected'
        required: false
        default: false
        type: boolean
  push:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'pages/**'
      - 'app/**'
      - '.github/workflows/sitemap-auto-commit.yml'

permissions:
  contents: write
  pull-requests: write
  actions: read

concurrency:
  group: sitemap-auto-commit
  cancel-in-progress: true

jobs:
  build-and-update:
    name: Build and Update Sitemap
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Generate sitemap
        run: |
          echo "üó∫Ô∏è Generating sitemap..."
          
          # Create sitemap directory if it doesn't exist
          mkdir -p public
          
          # Generate sitemap.xml
          cat > public/sitemap.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
            <url>
              <loc>https://zion.app/</loc>
              <lastmod>$(date -u +%Y-%m-%d)</lastmod>
              <changefreq>daily</changefreq>
              <priority>1.0</priority>
            </url>
            <url>
              <loc>https://zion.app/about</loc>
              <lastmod>$(date -u +%Y-%m-%d)</lastmod>
              <changefreq>weekly</changefreq>
              <priority>0.8</priority>
            </url>
            <url>
              <loc>https://zion.app/services</loc>
              <lastmod>$(date -u +%Y-%m-%d)</lastmod>
              <changefreq>weekly</changefreq>
              <priority>0.8</priority>
            </url>
            <url>
              <loc>https://zion.app/contact</loc>
              <lastmod>$(date -u +%Y-%m-%d)</lastmod>
              <changefreq>monthly</changefreq>
              <priority>0.6</priority>
            </url>
          </urlset>
          EOF
          
          echo "‚úÖ Sitemap generated successfully"

      - name: Check for changes
        id: check-changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Changes detected in sitemap"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changes detected"
          fi

      - name: Commit and push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add public/sitemap.xml
          git commit -m "üó∫Ô∏è Update sitemap - Automated daily update" || echo "No changes to commit"
          git push origin HEAD:main || echo "Push failed or no changes"

      - name: Summary
        run: |
          echo "üéâ Sitemap auto-commit completed!"
          if [ "${{ steps.check-changes.outputs.has_changes }}" == "true" ]; then
            echo "‚úÖ Sitemap updated and committed"
          else
            echo "‚ÑπÔ∏è No sitemap changes in this run"
          fi
          
          echo "üìÖ Next run: Tomorrow at 3:12 AM UTC"