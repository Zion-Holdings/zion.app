name: Build Monitor
on:
  workflow_run:
    workflows: ["Deploy to Netlify"]
    types: [completed]
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours

jobs:
  monitor-builds:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run pre-build validation
        run: |
          chmod +x scripts/pre-build-check.sh
          ./scripts/pre-build-check.sh
      
      - name: Check build health
        run: |
          echo "🔍 Checking build health..."
          
          # Check for critical files
          if [ ! -f "_headers" ]; then
            echo "❌ _headers file missing"
            exit 1
          fi
          
          if [ ! -f "_redirects" ]; then
            echo "❌ _redirects file missing"
            exit 1
          fi
          
          # Check for security vulnerabilities
          npm audit --audit-level=high || {
            echo "⚠️  High/critical security vulnerabilities found"
            exit 1
          }
          
          echo "✅ Build health check passed"
      
      - name: Test build process
        run: |
          echo "🧪 Testing build process..."
          
          # Clean previous builds
          rm -rf .next out tsconfig.tsbuildinfo
          
          # Test build (without full export)
          npm run build || {
            echo "❌ Build test failed"
            exit 1
          }
          
          echo "✅ Build test passed"
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['build-failure', 'automated']
            });
            
            // Check if issue already exists
            const existingIssue = issues.find(issue => 
              issue.title.includes('Build Health Check Failed')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: '🚨 Build Health Check Failed',
                body: `
                  ## 🚨 Build Health Check Failed
                  
                  The automated build health check has failed. This requires immediate attention.
                  
                  ### Failure Details
                  - **Workflow**: ${{ github.workflow }}
                  - **Run ID**: ${{ github.run_id }}
                  - **Commit**: ${{ github.sha }}
                  - **Branch**: ${{ github.ref }}
                  
                  ### Required Actions
                  - [ ] Investigate build failure
                  - [ ] Check for missing files (_headers, _redirects)
                  - [ ] Review security vulnerabilities
                  - [ ] Test build locally
                  - [ ] Fix issues and redeploy
                  
                  ### Related Links
                  - [Build Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                  - [Commit Details](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
                  
                  ---
                  *This issue was automatically created by GitHub Actions*
                `,
                labels: ['build-failure', 'automated', 'urgent'],
                assignees: ['${{ github.repository_owner }}']
              });
            }
      
      - name: Comment on existing issue
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['build-failure', 'automated']
            });
            
            const existingIssue = issues.find(issue => 
              issue.title.includes('Build Health Check Failed')
            );
            
            if (existingIssue) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existingIssue.number,
                body: `
                  ## 🔄 Build Health Check Failed Again
                  
                  **Timestamp**: ${new Date().toISOString()}
                  **Workflow**: ${{ github.workflow }}
                  **Run ID**: ${{ github.run_id }}
                  
                  This issue is still unresolved. Please prioritize fixing the build issues.
                  
                  [View Latest Build Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                `
              });
            }