name: Lighthouse CI

on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch: {}

permissions:
  contents: read
  issues: write

jobs:
  lhci:
    runs-on: ubuntu-latest
    steps:
      - name: Run Lighthouse CI
        run: |
          npm i -g @lhci/cli
          lhci autorun --collect.url=https://ziontechgroup.netlify.app --collect.numberOfRuns=3 || echo "LHCI completed with non-zero exit"
      - name: Parse report and create issue on regression
        run: |
          set -e
          LHR=$(ls .lighthouseci/*report.json | head -n1)
          PERF=$(jq '.categories.performance.score*100' "$LHR")
          if [ "$PERF" -lt 90 ]; then
            TITLE="Lighthouse performance regression: $PERF"
            BODY="Automated Lighthouse detected performance score $PERF (<90). Please investigate."
            echo "$BODY" > body.txt
            gh issue create --title "$TITLE" --body-file body.txt || true
          else
            echo "Performance is OK: $PERF"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}