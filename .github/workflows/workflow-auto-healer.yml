name: Workflow Auto Healer Auto-Healer

on:
  schedule:
    - cron: '0 */2 * * *'  # Every 2 hours
  workflow_dispatch: null
  workflow_run:
    workflows: ['CI', 'Test Suite', 'Security Scan']
    types: [completed, in_progress]

permissions:
  contents: write
  actions: read
  pull-requests: write

concurrency:
  group: workflow-auto-healer
  cancel-in-progress: false

jobs:
  auto-heal:
    name: Auto-Heal Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install dependencies
        run: |
          pip install pyyaml
      - name: Run workflow auto healer validation
        id: validate
        run: |
          echo "Validating all workflow files..."
          invalid_files = []
          
          for workflow_file in $(find .github/workflows -name "*.yml" -o -name "*.yaml"); do
            if ! python3 -c "import yaml; yaml.safe_load(open('$workflow_file', 'r'))" 2>/dev/null; then
              invalid_files.append("$workflow_file")
              echo "Invalid workflow: $workflow_file"
            fi
          done
          
          if [ ${#invalid_files[@]} -gt 0 ]; then
            echo "needs_fix=true" >> $GITHUB_OUTPUT
            echo "invalid_count=${#invalid_files[@]}" >> $GITHUB_OUTPUT
            echo "Found ${#invalid_files[@]} invalid workflows"
          else
            echo "needs_fix=false" >> $GITHUB_OUTPUT
            echo "All workflows are valid"
          fi
      - name: Report workflow status
        run: |
          echo "Workflow validation completed"
          echo "Needs fix: ${{ steps.validate.outputs.needs_fix }}"
          echo "Invalid count: ${{ steps.validate.outputs.invalid_count }}"
      - name: Create issue for manual review
        if: steps.validate.outputs.needs_fix == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const invalidCount = '${{ steps.validate.outputs.invalid_count }}';
            const message = `ðŸ”§ **Workflow Auto-Healer Report**\n\nFound ${invalidCount} invalid workflow files that need manual attention.\n\nPlease review and fix these workflows manually.`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Workflow Auto-Healer: ${invalidCount} Invalid Workflows Found`,
              body: message,
              labels: ['workflow-fix', 'automation', 'needs-attention']
            });
