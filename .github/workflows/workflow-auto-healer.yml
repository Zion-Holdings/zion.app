name: Workflow Auto-Healer

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch: {}

permissions:
concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"
  cancel-in-progress: true
  contents: read
  actions: read

jobs:
  validate:
    name: Validate Workflows
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        run: pip install pyyaml
          
      - name: Validate workflows
        run: |
          echo "Validating all workflow files..."
          invalid_count=0
          
          for workflow_file in $(find .github/workflows -name "*.yml" -o -name "*.yaml"); do
            if ! python3 -c "import yaml; yaml.safe_load(open('$workflow_file', 'r'))" 2>/dev/null; then
              echo "❌ Invalid workflow: $workflow_file"
              invalid_count=$((invalid_count + 1))
            fi
          done
          
          if [ $invalid_count -gt 0 ]; then
            echo "Found $invalid_count invalid workflows"
            echo "Please run the fix script: ./scripts/fix-all-workflows.sh"
            exit 1
          else
            echo "✅ All workflows are valid"
          fi