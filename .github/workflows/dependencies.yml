---
name: Dependency Updates
on:
  schedule:
    - cron: 0 4 * * 1
  workflow_dispatch: {}
permissions:
  contents: write
  pull-requests: write
  actions: read
concurrency:
  group: dependency-updates
  cancel-in-progress: false
jobs:
  update-deps:
    name: Update Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Install dependencies
        run: npm ci --no-audit --no-fund
      - name: Check for outdated dependencies
        id: check-deps
        run: |
          echo "Checking for outdated dependencies..."
          npm outdated --json > outdated-deps.json || echo "{}" > outdated-deps.json
          
          # Count outdated packages
          OUTDATED_COUNT=$(jq 'length' outdated-deps.json)
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$OUTDATED_COUNT" -gt 0 ]; then
            echo "Found $OUTDATED_COUNT outdated dependencies"
          else
            echo "All dependencies are up to date"
          fi
      - name: Update dependencies
        if: steps.check-deps.outputs.outdated_count > '0'
        run: |
          echo "Updating dependencies..."
          
          # Update npm packages
          npm update
          
          # Check for major version updates
          npm outdated --json > major-updates.json || echo "{}" > major-updates.json
          
          # Generate update report
          echo "## Dependency Update Report" > update-report.md
          echo "Generated on $(date)" >> update-report.md
          echo "" >> update-report.md
          echo "### Updated Packages:" >> update-report.md
          jq -r 'to_entries[] | "- \(.key): \(.value.current) â†’ \(.value.latest)"' outdated-deps.json >> update-report.md || echo "No updates available" >> update-report.md
      - name: Create Pull Request
        if: steps.check-deps.outputs.outdated_count > '0'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: "ðŸ¤– Automated Dependency Updates"
          body: |
            This PR contains automated dependency updates.
            
            ## Changes
            
            - Updated outdated npm packages
            - Minor and patch version updates only
            - Major version updates require manual review
            
            ## Review Required
            
            - [ ] Test the application locally
            - [ ] Verify all tests pass
            - [ ] Check for breaking changes
            
            Generated by GitHub Actions on ${{ github.event.schedule }}
          branch: dependency-updates
          delete-branch: true
          labels: |
            dependencies
            automated
            maintenance
      - name: Upload reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            outdated-deps.json
            major-updates.json
            update-report.md
          retention-days: 30
