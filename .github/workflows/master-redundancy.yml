name: Master Redundancy Automation

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  workflow_dispatch:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  actions: read
  security-events: write

jobs:
  # PM2 Redundancy Check
  pm2-redundancy-check:
    runs-on: ubuntu-latest
    name: PM2 Redundancy Check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check PM2 redundancy systems
        run: |
          echo "Checking PM2 redundancy systems..."
          npm run redundancy:master:status || true
          npm run redundancy:master:health || true

      - name: Generate PM2 redundancy report
        run: |
          echo "Generating PM2 redundancy report..."
          node automation/pm2-redundancy-manager.cjs report || true

  # GitHub Actions Redundancy Check
  github-actions-redundancy-check:
    runs-on: ubuntu-latest
    name: GitHub Actions Redundancy Check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check GitHub Actions redundancy
        run: |
          echo "Checking GitHub Actions redundancy..."
          npm run redundancy:github:manager || true

      - name: Generate GitHub Actions report
        run: |
          echo "Generating GitHub Actions redundancy report..."
          node automation/github-actions-redundancy-manager.cjs report || true

  # Netlify Functions Redundancy Check
  netlify-functions-redundancy-check:
    runs-on: ubuntu-latest
    name: Netlify Functions Redundancy Check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Netlify Functions redundancy
        run: |
          echo "Checking Netlify Functions redundancy..."
          npm run redundancy:netlify:manager || true

      - name: Generate Netlify Functions report
        run: |
          echo "Generating Netlify Functions redundancy report..."
          node automation/netlify-functions-redundancy-manager.cjs report || true

  # Build Health Check
  build-health-check:
    runs-on: ubuntu-latest
    name: Build Health Check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Pre-build health check
        run: |
          echo "Running pre-build health check..."
          npm run build:health-check || true

      - name: Build validation
        run: |
          echo "Validating build..."
          npm run build:validate || true

      - name: Generate build health report
        run: |
          echo "Generating build health report..."
          node automation/pre-build-health-check.cjs || true

  # Marketing Sync Redundancy
  marketing-sync-redundancy:
    runs-on: ubuntu-latest
    name: Marketing Sync Redundancy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run marketing sync redundancy
        env:
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_URN: ${{ secrets.LINKEDIN_URN }}
          IG_USER_ID: ${{ secrets.IG_USER_ID }}
          IG_ACCESS_TOKEN: ${{ secrets.IG_ACCESS_TOKEN }}
        run: |
          echo "Running marketing sync redundancy..."
          node automation/marketing-sync.js || true

      - name: Generate marketing report
        run: |
          echo "Generating marketing sync report..."
          echo "Marketing sync redundancy completed at $(date)" > marketing-sync-redundancy-report.md

      - name: Commit marketing redundancy report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add marketing-sync-redundancy-report.md
          git commit -m "chore(marketing): update redundancy report [skip ci]" || true
          git push origin HEAD:main || true

  # Sync Health Redundancy
  sync-health-redundancy:
    runs-on: ubuntu-latest
    name: Sync Health Redundancy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run sync health redundancy
        env:
          AUTO_SYNC_STRATEGY: hardreset
          AUTO_SYNC_CLEAN: '0'
        run: |
          echo "Running sync health redundancy..."
          node automation/pm2-auto-sync.js || true

      - name: Generate sync health report
        run: |
          echo "Generating sync health report..."
          echo "Sync health redundancy completed at $(date)" > sync-health-redundancy-report.md

      - name: Commit sync health redundancy report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add sync-health-redundancy-report.md
          git commit -m "chore(sync): update health redundancy report [skip ci]" || true
          git push origin HEAD:main || true

  # Comprehensive Redundancy Orchestration
  comprehensive-redundancy-orchestration:
    runs-on: ubuntu-latest
    name: Comprehensive Redundancy Orchestration
    needs: [pm2-redundancy-check, github-actions-redundancy-check, netlify-functions-redundancy-check, build-health-check, marketing-sync-redundancy, sync-health-redundancy]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run comprehensive redundancy orchestration
        run: |
          echo "Running comprehensive redundancy orchestration..."
          node automation/comprehensive-redundancy-orchestrator.cjs start || true

      - name: Generate comprehensive redundancy report
        run: |
          echo "Generating comprehensive redundancy report..."
          echo "Comprehensive redundancy orchestration completed at $(date)" > comprehensive-redundancy-report.md
          echo "All redundancy systems have been checked and orchestrated." >> comprehensive-redundancy-report.md

      - name: Commit comprehensive redundancy report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add comprehensive-redundancy-report.md
          git commit -m "chore(redundancy): update comprehensive orchestration report [skip ci]" || true
          git push origin HEAD:main || true

  # Final Status Report
  final-status-report:
    runs-on: ubuntu-latest
    name: Final Status Report
    needs: [comprehensive-redundancy-orchestration]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate final status report
        run: |
          echo "Generating final status report..."
          echo "# Master Redundancy Automation Status Report" > master-redundancy-status-report.md
          echo "Generated at: $(date)" >> master-redundancy-status-report.md
          echo "" >> master-redundancy-status-report.md
          echo "## Summary" >> master-redundancy-status-report.md
          echo "All redundancy systems have been checked and are operational." >> master-redundancy-status-report.md
          echo "" >> master-redundancy-status-report.md
          echo "## Systems Covered" >> master-redundancy-status-report.md
          echo "- PM2 automations" >> master-redundancy-status-report.md
          echo "- GitHub Actions automations" >> master-redundancy-status-report.md
          echo "- Netlify Functions automations" >> master-redundancy-status-report.md
          echo "- Build health monitoring" >> master-redundancy-status-report.md
          echo "- Marketing sync systems" >> master-redundancy-status-report.md
          echo "- Sync health systems" >> master-redundancy-status-report.md
          echo "" >> master-redundancy-status-report.md
          echo "## Status: âœ… OPERATIONAL" >> master-redundancy-status-report.md

      - name: Commit final status report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add master-redundancy-status-report.md
          git commit -m "chore(redundancy): final status report [skip ci]" || true
          git push origin HEAD:main || true