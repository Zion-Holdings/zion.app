name: Performance Monitoring

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # Every 6 hours
  push:
    branches: [ main, develop ]
    paths:
      - 'pages/**'
      - 'components/**'
      - 'next.config.js'
      - 'tailwind.config.js'


concurrency:
  group: "github.workflow-${{ github.ref }}"
  cancel-in-progress: true

jobs:
  performance-audit:
    runs-on: ubuntu-latest
    name: Performance Audit
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          'node-version': '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            http://localhost:3000
            http://localhost:3000/dashboard
            http://localhost:3000/settings
          uploadArtifacts: true
          temporaryPublicStorage: true
          
      - name: Bundle analysis
        run: |
          npm run build
          npx @next/bundle-analyzer .next/static/chunks/*.js --outDir ./bundle-analysis
          
      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: ./bundle-analysis
          
      - name: Performance metrics report
        run: |
          echo "## Performance Metrics Report" > performance-report.md
          echo " >> performance-report.md
          echo "Generated on: $(date)" >> performance-report.md
          echo " >> performance-report.md
          echo "### Bundle Size Analysis" >> performance-report.md
          echo "Bundle analysis artifacts uploaded to bundle-analysis/" >> performance-report.md
          echo " >> performance-report.md
          echo "### Lighthouse Scores" >> performance-report.md
          echo "Lighthouse CI results available in artifacts" >> performance-report.md
          
      - name: Upload performance report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report
          path: performance-report.md

  bundle-optimization:
    runs-on: ubuntu-latest
    name: Bundle Optimization
    needs: performance-audit
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          'node-version': '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Analyze bundle
        run: |
          npm run build
          npx webpack-bundle-analyzer .next/static/chunks/*.js --mode static --report
          
      - name: Upload bundle report
        uses: actions/upload-artifact@v4
        with:
          name: webpack-bundle-report
          path: webpack-bundle-analyzer-report.html

  performance-alerts:
    runs-on: ubuntu-latest
    name: Performance Alerts
    needs: [performance-audit, bundle-optimization]
    if: always()
    
    steps:
      - name: Check performance thresholds
        run: |
          echo "Checking performance thresholds..."
          # Add logic to check if performance metrics are below thresholds
          # and send alerts if needed
          
      - name: Performance summary
        run: |
          echo "## Performance Summary" >> summary.md
          echo " >> summary.md
          echo "All performance checks completed." >> summary.md
          echo "Check artifacts for detailed reports." >> summary.md
          
      - name: Upload summary
        uses: actions/upload-artifact@v4
        with:
          name: performance-summary
          path: summary.md
