name: Lighthouse CI

on:
  pull_request:
  push:
    branches: [ main ]
  schedule:
    - cron: '45 2 * * *'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lhci:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Build static dist
        run: |
          rm -rf dist
          mkdir -p dist
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='dist' \
            ./ dist/ | cat
      - name: Run Lighthouse CI
        run: npx --yes @lhci/cli@0.13.0 autorun --collect.staticDistDir=dist --upload.target=temporary-public-storage || true
      - name: Upload LHCI reports
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-report
          path: .lighthouseci
      - name: Generate Lighthouse badge JSON
        run: |
          node - <<'NODE'
          import { promises as fs } from 'node:fs';
          import path from 'node:path';
          const dir = '.lighthouseci';
          const files = await fs.readdir(dir);
          const lhrs = files.filter(f => f.startsWith('lhr-') && f.endsWith('.json'));
          if (lhrs.length === 0) process.exit(0);
          const reports = [];
          for (const f of lhrs) {
            try {
              const j = JSON.parse(await fs.readFile(path.join(dir, f), 'utf8'));
              reports.push(j);
            } catch {}
          }
          if (reports.length === 0) process.exit(0);
          const r = reports[0];
          const cats = r.categories || {};
          function pct(x) { return Math.round((x?.score ?? 0) * 100); }
          const scores = {
            performance: pct(cats.performance),
            accessibility: pct(cats.accessibility),
            seo: pct(cats.seo),
            best: pct(cats['best-practices'])
          };
          const avg = Math.round((scores.performance + scores.accessibility + scores.seo + scores.best) / 4);
          const badge = {
            schemaVersion: 1,
            label: 'lighthouse',
            message: `${avg}/100`,
            color: avg >= 90 ? 'brightgreen' : avg >= 80 ? 'green' : avg >= 70 ? 'yellowgreen' : avg >= 60 ? 'yellow' : 'orange'
          };
          await fs.mkdir('badges', { recursive: true });
          await fs.writeFile('badges/lighthouse.json', JSON.stringify(badge), 'utf8');
          console.log('Wrote badges/lighthouse.json');
          NODE
      - name: Commit Lighthouse badge
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: 'chore(badge): update Lighthouse badge'
          file_pattern: badges/lighthouse.json