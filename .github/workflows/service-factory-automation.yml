name: Service Factory Automation

on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths:
      - 'automation/service-factory/**'

jobs:
  service-factory:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Create directories
        run: |
          mkdir -p public/automation/services
          mkdir -p public/automation/market-intelligence
          mkdir -p public/automation/opportunities
          mkdir -p generated-services

      - name: Run Market Intelligence Analysis
        run: |
          echo "ðŸ” Running market intelligence analysis..."
          node automation/service-factory/market-intelligence.cjs full
        continue-on-error: true

      - name: Run Opportunity Detection
        run: |
          echo "ðŸŽ¯ Running opportunity detection..."
          node automation/service-factory/opportunity-detector.cjs full
        continue-on-error: true

      - name: Generate Service Blueprints
        run: |
          echo "ðŸ“‹ Generating service blueprints..."
          node automation/service-factory/service-blueprint-generator.cjs
        continue-on-error: true

      - name: Run Full Service Creation Pipeline
        run: |
          echo "ðŸš€ Running full service creation pipeline..."
          node automation/service-factory/service-factory-orchestrator.cjs full
        continue-on-error: true

      - name: Generate Service Factory Report
        run: |
          echo "ðŸ“Š Generating service factory report..."
          node automation/service-factory/service-factory-orchestrator.cjs health
        continue-on-error: true

      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "feat(automation): service factory automation run [skip ci]"
            git push origin HEAD:main
          fi

  service-generation:
    runs-on: ubuntu-latest
    needs: service-factory
    if: always()
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Generate Sample Services
        run: |
          echo "ðŸ—ï¸ Generating sample services..."
          
          # Generate a Python AI service
          node automation/service-factory/mvp-generator.cjs ai-analytics "AI Analytics Platform" python
          
          # Generate a Node.js ML service
          node automation/service-factory/mvp-generator.cjs ml-pipeline "Machine Learning Pipeline" nodejs
          
          # Generate a Go data service
          node automation/service-factory/mvp-generator.cjs data-processor "Data Processing Service" go
        continue-on-error: true

      - name: Commit generated services
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --cached --quiet; then
            echo "No services to commit"
          else
            git commit -m "feat(services): auto-generated sample services [skip ci]"
            git push origin HEAD:main
          fi

  quality-assurance:
    runs-on: ubuntu-latest
    needs: [service-factory, service-generation]
    if: always()
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci --no-audit --no-fund

      - name: Run Service Factory Health Check
        run: |
          echo "ðŸ¥ Running service factory health check..."
          node automation/service-factory/service-factory-orchestrator.cjs health
        continue-on-error: true

      - name: List Generated Services
        run: |
          echo "ðŸ“‹ Listing generated services..."
          node automation/service-factory/service-factory-orchestrator.cjs list
        continue-on-error: true

      - name: Generate Quality Report
        run: |
          echo "ðŸ“Š Generating quality report..."
          
          # Create quality report
          cat > quality-report.md << EOF
          # Service Factory Quality Report
          
          Generated: $(date)
          
          ## Health Status
          - Service Factory: Operational
          - Market Intelligence: Active
          - Opportunity Detection: Active
          - MVP Generation: Active
          
          ## Generated Services
          $(node automation/service-factory/service-factory-orchestrator.cjs list 2>/dev/null || echo "No services found")
          
          ## Next Steps
          1. Review generated services
          2. Customize for specific needs
          3. Deploy to staging environment
          4. Gather user feedback
          5. Iterate and improve
          
          EOF
          
          echo "Quality report generated"
        continue-on-error: true

      - name: Commit quality report
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add quality-report.md
          if git diff --cached --quiet; then
            echo "No quality report to commit"
          else
            git commit -m "docs: add service factory quality report [skip ci]"
            git push origin HEAD:main
          fi