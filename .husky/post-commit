#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 Enhanced Post-commit System Starting..."

# Set environment variables for autonomous operation
export AUTONOMOUS_MODE=true
export HUSKY_AUTOMATION=true
export POST_COMMIT_MODE=true

# Get commit information
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%B)
BRANCH_NAME=$(git branch --show-current)

echo "📝 Commit: $COMMIT_HASH"
echo "💬 Message: $COMMIT_MESSAGE"
echo "🌿 Branch: $BRANCH_NAME"

# Run autonomous post-commit actions
echo "🤖 Running autonomous post-commit actions..."

# 1. Update commit metadata
echo "📊 Updating commit metadata..."
node automation/enhanced-automation-system.js update-commit-metadata "$COMMIT_HASH" "$COMMIT_MESSAGE" || {
    echo "⚠️  Failed to update commit metadata"
}

# 2. Trigger autonomous improvements
echo "🔄 Triggering autonomous improvements..."
node automation/enhanced-automation-system.js post-commit || {
    echo "⚠️  Autonomous improvements failed, but continuing..."
}

# 3. Auto-push if configured
if [ "$AUTO_PUSH_ENABLED" = "true" ]; then
    echo "🚀 Auto-pushing changes..."
    git push origin "$BRANCH_NAME" || {
        echo "⚠️  Auto-push failed, but continuing..."
    }
fi

echo "✅ Post-commit actions completed successfully!"
