#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Autonomous Post-commit System Starting..."

# Set environment variables for autonomous operation
export AUTONOMOUS_MODE=true
export HUSKY_AUTOMATION=true
export POST_COMMIT_MODE=true

# Get commit information
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%B)
BRANCH_NAME=$(git branch --show-current)

echo "ğŸ“ Commit: $COMMIT_HASH"
echo "ğŸ’¬ Message: $COMMIT_MESSAGE"
echo "ğŸŒ¿ Branch: $BRANCH_NAME"

# Run autonomous post-commit actions
echo "ğŸ¤– Running autonomous post-commit actions..."

# 1. Update commit metadata
echo "ğŸ“Š Updating commit metadata..."
node automation/enhanced-automation-system.js update-commit-metadata "$COMMIT_HASH" "$COMMIT_MESSAGE" || {
    echo "âš ï¸  Failed to update commit metadata"
}

# 2. Trigger autonomous improvements
echo "ğŸ”„ Triggering autonomous improvements..."
node automation/enhanced-automation-system.js post-commit-improvements || {
    echo "âš ï¸  Autonomous improvements failed"
}

# 3. Update documentation
echo "ğŸ“š Updating documentation..."
node automation/enhanced-automation-system.js update-docs || {
    echo "âš ï¸  Documentation update failed"
}

# 4. Generate commit report
echo "ğŸ“‹ Generating commit report..."
node automation/enhanced-automation-system.js generate-commit-report "$COMMIT_HASH" || {
    echo "âš ï¸  Failed to generate commit report"
}

# 5. Prepare for deployment (if on main branch)
if [ "$BRANCH_NAME" = "main" ]; then
    echo "ğŸš€ Preparing for deployment (main branch detected)..."
    node automation/enhanced-automation-system.js prepare-deployment || {
        echo "âš ï¸  Deployment preparation failed"
    }
fi

# 6. Update automation status
echo "ğŸ¤– Updating automation status..."
node automation/enhanced-automation-system.js update-status || {
    echo "âš ï¸  Failed to update automation status"
}

echo "âœ… Post-commit actions completed successfully!"