#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Enhanced Post-commit System Starting..."

# Set environment variables for autonomous operation
export AUTONOMOUS_MODE=true
export HUSKY_AUTOMATION=true
export POST_COMMIT_MODE=true

# Load configuration
CONFIG_FILE="automation/config.json"
if [ -f "$CONFIG_FILE" ]; then
    echo "ğŸ“‹ Loading configuration from $CONFIG_FILE"
    # Extract auto-push setting from config
    AUTO_PUSH_ENABLED=$(node -e "
        try {
            const config = JSON.parse(require('fs').readFileSync('$CONFIG_FILE', 'utf8'));
            console.log(config.automation?.autoPush?.enabled || false);
        } catch (e) {
            console.log('false');
        }
    ")
else
    echo "âš ï¸  Configuration file not found, using defaults"
    AUTO_PUSH_ENABLED=false
fi

# Get commit information
COMMIT_HASH=$(git rev-parse HEAD)
COMMIT_MESSAGE=$(git log -1 --pretty=%B)
BRANCH_NAME=$(git branch --show-current)

echo "ğŸ“ Commit: $COMMIT_HASH"
echo "ğŸ’¬ Message: $COMMIT_MESSAGE"
echo "ğŸŒ¿ Branch: $BRANCH_NAME"
echo "ğŸš€ Auto-push enabled: $AUTO_PUSH_ENABLED"

# Run autonomous post-commit actions
echo "ğŸ¤– Running autonomous post-commit actions..."

# 1. Update commit metadata
echo "ğŸ“Š Updating commit metadata..."
if [ -f "automation/enhanced-automation-system.js" ]; then
    node automation/enhanced-automation-system.js update-commit-metadata "$COMMIT_HASH" "$COMMIT_MESSAGE" || {
        echo "âš ï¸  Failed to update commit metadata"
    }
fi

# 2. Trigger autonomous improvements
echo "ğŸ”„ Triggering autonomous improvements..."
if [ -f "automation/enhanced-automation-system.js" ]; then
    node automation/enhanced-automation-system.js post-commit || {
        echo "âš ï¸  Autonomous improvements failed, but continuing..."
    }
fi

# 3. Enhanced autonomous commit system
echo "ğŸ¤– Running enhanced autonomous commit system..."
if [ -f "automation/enhanced-autonomous-commit.js" ]; then
    node automation/enhanced-autonomous-commit.js || {
        echo "âš ï¸  Enhanced autonomous commit failed, but continuing..."
    }
fi

# 4. Auto-push if configured
if [ "$AUTO_PUSH_ENABLED" = "true" ]; then
    echo "ğŸš€ Auto-pushing changes..."
    git push origin "$BRANCH_NAME" || {
        echo "âš ï¸  Auto-push failed, but continuing..."
    }
else
    echo "â¸ï¸  Auto-push is disabled in configuration"
fi

# 5. Performance monitoring
echo "ğŸ“ˆ Performance monitoring..."
if [ -f "automation/performance/performance-check.js" ]; then
    node automation/performance/performance-check.js post-commit || {
        echo "âš ï¸  Performance monitoring failed, but continuing..."
    }
fi

# 6. Generate commit report
echo "ğŸ“‹ Generating commit report..."
if [ -f "automation/enhanced-automation-system.js" ]; then
    node automation/enhanced-automation-system.js generate-commit-report "$COMMIT_HASH" || {
        echo "âš ï¸  Failed to generate commit report"
    }
fi

echo "âœ… Post-commit actions completed successfully!"
echo "ğŸ‰ Commit processed and ready for deployment!"