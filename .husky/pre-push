#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Enhanced Pre-push System Starting..."

# Set environment variables for autonomous operation
export AUTONOMOUS_MODE=true
export HUSKY_AUTOMATION=true
export PRE_PUSH_MODE=true

# Run comprehensive pre-push checks
echo "ğŸ“‹ Running comprehensive pre-push checks..."

# 1. Final lint check
echo "ğŸ” Final lint check..."
npm run lint || {
    echo "âŒ Linting issues found, please fix before pushing"
    exit 1
}

# 2. Final type check
echo "ğŸ” Final type check..."
npm run type-check || {
    echo "âŒ Type errors found, please fix before pushing"
    exit 1
}

# 3. Run all tests with coverage
echo "ğŸ§ª Running comprehensive tests..."
npm run test:coverage || {
    echo "âŒ Tests failed, please fix before pushing"
    exit 1
}

# 4. Check bundle size
echo "ğŸ“¦ Checking bundle size..."
npm run build && npx next-bundle-analyzer || {
    echo "âš ï¸  Bundle analysis failed, but continuing..."
}

# 5. Security audit
echo "ğŸ”’ Security audit..."
npm audit --audit-level=high || {
    echo "âŒ High severity security vulnerabilities found"
    exit 1
}

# 6. Performance check
echo "âš¡ Performance check..."
node automation/performance/performance-check.js || {
    echo "âš ï¸  Performance check failed, but continuing..."
}

# 7. Autonomous deployment preparation
echo "ğŸ¤– Preparing for autonomous deployment..."
node automation/enhanced-automation-system.js pre-push || {
    echo "âš ï¸  Deployment preparation failed, but continuing..."
}

# 8. Check for sensitive data
echo "ğŸ” Checking for sensitive data..."
node automation/security/check-sensitive-data.js || {
    echo "âŒ Sensitive data detected, please remove before pushing"
    exit 1
}

echo "âœ… Pre-push checks completed successfully!"
echo "ğŸš€ Ready to push to repository!"
