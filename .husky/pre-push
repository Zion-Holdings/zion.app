#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 Enhanced Pre-push System Starting..."

# Set environment variables for autonomous operation
export AUTONOMOUS_MODE=true
export HUSKY_AUTOMATION=true
export PRE_PUSH_MODE=true

# Run comprehensive pre-push checks
echo "📋 Running comprehensive pre-push checks..."

# 1. Final lint check
echo "🔍 Final lint check..."
npm run lint || {
    echo "❌ Linting issues found, please fix before pushing"
    exit 1
}

# 2. Final type check
echo "🔍 Final type check..."
npm run type-check || {
    echo "❌ Type errors found, please fix before pushing"
    exit 1
}

# 3. Run all tests with coverage
echo "🧪 Running comprehensive tests..."
npm run test:coverage || {
    echo "❌ Tests failed, please fix before pushing"
    exit 1
}

# 4. Check bundle size
echo "📦 Checking bundle size..."
npm run build && npx next-bundle-analyzer || {
    echo "⚠️  Bundle analysis failed, but continuing..."
}

# 5. Security audit
echo "🔒 Security audit..."
npm audit --audit-level=high || {
    echo "❌ High severity security vulnerabilities found"
    exit 1
}

# 6. Performance check
echo "⚡ Performance check..."
node automation/performance/performance-check.js || {
    echo "⚠️  Performance check failed, but continuing..."
}

# 7. Autonomous deployment preparation
echo "🤖 Preparing for autonomous deployment..."
node automation/enhanced-automation-system.js pre-push || {
    echo "⚠️  Deployment preparation failed, but continuing..."
}

# 8. Check for sensitive data
echo "🔐 Checking for sensitive data..."
node automation/security/check-sensitive-data.js || {
    echo "❌ Sensitive data detected, please remove before pushing"
    exit 1
}

echo "✅ Pre-push checks completed successfully!"
echo "🚀 Ready to push to repository!"
