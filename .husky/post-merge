#!/usr/bin/env sh
set -e

echo "ðŸ”„ Post-merge actions running..."

# Update dependencies if package files changed
if git diff HEAD@{1} --name-only | grep -E "package\.json|package-lock\.json" > /dev/null; then
    echo "ðŸ“¦ Package files changed, updating dependencies..."
    npm install
fi

# Clear build cache if needed
if git diff HEAD@{1} --name-only | grep -E "next\.config\.js|tsconfig\.json|tailwind\.config\.js" > /dev/null; then
    echo "ðŸ§¹ Clearing build cache..."
    rm -rf .next 2>/dev/null || true
fi

# Run type check to ensure everything is still working
echo "ðŸ” Running type check after merge..."
npm run type-check || {
    echo "âš ï¸  Type check failed after merge. Please review changes."
}

# Run fast git health check
node automation/git-health.cjs --fast --fix || true

# Start background git sync loops
(command -v npm >/dev/null 2>&1 && npm run --silent git:cron:start >/dev/null 2>&1 || true)

# Start core automations (non-blocking)
(npm run --silent automation:all >/dev/null 2>&1 &) || true

# Kick a quick sync
(npm run --silent git:sync >/dev/null 2>&1 &) || true

echo "âœ… Post-merge actions completed" 