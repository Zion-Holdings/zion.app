#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Enhanced Pre-commit System Starting..."

# Set environment variables for autonomous operation
export AUTONOMOUS_MODE=true
export HUSKY_AUTOMATION=true
export AUTO_FIX_ENABLED=true

# Load configuration
CONFIG_FILE="automation/config.json"
if [ -f "$CONFIG_FILE" ]; then
    echo "ğŸ“‹ Loading configuration from $CONFIG_FILE"
else
    echo "âš ï¸  Configuration file not found, using defaults"
fi

# Run comprehensive pre-commit checks
echo "ğŸ“‹ Running comprehensive pre-commit checks..."

# 1. Lint and auto-fix
echo "ğŸ” Linting and auto-fixing..."
npm run lint || {
    echo "âš ï¸  Linting issues found, attempting auto-fix..."
    npm run lint -- --fix || {
        echo "âŒ Linting failed and could not be auto-fixed"
        exit 1
    }
}

# 2. Type checking
echo "ğŸ” Type checking..."
npm run type-check || {
    echo "âŒ Type checking failed"
    exit 1
}

# 3. Format code
echo "ğŸ¨ Formatting code..."
npm run format || {
    echo "âŒ Code formatting failed"
    exit 1
}

# 4. Run tests
echo "ğŸ§ª Running tests..."
npm test || {
    echo "âŒ Tests failed"
    exit 1
}

# 5. Check for security vulnerabilities
echo "ğŸ”’ Security check..."
npm audit --audit-level=moderate || {
    echo "âš ï¸  Security vulnerabilities found, but continuing..."
}

# 6. Build check
echo "ğŸ—ï¸  Build check..."
npm run build || {
    echo "âŒ Build failed"
    exit 1
}

# 7. Performance check
echo "âš¡ Performance check..."
if [ -f "automation/performance/performance-check.js" ]; then
    node automation/performance/performance-check.js || {
        echo "âš ï¸  Performance check failed, but continuing..."
    }
fi

# 8. Autonomous improvements
echo "ğŸ¤– Running autonomous improvements..."
if [ -f "automation/enhanced-automation-system.js" ]; then
    node automation/enhanced-automation-system.js pre-commit || {
        echo "âš ï¸  Autonomous improvements failed, but continuing..."
    }
fi

# 9. Enhanced autonomous commit system
echo "ğŸ¤– Running enhanced autonomous commit system..."
if [ -f "automation/enhanced-autonomous-commit.js" ]; then
    node automation/enhanced-autonomous-commit.js || {
        echo "âš ï¸  Enhanced autonomous commit failed, but continuing..."
    }
fi

echo "âœ… Pre-commit checks completed successfully!"
echo "ğŸ‰ Your code is ready for commit!"