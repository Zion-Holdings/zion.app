#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "🚀 Enhanced Pre-commit System Starting..."

# Set environment variables for autonomous operation
export AUTONOMOUS_MODE=true
export HUSKY_AUTOMATION=true
export AUTO_FIX_ENABLED=true

# Load configuration
CONFIG_FILE="automation/config.json"
if [ -f "$CONFIG_FILE" ]; then
    echo "📋 Loading configuration from $CONFIG_FILE"
else
    echo "⚠️  Configuration file not found, using defaults"
fi

# Run comprehensive pre-commit checks
echo "📋 Running comprehensive pre-commit checks..."

# 1. Lint and auto-fix
echo "🔍 Linting and auto-fixing..."
npm run lint || {
    echo "⚠️  Linting issues found, attempting auto-fix..."
    npm run lint -- --fix || {
        echo "❌ Linting failed and could not be auto-fixed"
        exit 1
    }
}

# 2. Type checking
echo "🔍 Type checking..."
npm run type-check || {
    echo "❌ Type checking failed"
    exit 1
}

# 3. Format code
echo "🎨 Formatting code..."
npm run format || {
    echo "❌ Code formatting failed"
    exit 1
}

# 4. Run tests
echo "🧪 Running tests..."
npm test || {
    echo "❌ Tests failed"
    exit 1
}

# 5. Check for security vulnerabilities
echo "🔒 Security check..."
npm audit --audit-level=moderate || {
    echo "⚠️  Security vulnerabilities found, but continuing..."
}

# 6. Build check
echo "🏗️  Build check..."
npm run build || {
    echo "❌ Build failed"
    exit 1
}

# 7. Performance check
echo "⚡ Performance check..."
if [ -f "automation/performance/performance-check.js" ]; then
    node automation/performance/performance-check.js || {
        echo "⚠️  Performance check failed, but continuing..."
    }
fi

# 8. Autonomous improvements
echo "🤖 Running autonomous improvements..."
if [ -f "automation/enhanced-automation-system.js" ]; then
    node automation/enhanced-automation-system.js pre-commit || {
        echo "⚠️  Autonomous improvements failed, but continuing..."
    }
fi

# 9. Enhanced autonomous commit system
echo "🤖 Running enhanced autonomous commit system..."
if [ -f "automation/enhanced-autonomous-commit.js" ]; then
    node automation/enhanced-autonomous-commit.js || {
        echo "⚠️  Enhanced autonomous commit failed, but continuing..."
    }
fi

echo "✅ Pre-commit checks completed successfully!"
echo "🎉 Your code is ready for commit!"