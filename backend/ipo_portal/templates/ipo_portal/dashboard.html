{% extends "ipo_portal/base_portal.html" %}
{% load i18n %}

{% block title %}{% trans "Dashboard" %} - IPO Portal{% endblock %}

{% block page_title %}{{ page_title|default:"Dashboard" }}{% endblock %}

{% block content %}
<p>{% trans "Welcome to the IPO Portal Dashboard." %}</p>

<h3>{% trans "Monthly KPIs Overview" %}</h3>
{% if monthly_kpis_desc %}
    <div style="overflow-x: auto;">
        <table border="1" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
            <thead>
                <tr>
                    <th>{% trans "Month" %}</th>
                    <th>{% trans "MRR" %}</th>
                    <th>{% trans "GMV" %}</th>
                    <th>{% trans "Active Users" %}</th>
                    <th>{% trans "Churn Rate (%)" %}</th>
                    <th>{% trans "CAC" %}</th>
                    <th>{% trans "LTV" %}</th>
                    <th>{% trans "Retention Data" %}</th>
                    <th>{% trans "User Breakdown" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for kpi in monthly_kpis_desc %}
                <tr>
                    <td>{{ kpi.month|date:"Y-m" }}</td>
                    <td>{{ kpi.mrr }}</td>
                    <td>{{ kpi.gmv }}</td>
                    <td>{{ kpi.active_users_monthly }}</td>
                    <td>{{ kpi.churn_rate }}</td>
                    <td>{{ kpi.cac }}</td>
                    <td>{{ kpi.ltv }}</td>
                    <td><pre>{{ kpi.retention_cohort_data|default:"N/A" }}</pre></td>
                    <td><pre>{{ kpi.global_user_breakdown|default:"N/A" }}</pre></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p>{% trans "No Monthly KPI data available yet." %}</p>
{% endif %}

<hr>
<h3>{% trans "Visualizations (Placeholders)" %}</h3>
<div style="display: flex; flex-wrap: wrap; gap: 20px;">
    <div style="width: 400px; height: 300px; border: 1px solid #ccc; padding: 10px;">
        <h4>{% trans "MRR Over Time" %}</h4>
        <canvas id="mrrChart"></canvas>
    </div>
    <div style="width: 400px; height: 300px; border: 1px solid #ccc; padding: 10px;">
        <h4>{% trans "Active Users Over Time" %}</h4>
        <canvas id="activeUsersChart"></canvas>
    </div>
    <div style="width: 400px; height: 300px; border: 1px solid #ccc; padding: 10px;">
        <h4>{% trans "LTV vs CAC" %}</h4>
        <canvas id="ltvCacChart"></canvas>
    </div>
    <div style="width: 400px; height: 300px; border: 1px solid #ccc; padding: 10px;">
        <h4>{% trans "Churn Rate (%)" %}</h4>
        <canvas id="churnRateChart"></canvas>
    </div>
</div>

<hr style="margin-top: 30px; margin-bottom: 30px;">

<h3>{% trans "Latest Month's Detailed Data" %}</h3>
{% if latest_kpi %}
<div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px;">
    <div style="flex: 1; min-width: 300px; border: 1px solid #eee; padding: 15px; background-color: #fdfdfd; border-radius: 5px;">
        <h4>{% trans "Retention Cohort Data" %} ({{ latest_kpi.month|date:"Y-m" }})</h4>
        {% if latest_kpi.retention_cohort_data %}
            <pre style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto; background-color: #f0f0f0; padding:10px; border-radius:4px;">{{ latest_kpi.retention_cohort_data }}</pre>
        {% else %}
            <p>{% trans "No retention data available for the latest month." %}</p>
        {% endif %}
    </div>
    <div style="flex: 1; min-width: 300px; border: 1px solid #eee; padding: 15px; background-color: #fdfdfd; border-radius: 5px;">
        <h4>{% trans "Global User Breakdown" %} ({{ latest_kpi.month|date:"Y-m" }})</h4>
        {% if latest_kpi.global_user_breakdown %}
            <pre style="white-space: pre-wrap; word-wrap: break-word; max-height: 300px; overflow-y: auto; background-color: #f0f0f0; padding:10px; border-radius:4px;">{{ latest_kpi.global_user_breakdown }}</pre>
        {% else %}
            <p>{% trans "No global user breakdown available for the latest month." %}</p>
        {% endif %}
    </div>
</div>
{% else %}
    <p>{% trans "No data available for the latest month's detailed cards." %}</p>
{% endif %}


<script>
document.addEventListener('DOMContentLoaded', function () {
    const kpiDataAsc = {{ monthly_kpis_asc|safe }}; // Assuming this is how you pass data if not directly in loops

    // Example: MRR Chart
    const mrrCtx = document.getElementById('mrrChart').getContext('2d');
    if (mrrCtx) {
        new Chart(mrrCtx, {
            type: 'line',
            data: {
                labels: [{% for kpi in monthly_kpis_asc %}"{{ kpi.month|date:"Y-m" }}",{% endfor %}],
                datasets: [{
                    label: '{% trans "MRR" %}',
                    data: [{% for kpi in monthly_kpis_asc %}{{ kpi.mrr }},{% endfor %}],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
    }

    // Active Users Chart
    const activeUsersCtx = document.getElementById('activeUsersChart').getContext('2d');
    if (activeUsersCtx) {
         new Chart(activeUsersCtx, {
            type: 'bar',
            data: {
                labels: [{% for kpi in monthly_kpis_asc %}"{{ kpi.month|date:"Y-m" }}",{% endfor %}],
                datasets: [{
                    label: '{% trans "Monthly Active Users" %}',
                    data: [{% for kpi in monthly_kpis_asc %}{{ kpi.active_users_monthly }},{% endfor %}],
                    backgroundColor: 'rgba(54, 162, 235, 0.6)',
                    borderColor: 'rgba(54, 162, 235, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // LTV vs CAC Chart
    const ltvCacCtx = document.getElementById('ltvCacChart').getContext('2d');
    if (ltvCacCtx) {
        new Chart(ltvCacCtx, {
            type: 'bar',
            data: {
                labels: [{% for kpi in monthly_kpis_asc %}"{{ kpi.month|date:"Y-m" }}",{% endfor %}],
                datasets: [
                    {
                        label: '{% trans "LTV" %}',
                        data: [{% for kpi in monthly_kpis_asc %}{{ kpi.ltv }},{% endfor %}],
                        backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    },
                    {
                        label: '{% trans "CAC" %}',
                        data: [{% for kpi in monthly_kpis_asc %}{{ kpi.cac }},{% endfor %}],
                        backgroundColor: 'rgba(255, 99, 132, 0.6)',
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    // Churn Rate Chart
    const churnRateCtx = document.getElementById('churnRateChart').getContext('2d');
    if (churnRateCtx) {
        new Chart(churnRateCtx, {
            type: 'line',
            data: {
                labels: [{% for kpi in monthly_kpis_asc %}"{{ kpi.month|date:"Y-m" }}",{% endfor %}],
                datasets: [{
                    label: '{% trans "Churn Rate (%)" %}',
                    data: [{% for kpi in monthly_kpis_asc %}{{ kpi.churn_rate }},{% endfor %}],
                    borderColor: 'rgb(255, 159, 64)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: { y: { beginAtZero: true } }
            }
        });
    }
});
</script>
{% endblock %}
