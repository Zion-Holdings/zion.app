<<<<<<< HEAD
=======
<<<<<<< HEAD
import { useFavorites } from '@/hooks/useFavorites';
import { X } from 'lucide-react';

import { MARKETPLACE_LISTINGS } from '@/data/marketplaceData';
import { TALENT_PROFILES } from '@/data/talentData';
import { ProductListingCard } from '@/components/ProductListingCard';
import { TalentCard } from '@/components/talent/TalentCard';
import { Button } from '@/components/ui/button';
import { useCart } from '@/context/CartContext';
import { toast } from '@/hooks/use-toast';
import { useAuth } from '@/hooks/useAuth';
import { useRouter } from 'next/router'; // Changed from useNavigate
import { useEffect } from 'react'; // Added useEffect
import type { ProductListing } from '@/types/listings';
import type { TalentProfile } from '@/types/talent';

export default function WishlistPage() {
  const { favorites, loading, toggleFavorite } = useFavorites();
  const { user, isLoading: isAuthLoading } = useAuth(); // Added isAuthLoading
  const router = useRouter(); // Changed from navigate
  const { items, dispatch } = useCart();

  useEffect(() => {
    // Redirect if not authenticated and auth loading is complete
    if (!isAuthLoading && !user) {
      router.push('/login');
    }
  }, [user, isAuthLoading, router]);

  if (isAuthLoading || !user) { // Show loading or null while auth check or redirect happens
    return null; // Or a loading spinner
  }

  const addToCart = (item: ProductListing) => {
    if (items.some(i => i.id === item.id)) return;
    dispatch({
      type: 'ADD_ITEM',
      payload: {
        id: item.id,
        name: item.title || 'Item',
        price: item.price || 0,
        quantity: 1
      }
    });
    toast.success(`1Ã— ${item.title || 'Item'} added`);
  };

  const productMap = MARKETPLACE_LISTINGS.reduce<Record<string, ProductListing>>((acc, p) => {
    acc[p.id] = p;
    return acc;
  }, {});
  const talentMap = TALENT_PROFILES.reduce<Record<string, TalentProfile>>((acc, t) => {
    acc[t.id] = t;
    return acc;
  }, {});

  const sortedFavorites = [...favorites].sort(
    (a, b) =>
      new Date(b.created_at || '').getTime() -
      new Date(a.created_at || '').getTime()
  );

  return (
    <div className="container py-8">
      <h1 className="text-3xl font-bold mb-6">Wishlist</h1>
      {loading ? (
        <p>Loading...</p>
      ) : favorites.length === 0 ? (
        <p>No items saved.</p>
      ) : (
        <div className="responsive-grid">
          {sortedFavorites.map(fav => {
            if (fav.item_type === 'talent') {
              const talent = talentMap[fav.item_id];
              return talent ? (
                <div key={fav.item_id} className="relative">
                  <button
                    aria-label="Remove from favorites"
                    className="absolute top-2 right-2 z-10 rounded-full bg-zion-blue-dark/80 p-1 hover:bg-zion-purple/80"
                    onClick={() => toggleFavorite('talent', fav.item_id)}
                  >
                    <X className="h-4 w-4" />
                  </button>
                  <TalentCard
                    talent={talent}
                    onViewProfile={() => {}}
                    onRequestHire={() => {}}
                    isAuthenticated={true}
                  />
                  {fav.created_at && (
                    <p className="mt-1 text-xs text-muted-foreground">
                      Saved {new Date(fav.created_at).toLocaleDateString()}
                    </p>
                  )}
                </div>
              ) : null;
            }
            const item = productMap[fav.item_id];
            return item ? (
              <div key={fav.item_id} className="relative">
                <button
                  aria-label="Remove from favorites"
                  className="absolute top-2 right-2 z-10 rounded-full bg-zion-blue-dark/80 p-1 hover:bg-zion-purple/80"
                  onClick={() => toggleFavorite(fav.item_type, fav.item_id)}
                >
                  <X className="h-4 w-4" />
                </button>
                <ProductListingCard listing={item} />
                <Button
                  size="sm"
                  className="absolute bottom-2 right-2"
                  onClick={() => addToCart(item)}
                  disabled={items.some(i => i.id === item.id)}
                >
                  {items.some(i => i.id === item.id) ? 'In Cart' : 'Add to Cart'}
                </Button>
                {fav.created_at && (
                  <p className="mt-1 text-xs text-muted-foreground">
                    Saved {new Date(fav.created_at).toLocaleDateString()}
                  </p>
                )}
              </div>
            ) : null;
          })}
        </div>
=======
>>>>>>> origin/cursor/website-audit-and-enhancement-63e3
import { useEffect } from 'react';
import { useAppDispatch, useAppSelector } from '@/store/hooks';
import { loadWishlistFromDB, removeFromWishlist, getApiUrl } from '@/store/wishlistSlice';
import { useAuth } from '@/hooks/useAuth';
import { Button } from '@/components/ui/button';
import { Link, useNavigate, useLocation } from 'react-router-dom';

export default function Wishlist() {
  const dispatch = useAppDispatch();
  const items = useAppSelector((s) => s.wishlist.items);
  const { user } = useAuth();
  const navigate = useNavigate();
  const location = useLocation();

  useEffect(() => {
    if (!user) {
      navigate(`/login?next=${encodeURIComponent(location.pathname)}`);
      return;
    }
    void dispatch(loadWishlistFromDB(user.id!));
  }, [user, dispatch, navigate, location]);

  const handleRemove = (id: string) => {
    dispatch(removeFromWishlist({ id }));
    fetch(`${getApiUrl()}/wishlist/${id}`, { method: 'DELETE' }).catch(() => {});
  };

  const pathForItem = (item: { id: string; type: string }) => {
    switch (item.type) {
      case 'product':
        return `/marketplace/listing/${item.id}`;
      case 'service':
        return `/services/${item.id}`;
      case 'talent':
        return `/talent/${item.id}`;
      default:
        return '#';
    }
  };

  return (
    <div className="container mx-auto px-4 py-8">
      <h1 className="text-3xl font-bold mb-4">Your Wishlist</h1>
      {items.length === 0 ? (
        <p>No items saved.</p>
      ) : (
        <ul className="space-y-4">
          {items.map((item) => (
            <li key={`${item.type}-${item.id}`} className="border border-zion-blue-light p-4 rounded-lg flex justify-between items-center">
              <div>{item.data?.title || item.data?.full_name || item.id}</div>
              <div className="flex gap-2">
                <Link to={pathForItem(item)} className="text-zion-cyan underline">
                  Go to item
                </Link>
                <Button size="sm" variant="outline" onClick={() => handleRemove(item.id)}>
                  Remove
                </Button>
              </div>
            </li>
          ))}
        </ul>
<<<<<<< HEAD
=======
>>>>>>> origin/5yaxyc-codex/implement-wishlist-functionality
>>>>>>> origin/cursor/website-audit-and-enhancement-63e3
      )}
    </div>
  );
}
