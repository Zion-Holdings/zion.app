import type { NextApiRequest, NextApiResponse } from 'next';
<<<<<<< HEAD
import { createNation, loadAllNations, GovernanceStyle, FundingModel, NationCurrency } from '../../../lib/nations';

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method === 'GET') {
    const nations = loadAllNations();
=======
import { v4 as uuidv4 } from 'uuid';
// Fallback slugify to avoid extra dep if unavailable
function toSlug(input: string) {
  return (input || '')
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '')
    .trim()
    .replace(/\s+/g, '-')
    .replace(/-+/g, '-');
}
import { Nation } from '../../../types/nation';
import { readAllNations, upsertNation } from '../../../utils/nationStore';

export default function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method === 'GET') {
    const nations = readAllNations();
>>>>>>> origin/cursor/build-digital-nation-creation-module-57e8
    return res.status(200).json({ nations });
  }

  if (req.method === 'POST') {
<<<<<<< HEAD
    try {
      const { name, flagDataUrl, constitution, governanceStyle, fundingModel, currency } = req.body || {};

      if (!name || !constitution || !governanceStyle || !fundingModel) {
        return res.status(400).json({ error: 'Missing required fields' });
      }

      const nation = createNation({
        name,
        flagDataUrl,
        constitution,
        governanceStyle: governanceStyle as GovernanceStyle,
        fundingModel: fundingModel as FundingModel,
        currency: (currency as NationCurrency) || 'ZION$',
      });

      return res.status(201).json({ nation });
    } catch (error: any) {
      return res.status(500).json({ error: error?.message || 'Failed to create nation' });
    }
  }

  return res.status(405).json({ error: 'Method not allowed' });
=======
    const { name, flagDataUrl, constitution, governanceStyle, fundingModel, currency } = req.body || {};
    if (!name || !governanceStyle || !fundingModel) {
      return res.status(400).json({ error: 'Missing required fields' });
    }
    const id = uuidv4();
    const slug = toSlug(name);
    const now = new Date().toISOString();
    const nation: Nation = {
      id,
      slug,
      name,
      flagDataUrl,
      constitution: constitution || '',
      governanceStyle,
      fundingModel,
      currency: currency || 'ZION$',
      population: 0,
      talentCount: 0,
      clientCount: 0,
      milestones: [],
      proposals: [],
      createdAt: now,
      updatedAt: now,
    };
    upsertNation(nation);
    return res.status(201).json({ nation });
  }

  res.setHeader('Allow', ['GET', 'POST']);
  return res.status(405).end('Method Not Allowed');
>>>>>>> origin/cursor/build-digital-nation-creation-module-57e8
}