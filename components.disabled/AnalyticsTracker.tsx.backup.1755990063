import React, { useEffect, useState } from 'react';
import { motion } from 'framer-motion';
import { BarChart3 } from 'lucide-react';

<<<<<<< HEAD
const AnalyticsTracker: React.FC = () => {
  const router = useRouter();

  // Helper function to track metrics
  const trackMetric = (name: string, value: number | string) => {
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('event', 'custom_metric', {
        metric_name: name,
        metric_value: value,
        timestamp: Date.now()
      });
    }

    // Send to custom analytics endpoint
    if (process.env.NODE_ENV === 'production') {
      fetch('/api/analytics/metrics', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name,
          value,
          timestamp: Date.now(),
          url: window.location.href,
          userAgent: navigator.userAgent
        })
      }).catch(() => {
        // Silently handle fetch errors
      });
    }
  };

  // Helper function to track events
  const trackEvent = (action: string, parameters: Record<string, unknown>) => {
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('event', action, {
        ...parameters,
        timestamp: Date.now(),
        page_url: window.location.href
      });
    }

    // Send to custom analytics endpoint
    if (process.env.NODE_ENV === 'production') {
      fetch('/api/analytics/events', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action,
          parameters,
          timestamp: Date.now(),
          url: window.location.href,
          userAgent: navigator.userAgent
        })
      }).catch(() => {
        // Silently handle fetch errors
      });
    }
  };

  useEffect(() => {
    // User interaction tracking
    let interactionCount = 0;
    const trackInteraction = () => {
      interactionCount++;
      if (interactionCount === 1) {
        trackMetric('FirstInteraction', Date.now() - (performance.timing?.navigationStart || Date.now()));
      }
    };

    // Viewport tracking
    const trackViewport = () => {
      trackMetric('ViewportWidth', window.innerWidth);
      trackMetric('ViewportHeight', window.innerHeight);
      trackMetric('PixelRatio', window.devicePixelRatio || 1);
    };

    // Initialize analytics and performance monitoring
    const initAnalytics = () => {
      // Google Analytics 4 initialization
      if (typeof window !== 'undefined' && window.gtag) {
        window.gtag('config', 'G-XXXXXXXXXX', {
          page_title: document.title,
          page_location: window.location.href,
          custom_map: {
            dimension1: 'user_type',
            dimension2: 'service_category',
            dimension3: 'page_performance'
          }
        });
      }

      // Performance monitoring
      if ('performance' in window) {
        // Core Web Vitals monitoring
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.entryType === 'largest-contentful-paint') {
              // Track LCP
              trackMetric('LCP', entry.startTime);
            } else if (entry.entryType === 'first-input') {
              // Track FID - cast to proper type
              const firstInputEntry = entry as PerformanceEventTiming;
              trackMetric('FID', firstInputEntry.processingStart - firstInputEntry.startTime);
            } else if (entry.entryType === 'layout-shift') {
              // Track CLS - cast to proper type
              const layoutShiftEntry = entry as LayoutShift;
              trackMetric('CLS', layoutShiftEntry.value);
            }
          }
        });

        try {
          observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input', 'layout-shift'] });
        } catch {
          // Fallback for older browsers
        }

        // Track page load performance
        window.addEventListener('load', () => {
          setTimeout(() => {
            const navigation = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
            if (navigation) {
              trackMetric('TTFB', navigation.responseStart - navigation.requestStart);
              trackMetric('DOMContentLoaded', navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart);
              trackMetric('LoadComplete', navigation.loadEventEnd - navigation.loadEventStart);
            }

            // Track resource loading performance
            const resources = performance.getEntriesByType('resource');
            const slowResources = resources.filter((resource) => (resource as any).duration > 1000);
            if (slowResources.length > 0) {
              trackMetric('SlowResources', slowResources.length);
            }
          }, 0);
        });
      }

      // Add event listeners
      document.addEventListener('click', trackInteraction);
      document.addEventListener('scroll', trackInteraction);
      document.addEventListener('keydown', trackInteraction);

      // Error tracking
      window.addEventListener('error', (event) => {
        trackEvent('Error', {
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          error: event.error?.stack
        });
      });

      // Unhandled promise rejection tracking
      window.addEventListener('unhandledrejection', (event) => {
        trackEvent('UnhandledRejection', {
          reason: event.reason,
          promise: event.promise
        });
      });

      // Network status monitoring
      if ('navigator' in window && 'connection' in navigator) {
        const connection = (navigator as any).connection;
        if (connection) {
          trackMetric('ConnectionType', connection.effectiveType || 'unknown');
          trackMetric('ConnectionDownlink', connection.downlink || 0);
          trackMetric('ConnectionRTT', connection.rtt || 0);
        }
      }

      // Memory usage monitoring (if available)
      if ('memory' in performance) {
        const memory = (performance as any).memory;
        if (memory) {
          setInterval(() => {
            trackMetric('MemoryUsage', memory.usedJSHeapSize / 1024 / 1024); // MB
            trackMetric('MemoryLimit', memory.jsHeapSizeLimit / 1024 / 1024); // MB
          }, 30000); // Every 30 seconds
        }
      }

      // Battery status monitoring (if available)
      if ('getBattery' in navigator) {
        (navigator as any).getBattery().then((battery: any) => {
          trackMetric('BatteryLevel', battery.level * 100);
          trackMetric('BatteryCharging', battery.charging ? 1 : 0);
        });
      }

      // Device capabilities tracking
      trackMetric('DeviceMemory', (navigator as any).deviceMemory || 0);
      trackMetric('HardwareConcurrency', navigator.hardwareConcurrency || 0);
      trackMetric('MaxTouchPoints', navigator.maxTouchPoints || 0);
      trackMetric('UserAgent', navigator.userAgent.length);

      // Viewport tracking
      trackViewport();
      window.addEventListener('resize', trackViewport);

      // Page visibility tracking
      let hiddenTime = 0;
      let startTime = Date.now();
      
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          hiddenTime = Date.now();
        } else {
          const visibleTime = Date.now() - hiddenTime;
          if (hiddenTime > 0) {
            trackMetric('PageHiddenDuration', visibleTime);
          }
          startTime = Date.now();
        }
      });

      // Session duration tracking
      setInterval(() => {
        const sessionDuration = Date.now() - startTime;
        trackMetric('SessionDuration', sessionDuration);
      }, 60000); // Every minute
    };

    // Initialize when component mounts
    initAnalytics();

    // Cleanup function
    return () => {
      // Remove event listeners if needed
      document.removeEventListener('click', trackInteraction);
      document.removeEventListener('scroll', trackInteraction);
      document.removeEventListener('keydown', trackInteraction);
      window.removeEventListener('resize', trackViewport);
    };
  }, []);

  // Track page views on route changes
  useEffect(() => {
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('config', 'G-XXXXXXXXXX', {
        page_path: router.asPath,
        page_title: document.title,
        page_location: window.location.href
      });
    }

    // Track custom page view event
    trackEvent('PageView', {
      path: router.asPath,
      title: document.title,
      referrer: document.referrer,
      timestamp: Date.now()
    });

    // Track page performance metrics
    if ('performance' in window) {
      const navigation = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
      if (navigation) {
        const startTime = navigation.startTime || 0;
        trackMetric('PageLoadTime', navigation.loadEventEnd - startTime);
        trackMetric('DOMReadyTime', navigation.domContentLoadedEventEnd - startTime);
      }
    }
  }, [router.asPath]);

  // Component doesn't render anything
  return null;
};

// Performance entry types
interface PerformanceEventTiming extends PerformanceEntry {
  processingStart: number;
  processingEnd: number;
  target?: any;
}

interface LayoutShift extends PerformanceEntry {
  value: number;
  sources?: LayoutShiftSource[];
}

interface LayoutShiftSource {
  node?: any;
  currentRect?: any;
  previousRect?: any;
}

// Extend Window interface for gtag
declare global {
  interface Window {
    gtag?: (
      command: string,
      action: string,
      params?: Record<string, unknown>
    ) => void;
=======
// Extend Window interface for Google Analytics
declare global {
  interface Window {
    dataLayer: any[];
    gtag: (...args: any[]) => void;
>>>>>>> 3d0c36eea3be5345cefaebf51a30415fed79edb9
  }
}

interface AnalyticsTrackerProps {
  trackingId?: string;
  enableDebug?: boolean;
}

const AnalyticsTracker: React.FC<AnalyticsTrackerProps> = ({ 
  trackingId = process.env.NEXT_PUBLIC_GA_ID || 'G-XXXXXXXXXX',
  enableDebug = false 
}) => {
  const router = useRouter();

  useEffect(() => {
    // Initialize Google Analytics
    if (typeof window !== 'undefined' && trackingId !== 'G-XXXXXXXXXX') {
      // Google Analytics 4
      const script = document.createElement('script');
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtag/js?id=${trackingId}`;
      document.head.appendChild(script);

      window.dataLayer = window.dataLayer || [];
      function gtag(...args: any[]) {
        window.dataLayer.push(args);
      }
      gtag('js', new Date());
      gtag('config', trackingId, {
        page_title: document.title,
        page_location: window.location.href,
      });

      // Track page views on route changes
      const handleRouteChange = (url: string) => {
        gtag('config', trackingId, {
          page_title: document.title,
          page_location: url,
        });
        
        if (enableDebug) {
          console.log('Analytics: Page view tracked:', url);
        }
      };

      router.events.on('routeChangeComplete', handleRouteChange);
      
      return () => {
        router.events.off('routeChangeComplete', handleRouteChange);
      };
    }
  }, [trackingId, router, enableDebug]);

  useEffect(() => {
    // Track user engagement metrics
    if (typeof window !== 'undefined') {
      // Google Analytics tracking
      if ((window as any).gtag) {
        (window as any).gtag('config', 'GA_MEASUREMENT_ID', {
          page_title: document.title,
          page_location: window.location.href,
        });
      }

      // Custom analytics tracking
      const trackPageView = () => {
        const pageData = {
          url: window.location.href,
          title: document.title,
          timestamp: new Date().toISOString(),
          userAgent: navigator.userAgent,
          referrer: document.referrer,
        };

        // Send to analytics endpoint (if configured)
        if (process.env.NEXT_PUBLIC_ANALYTICS_ENDPOINT) {
          fetch(process.env.NEXT_PUBLIC_ANALYTICS_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(pageData),
          }).catch(console.error);
        }

        // Store in localStorage for offline analytics
        const analytics = JSON.parse(localStorage.getItem('zionAnalytics') || '[]');
        analytics.push(pageData);
        if (analytics.length > 100) analytics.shift();
        localStorage.setItem('zionAnalytics', JSON.stringify(analytics));
      };

      trackPageView();
      window.addEventListener('popstate', trackPageView);
      return () => window.removeEventListener('popstate', trackPageView);
    }
  }, []);

  // Track user interactions
  useEffect(() => {
    if (typeof window !== 'undefined') {
      const trackInteraction = (event: Event) => {
        const target = event.target as HTMLElement;
        const interactionData = {
          type: event.type,
          element: target.tagName.toLowerCase(),
          text: target.textContent?.slice(0, 100),
          timestamp: new Date().toISOString(),
          url: window.location.href,
        };

        // Send interaction data
        if (process.env.NEXT_PUBLIC_ANALYTICS_ENDPOINT) {
          fetch(process.env.NEXT_PUBLIC_ANALYTICS_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(interactionData),
          }).catch(console.error);
        }
      };

      // Track clicks, form submissions, and scroll depth
      document.addEventListener('click', trackInteraction);
      document.addEventListener('submit', trackInteraction);
      
      let scrollDepth = 0;
      const trackScroll = () => {
        const newScrollDepth = Math.round((window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100);
        if (newScrollDepth > scrollDepth && newScrollDepth % 25 === 0) {
          scrollDepth = newScrollDepth;
          trackInteraction(new Event('scroll') as any);
        }
      };

      window.addEventListener('scroll', trackScroll);
      
      return () => {
        document.removeEventListener('click', trackInteraction);
        document.removeEventListener('submit', trackInteraction);
        window.removeEventListener('scroll', trackScroll);
      };
    }
  }, []);

  if (!isVisible) {
    return null;
  }

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.6 }}
      className="fixed bottom-4 right-4 z-50"
    >
      <div className="bg-black/90 backdrop-blur-lg border border-cyan-400/30 rounded-lg p-4 shadow-2xl max-w-sm">
        <div className="flex items-center justify-between mb-3">
          <h3 className="text-sm font-semibold text-cyan-400 flex items-center gap-2">
            <BarChart3 className="w-4 h-4" />
            Analytics
          </h3>
          <motion.button
            whileHover={{ scale: 1.1 }}
            whileTap={{ scale: 0.9 }}
            className="text-gray-400 hover:text-cyan-400 transition-colors"
            onClick={() => setIsVisible(false)}
          >
            ×
          </motion.button>
        </div>

        <div className="space-y-3">
          <div className="grid grid-cols-2 gap-3 text-xs">
            <div className="bg-gray-800/50 rounded p-2">
              <div className="text-cyan-400 font-medium">{analyticsData.pageViews.toLocaleString()}</div>
              <div className="text-gray-400">Page Views</div>
            </div>
            <div className="bg-gray-800/50 rounded p-2">
              <div className="text-purple-400 font-medium">{analyticsData.uniqueVisitors.toLocaleString()}</div>
              <div className="text-gray-400">Visitors</div>
            </div>
            <div className="bg-gray-800/50 rounded p-2">
              <div className="text-emerald-400 font-medium">{analyticsData.sessionDuration}s</div>
              <div className="text-gray-400">Avg Session</div>
            </div>
            <div className="bg-gray-800/50 rounded p-2">
              <div className="text-orange-400 font-medium">{analyticsData.conversionRate}%</div>
              <div className="text-gray-400">Conversion</div>
            </div>
          </div>

          <div className="text-xs">
            <div className="flex items-center justify-between mb-1">
              <span className="text-gray-400">Bounce Rate</span>
              <span className="text-cyan-400">{analyticsData.bounceRate}%</span>
            </div>
            <div className="w-full bg-gray-700 rounded-full h-1.5">
              <div 
                className="bg-gradient-to-r from-cyan-400 to-blue-500 h-1.5 rounded-full transition-all duration-500"
                style={{ width: `${analyticsData.bounceRate}%` }}
              ></div>
            </div>
          </div>

          <div className="text-xs">
            <div className="text-gray-400 mb-2">Top Pages</div>
            <div className="space-y-1">
              {analyticsData.topPages.slice(0, 3).map((page, index) => (
                <div key={index} className="flex items-center justify-between">
                  <span className="text-gray-300 truncate">{page.page}</span>
                  <span className="text-cyan-400">{page.views.toLocaleString()}</span>
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    </motion.div>
  );
};

export default AnalyticsTracker;