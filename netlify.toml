[build]
  # Use `npm ci` for deterministic installs
  # Generate Prisma client before building to ensure models are up to date
  command = "npm run build:netlify:prepare"
  # Netlify UI sets `publish` to `out` which causes the Next.js plugin to fail
  # because no exported directory exists. Explicitly publish the `.next`
  # directory so the plugin can run correctly.
  publish = ".next"
  # Increase build timeout for 176+ pages
  command_timeout = "30m"

[build.environment]
  NODE_OPTIONS = "--no-deprecation --max-old-space-size=6144 --no-warnings"
  NPM_FLAGS = "--prefer-offline --legacy-peer-deps"
  NEXT_PUBLIC_APP_ENV = "production"
  NODE_VERSION = "22"
  NEXT_TELEMETRY_DISABLED = "1"
  CI = "true"
  SKIP_TYPE_CHECK = "true"
  
  # Performance optimizations for large builds (with Netlify plugin)
  NEXT_DISABLE_CSS_INLINE = "true"
  NEXT_DISABLE_SOURCE_MAPS = "true"
  GENERATE_SOURCEMAP = "false"
  NEXT_BUILD_WORKERS = "1"
  NEXT_PRIVATE_BUILD_CACHE = "false"
  NEXT_PRIVATE_STATIC_OPTIMIZATION = "false"
  
  # CRITICAL FIX: Completely disable build trace collection to prevent hanging
  NEXT_DISABLE_TRACE_COLLECTION = "true"
  NEXT_PRIVATE_OUTPUT_TRACE = "false"
  # NEXT_PRIVATE_OUTPUT_FILE_TRACING = "false" # Allowing Next.js default / plugin to manage this
  UV_THREADPOOL_SIZE = "4"
  NODE_NO_WARNINGS = "1"
  NEXT_PRIVATE_MINIMIZE_BUILD_TIME = "true"
  
  # Configure secrets scanning to omit legitimate public environment variables
  # NEXT_PUBLIC_* variables are meant to be public and embedded in client bundles
  SECRETS_SCAN_OMIT_KEYS = "NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME"
  
  # ========================================
  # AUTH0 AUTHENTICATION CONFIGURATION
  # ========================================
  # Auth0 handles all authentication (login, signup, password reset, social login, etc.)
  # These variables MUST be set in Netlify UI with actual values from your Auth0 application
  # Get these from: https://manage.auth0.com/dashboard/applications/YOUR_APP_ID/settings
  
  # REQUIRED: Auth0 configuration
  # Generate AUTH0_SECRET with: openssl rand -hex 32
  AUTH0_SECRET = "your_auth0_secret_here_generate_with_openssl_rand_hex_32"
  AUTH0_BASE_URL = "https://your-domain.netlify.app"
  AUTH0_ISSUER_BASE_URL = "https://your-tenant.us.auth0.com"
  AUTH0_CLIENT_ID = "your_auth0_client_id_here"
  AUTH0_CLIENT_SECRET = "your_auth0_client_secret_here"
  
  # OPTIONAL: Auth0 API audience (if using Auth0 API)
  AUTH0_AUDIENCE = "https://your-api-identifier"
  
  # ========================================
  # MONITORING & ANALYTICS CONFIGURATION
  # ========================================
  # Sentry for error monitoring (RECOMMENDED for production)
  NEXT_PUBLIC_SENTRY_DSN = "your_sentry_dsn_here"
  NEXT_PUBLIC_SENTRY_ENVIRONMENT = "production"
  NEXT_PUBLIC_SENTRY_RELEASE = "1.0.0"
  
  # Analytics and monitoring
  NEXT_PUBLIC_GA_ID = "your_google_analytics_id_here"
  NEXT_PUBLIC_INTERCOM_APP_ID = "your_intercom_app_id_here"
  # NEXT_PUBLIC_POSTHOG_KEY = "your_posthog_key_here"  # Commented out to prevent 404 errors
  # NEXT_PUBLIC_POSTHOG_HOST = "https://app.posthog.com"  # Commented out to prevent 404 errors
  
  # ========================================
  # WALLET & WEB3 CONFIGURATION  
  # ========================================
  # Reown (WalletConnect) for wallet integration
  NEXT_PUBLIC_REOWN_PROJECT_ID = "your_reown_project_id_here"
  NEXT_PUBLIC_ALCHEMY_API_KEY = "your_alchemy_api_key_here"
  NEXT_PUBLIC_ZION_TOKEN_CONTRACT_ADDRESS = "your_token_contract_address_here"
  NEXT_PUBLIC_ZION_TOKEN_NETWORK_ID = "1"
  NEXT_PUBLIC_SNAPSHOT_SPACE_ID = "yourproject.eth"
  NEXT_PUBLIC_SNAPSHOT_HUB_URL = "https://hub.snapshot.org"
  
  # ========================================
  # PAYMENT PROCESSING CONFIGURATION
  # ========================================
  # Stripe payment processing
  NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY = "pk_live_your_stripe_publishable_key_here"
  STRIPE_SECRET_KEY = "sk_live_your_stripe_secret_key_here"
  STRIPE_WEBHOOK_SECRET = "whsec_your_stripe_webhook_secret_here"
  
  # ========================================
  # MEDIA & CONTENT CONFIGURATION
  # ========================================
  # Cloudinary for image management
  # NEXT_PUBLIC_CLOUDINARY_CLOUD_NAME = Set in Netlify UI
  # CLOUDINARY_API_KEY = Set in Netlify UI  
  # CLOUDINARY_API_SECRET = Set in Netlify UI
  
  # ========================================
  # COMMUNICATION CONFIGURATION
  # ========================================
  # Email configuration
  NEXT_PUBLIC_SUPPORT_EMAIL = "support@yourdomain.com"
  SENDGRID_API_KEY = "SG.your_sendgrid_api_key_here"
  
  # ========================================
  # APPLICATION CONFIGURATION
  # ========================================
  # Application URLs
  NEXT_PUBLIC_APP_URL = "https://your-domain.netlify.app"
  NEXT_PUBLIC_API_URL = "https://your-domain.netlify.app/api"
  # CDN domain for static assets
  NEXT_PUBLIC_CDN_URL = "https://cdn.yourdomain.com"
  
  # Feature flags
  NEXT_PUBLIC_ENABLE_ANALYTICS = "true"
  NEXT_PUBLIC_ENABLE_WALLET = "true"
  NEXT_PUBLIC_ENABLE_PAYMENTS = "true"
  
  # External APIs
  EXAMPLE_API_URL = "https://api.example.com"

# Skip Husky for CI builds
[build.processing]
  skip_processing = false

[build.processing.css]
  bundle = true
  minify = true

[build.processing.js]
  bundle = true
  minify = true

[build.processing.html]
  pretty_urls = true

# Deploy contexts for different environments
[context.production.environment]
  AUTH0_BASE_URL = "https://yourdomain.com"
  NEXT_PUBLIC_SENTRY_ENVIRONMENT = "production"
  NEXT_PUBLIC_ENABLE_ANALYTICS = "true"
  NEXT_PUBLIC_APP_ENV = "production"
  NODE_ENV = "production"
  NEXT_TELEMETRY_DISABLED = "1"
  
  # Production build optimizations (with Netlify plugin)
  NODE_OPTIONS = "--no-deprecation --max-old-space-size=6144 --no-warnings"
  NEXT_DISABLE_CSS_INLINE = "true"
  NEXT_DISABLE_SOURCE_MAPS = "true"
  GENERATE_SOURCEMAP = "false"
  NEXT_BUILD_WORKERS = "1"
  NEXT_PRIVATE_BUILD_CACHE = "false"
  NEXT_PRIVATE_STATIC_OPTIMIZATION = "false"
  
  # CRITICAL FIX: Completely disable build trace collection to prevent hanging
  NEXT_DISABLE_TRACE_COLLECTION = "true"
  NEXT_PRIVATE_OUTPUT_TRACE = "false"
  # NEXT_PRIVATE_OUTPUT_FILE_TRACING = "false" # Allowing Next.js default / plugin to manage this
  UV_THREADPOOL_SIZE = "4"
  NODE_NO_WARNINGS = "1"
  NEXT_PRIVATE_MINIMIZE_BUILD_TIME = "true"

[context.deploy-preview.environment]
  AUTH0_BASE_URL = "https://deploy-preview-${REVIEW_ID}--your-site.netlify.app"
  NEXT_PUBLIC_SENTRY_ENVIRONMENT = "preview"
  NEXT_PUBLIC_ENABLE_ANALYTICS = "false"
  NEXT_PUBLIC_APP_ENV = "preview"
  NEXT_PUBLIC_DEVTOOLS = "true"
  NODE_ENV = "production"
  NEXT_TELEMETRY_DISABLED = "1"

[context.branch-deploy.environment]
  AUTH0_BASE_URL = "https://${BRANCH}--your-site.netlify.app"
  NEXT_PUBLIC_SENTRY_ENVIRONMENT = "staging"
  NEXT_PUBLIC_ENABLE_ANALYTICS = "false"
  NEXT_PUBLIC_APP_ENV = "staging"
  NEXT_PUBLIC_DEVTOOLS = "true"
  NODE_ENV = "production"
  NEXT_TELEMETRY_DISABLED = "1"

# Headers for security and performance
[[headers]]
  for = "/*"
  [headers.values]
    X-Frame-Options = "DENY"
    X-XSS-Protection = "1; mode=block"
    X-Content-Type-Options = "nosniff"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "camera=(), microphone=(), geolocation=()"

[[headers]]
  for = "/_next/static/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/logos/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# Redirects
[[redirects]]
  from = "/home"
  to = "/"
  status = 301

[functions.environment]
  SENTRY_LOG_LEVEL = "debug"

[functions.sentryDsnCheckCron]
  schedule = "@daily"

[functions.healthCheckCron]
    schedule = "*/5 * * * *"

# Add scheduled functions for autonomous cloud automations
[[scheduled]]
  path = "/.netlify/functions/auto_marketing"
  schedule = "0 */6 * * *" # every 6 hours

[[scheduled]]
  path = "/.netlify/functions/perf_audit"
  schedule = "0 3 * * *" # daily at 03:00 UTC

[[plugins]]
  package = "netlify-plugin-cloudinary"
  [plugins.inputs]
    # Point to the correct images directory
    imagesPath = "public/logos"
    # Use production domain  
    deliveryType = "fetch"
    # Set max file size to optimize performance
    maxSize = 1048576
    # Set concurrent uploads
    uploadConcurrency = 10

[[scheduled]]
  path = "/.netlify/functions/link_audit"
  schedule = "30 2 * * *" # daily at 02:30 UTC

[[scheduled]]
  path = "/.netlify/functions/sitemap_refresh"
  schedule = "0 */12 * * *" # every 12 hours

[[scheduled]]
  path = "/.netlify/functions/seo_audit"
  schedule = "15 3 * * *" # daily at 03:15 UTC

[[scheduled]]
  path = "/.netlify/functions/image_audit"
  schedule = "45 3 * * *" # daily at 03:45 UTC

[[scheduled]]
  path = "/.netlify/functions/a11y_audit"
  schedule = "10 4 * * *" # daily at 04:10 UTC

[[scheduled]]
  path = "/.netlify/functions/security_headers_audit"
  schedule = "20 4 * * *" # daily at 04:20 UTC

[[scheduled]]
  path = "/.netlify/functions/rss_health"
  schedule = "*/30 * * * *" # every 30 minutes

[[scheduled]]
  path = "/.netlify/functions/deps_vuln_audit"
  schedule = "0 5 * * *" # daily at 05:00 UTC

[[scheduled]]
  path = "/.netlify/functions/external_link_audit"
  schedule = "30 2 * * 1" # weekly Monday 02:30 UTC

[[scheduled]]
  path = "/.netlify/functions/og_image_audit"
  schedule = "0 4 * * *" # daily at 04:00 UTC

[[scheduled]]
  path = "/.netlify/functions/uptime_synthetic"
  schedule = "*/10 * * * *" # every 10 minutes

[[scheduled]]
  path = "/.netlify/functions/content_freshness"
  schedule = "15 1 * * *" # daily at 01:15 UTC

