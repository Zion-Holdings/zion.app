<<<<<<< HEAD
import React, { useEffect, useCallback } from 'react';

interface AnalyticsTrackerProps {
  enablePerformanceMonitoring?: boolean;
  enableUserEngagement?: boolean;
  enableConversionTracking?: boolean;
}

// Performance entry types for Core Web Vitals
interface PerformanceEventTiming extends PerformanceEntry {
  processingStart: number;
  processingEnd: number;
  target?: any;
}

const AnalyticsTracker: React.FC<AnalyticsTrackerProps> = ({
  pageTitle,
  pagePath,
  customEvents = []
}) => {
  // Track page view
  const trackPageView = useCallback((title: string, path: string) => {
    if (typeof window !== 'undefined') {
      // Google Analytics 4
      if ((window as any).gtag) {
        (window as any).gtag('config', 'G-XXXXXXXXXX', {
          page_title: title,
          page_location: window.location.href,
          page_path: path
        });
      }
    };

    // Viewport tracking
    const trackViewport = () => {
      trackMetric('ViewportWidth', window.innerWidth);
      trackMetric('ViewportHeight', window.innerHeight);
      trackMetric('PixelRatio', window.devicePixelRatio || 1);
    };

    // Helper function to track metrics
    const trackMetric = (name: string, value: number | string) => {
      if (typeof window !== 'undefined' && window.gtag) {
        window.gtag('event', 'custom_metric', {
          metric_name: name,
          metric_value: value,
          timestamp: Date.now()
        });
      }

      // Send to custom analytics endpoint
      if (process.env.NODE_ENV === 'production') {
        fetch('/api/analytics/metrics', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name,
            value,
            timestamp: Date.now(),
            url: window.location.href,
            userAgent: navigator.userAgent
          })
        }).catch(() => {
          // Silently handle fetch errors
=======
import React, { useEffect } from 'react';
import { useRouter } from 'next/router';

interface AnalyticsTrackerProps {
  gaTrackingId?: string;
  enablePerformanceMonitoring?: boolean;
  enableUserBehaviorTracking?: boolean;
}

const AnalyticsTracker: React.FC<AnalyticsTrackerProps> = ({
  gaTrackingId = process.env.NEXT_PUBLIC_GA_ID,
  enablePerformanceMonitoring = true,
  enableUserBehaviorTracking = true
}) => {
  const router = useRouter();

  useEffect(() => {
    // Google Analytics 4 Setup
    if (gaTrackingId && typeof window !== 'undefined') {
      // Load Google Analytics
      const script = document.createElement('script');
      script.src = `https://www.googletagmanager.com/gtag/js?id=${gaTrackingId}`;
      script.async = true;
      document.head.appendChild(script);

      window.dataLayer = window.dataLayer || [];
      function gtag(...args: any[]) {
        window.dataLayer.push(args);
      }
      gtag('js', new Date());
      gtag('config', gaTrackingId, {
        page_title: document.title,
        page_location: window.location.href,
        custom_map: {
          'custom_parameter_1': 'technology_category',
          'custom_parameter_2': 'service_type',
          'custom_parameter_3': 'user_engagement_level'
        }
      });

      // Track page views
      const handleRouteChange = (url: string) => {
        gtag('config', gaTrackingId, {
          page_path: url,
          page_title: document.title
>>>>>>> origin/cursor/analyze-improve-and-deploy-application-616f
        });
      };

<<<<<<< HEAD
    // Helper function to track events
    const trackEvent = (action: string, parameters: Record<string, unknown>) => {
      if (typeof window !== 'undefined' && window.gtag) {
        window.gtag('event', action, {
          ...parameters,
          timestamp: Date.now(),
          page_url: window.location.href
        });
      }

      // Send to custom analytics endpoint
      if (process.env.NODE_ENV === 'production') {
        fetch('/api/analytics/events', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            action,
            parameters,
            timestamp: Date.now(),
            url: window.location.href,
            userAgent: navigator.userAgent
          })
        }).catch(() => {
          // Silently handle fetch errors
        });
      }
    };

    // Initialize analytics and performance monitoring
    const initAnalytics = () => {
      // Google Analytics 4 initialization
      if (typeof window !== 'undefined' && window.gtag) {
        window.gtag('config', 'G-XXXXXXXXXX', {
          page_title: document.title,
          page_location: window.location.href,
          custom_map: {
            dimension1: 'user_type',
            dimension2: 'service_category',
            dimension3: 'page_performance'
          }
        });
      }

      // Performance monitoring
      if ('performance' in window) {
        // Core Web Vitals monitoring
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.entryType === 'largest-contentful-paint') {
              // Track LCP
              trackMetric('LCP', entry.startTime);
            } else if (entry.entryType === 'first-input') {
              // Track FID - cast to proper type
              const firstInputEntry = entry as PerformanceEventTiming;
              trackMetric('FID', firstInputEntry.processingStart - firstInputEntry.startTime);
            } else if (entry.entryType === 'layout-shift') {
              // Track CLS - cast to proper type
              const layoutShiftEntry = entry as LayoutShift;
              trackMetric('CLS', layoutShiftEntry.value);
            }
          }
        });

        try {
          observer.observe({ entryTypes: ['largest-contentful-paint', 'first-input', 'layout-shift'] });
        } catch {
          // Fallback for older browsers
        }

        // Track page load performance
        window.addEventListener('load', () => {
          setTimeout(() => {
            const navigation = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
            if (navigation) {
              trackMetric('TTFB', navigation.responseStart - navigation.requestStart);
              trackMetric('DOMContentLoaded', navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart);
              trackMetric('LoadComplete', navigation.loadEventEnd - navigation.loadEventStart);
            }

            // Track resource loading performance
            const resources = performance.getEntriesByType('resource');
            const slowResources = resources.filter((resource) => (resource as any).duration > 1000);
            if (slowResources.length > 0) {
              trackMetric('SlowResources', slowResources.length);
            }
          }, 0);
        });
      }

      // Add event listeners
      document.addEventListener('click', trackInteraction);
      document.addEventListener('scroll', trackInteraction);
      document.addEventListener('keydown', trackInteraction);

      // Error tracking
      window.addEventListener('error', (event) => {
        trackEvent('Error', {
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          error: event.error?.stack
        });
      });

      // Unhandled promise rejection tracking
      window.addEventListener('unhandledrejection', (event) => {
        trackEvent('UnhandledRejection', {
          reason: event.reason,
          promise: event.promise
        });
      });

      // Network status monitoring
      if ('navigator' in window && 'connection' in navigator) {
        const connection = (navigator as any).connection;
        if (connection) {
          trackMetric('ConnectionType', connection.effectiveType || 'unknown');
          trackMetric('ConnectionDownlink', connection.downlink || 0);
          trackMetric('ConnectionRTT', connection.rtt || 0);
        }
      }

      // Memory usage monitoring (if available)
      if ('memory' in performance) {
        const memory = (performance as any).memory;
        if (memory) {
          setInterval(() => {
            trackMetric('MemoryUsage', memory.usedJSHeapSize / 1024 / 1024); // MB
            trackMetric('MemoryLimit', memory.jsHeapSizeLimit / 1024 / 1024); // MB
          }, 30000); // Every 30 seconds
        }
      }

      // Battery status monitoring (if available)
      if ('getBattery' in navigator) {
        (navigator as any).getBattery().then((battery: any) => {
          trackMetric('BatteryLevel', battery.level * 100);
          trackMetric('BatteryCharging', battery.charging ? 1 : 0);
        });
      }

      // Device capabilities tracking
      trackMetric('DeviceMemory', (navigator as any).deviceMemory || 0);
      trackMetric('HardwareConcurrency', navigator.hardwareConcurrency || 0);
      trackMetric('MaxTouchPoints', navigator.maxTouchPoints || 0);
      trackMetric('UserAgent', navigator.userAgent.length);

      // Viewport tracking
      trackViewport();
      window.addEventListener('resize', trackViewport);

      // Page visibility tracking
      let hiddenTime = 0;
      let startTime = Date.now();
      
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          hiddenTime = Date.now();
        } else {
          const visibleTime = Date.now() - hiddenTime;
          if (hiddenTime > 0) {
            trackMetric('PageHiddenDuration', visibleTime);
          }
          startTime = Date.now();
        }
      });

      // Session duration tracking
      setInterval(() => {
        const sessionDuration = Date.now() - startTime;
        trackMetric('SessionDuration', sessionDuration);
      }, 60000); // Every minute
    };

    // Initialize when component mounts
    initAnalytics();

    // Cleanup function
    return () => {
      // Remove event listeners if needed
      document.removeEventListener('click', trackInteraction);
      document.removeEventListener('scroll', trackInteraction);
      document.removeEventListener('keydown', trackInteraction);
      window.removeEventListener('resize', trackViewport);
    };
  }, []);

  // Track page views on route changes
  useEffect(() => {
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('config', 'G-XXXXXXXXXX', {
        page_path: router.asPath,
        page_title: document.title,
        page_location: window.location.href
      });
    }

    // Track custom page view event
    trackEvent('PageView', {
      path: router.asPath,
      title: document.title,
      referrer: document.referrer,
      timestamp: Date.now()
    });

    // Track page performance metrics
          if ('performance' in window) {
        const navigation = performance.getEntriesByType('navigation')[0] as any;
        if (navigation) {
          const startTime = navigation.startTime || 0;
          trackMetric('PageLoadTime', navigation.loadEventEnd - startTime);
          trackMetric('DOMReadyTime', navigation.domContentLoadedEventEnd - startTime);
        }
      }
  }, [router.asPath]);

  // Helper function to track metrics
  const trackMetric = (name: string, value: number | string) => {
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('event', 'custom_metric', {
        metric_name: name,
        metric_value: value,
        timestamp: Date.now()
      });
    }

    // Send to custom analytics endpoint
    if (process.env.NODE_ENV === 'production') {
      fetch('/api/analytics/metrics', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name,
          value,
          timestamp: Date.now(),
          url: window.location.href,
          userAgent: navigator.userAgent
        })
      }).catch(() => {
        // Silently handle fetch errors
      });
    }
  };

  // Helper function to track events
  const trackEvent = (action: string, parameters: Record<string, unknown>) => {
    if (typeof window !== 'undefined' && window.gtag) {
      window.gtag('event', action, {
        ...parameters,
        timestamp: Date.now(),
        page_url: window.location.href
      });
    }

    // Send to custom analytics endpoint
    if (process.env.NODE_ENV === 'production') {
      fetch('/api/analytics/events', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          action,
          parameters,
          timestamp: Date.now(),
          url: window.location.href,
          userAgent: navigator.userAgent
        })
      }).catch(() => {
        // Silently handle fetch errors
      });
    }
  };

  // Component doesn't render anything
=======
      router.events.on('routeChangeComplete', handleRouteChange);

      return () => {
        router.events.off('routeChangeComplete', handleRouteChange);
      };
    }
  }, [gaTrackingId, router]);

  useEffect(() => {
    if (enablePerformanceMonitoring && typeof window !== 'undefined') {
      // Performance Monitoring
      const trackPerformance = () => {
        if ('performance' in window) {
          const navigation = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
          const paint = performance.getEntriesByType('paint');
          
          if (navigation) {
            const metrics = {
              dns_lookup: navigation.domainLookupEnd - navigation.domainLookupStart,
              tcp_connection: navigation.connectEnd - navigation.connectStart,
              server_response: navigation.responseEnd - navigation.requestStart,
              dom_loading: navigation.domContentLoadedEventEnd - navigation.domContentLoadedEventStart,
              dom_complete: navigation.domComplete - navigation.domContentLoadedEventEnd,
              load_complete: navigation.loadEventEnd - navigation.loadEventStart,
              total_time: navigation.loadEventEnd - navigation.navigationStart
            };

            // Send performance metrics to analytics
            if (window.gtag) {
              window.gtag('event', 'performance_metrics', {
                event_category: 'Performance',
                event_label: 'Page Load',
                value: Math.round(metrics.total_time),
                custom_parameters: metrics
              });
            }

            // Log performance issues
            if (metrics.total_time > 3000) {
              console.warn('Slow page load detected:', metrics.total_time + 'ms');
            }
          }

          // Track Core Web Vitals
          if ('PerformanceObserver' in window) {
            try {
              const observer = new PerformanceObserver((list) => {
                for (const entry of list.getEntries()) {
                  if (entry.entryType === 'largest-contentful-paint') {
                    const lcp = entry.startTime;
                    if (window.gtag) {
                      window.gtag('event', 'core_web_vitals', {
                        event_category: 'Performance',
                        event_label: 'LCP',
                        value: Math.round(lcp)
                      });
                    }
                  }
                }
              });
              observer.observe({ entryTypes: ['largest-contentful-paint'] });
            } catch (e) {
              console.warn('PerformanceObserver not supported');
            }
          }
        }
      };

      // Track after page load
      if (document.readyState === 'complete') {
        trackPerformance();
      } else {
        window.addEventListener('load', trackPerformance);
        return () => window.removeEventListener('load', trackPerformance);
      }
    }
  }, [enablePerformanceMonitoring]);

  useEffect(() => {
    if (enableUserBehaviorTracking && typeof window !== 'undefined') {
      // User Behavior Tracking
      let scrollDepth = 0;
      let timeOnPage = 0;
      let startTime = Date.now();

      const trackScroll = () => {
        const scrollPercent = Math.round((window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100);
        if (scrollPercent > scrollDepth) {
          scrollDepth = scrollPercent;
          
          // Track scroll milestones
          if ([25, 50, 75, 100].includes(scrollPercent)) {
            if (window.gtag) {
              window.gtag('event', 'scroll_depth', {
                event_category: 'Engagement',
                event_label: `${scrollPercent}%`,
                value: scrollPercent
              });
            }
          }
        }
      };

      const trackTimeOnPage = () => {
        timeOnPage = Math.round((Date.now() - startTime) / 1000);
        
        // Track time milestones
        if ([30, 60, 120, 300, 600].includes(timeOnPage)) {
          if (window.gtag) {
            window.gtag('event', 'time_on_page', {
              event_category: 'Engagement',
              event_label: `${timeOnPage}s`,
              value: timeOnPage
            });
          }
        }
      };

      const trackUserEngagement = () => {
        // Track clicks on important elements
        document.addEventListener('click', (e) => {
          const target = e.target as HTMLElement;
          const button = target.closest('button');
          const link = target.closest('a');
          
          if (button || link) {
            const element = button || link;
            const text = element.textContent?.trim() || 'Unknown';
            const href = (element as HTMLAnchorElement).href || '';
            
            if (window.gtag) {
              window.gtag('event', 'element_click', {
                event_category: 'Engagement',
                event_label: text,
                custom_parameters: {
                  element_type: button ? 'button' : 'link',
                  element_text: text,
                  element_href: href
                }
              });
            }
          }
        });

        // Track form interactions
        document.addEventListener('submit', (e) => {
          const form = e.target as HTMLFormElement;
          if (window.gtag) {
            window.gtag('event', 'form_submit', {
              event_category: 'Engagement',
              event_label: form.action || 'Unknown Form',
              custom_parameters: {
                form_action: form.action,
                form_method: form.method
              }
            });
          }
        });
      };

      // Initialize tracking
      trackUserEngagement();
      window.addEventListener('scroll', trackScroll);
      const timeInterval = setInterval(trackTimeOnPage, 1000);

      return () => {
        window.removeEventListener('scroll', trackScroll);
        clearInterval(timeInterval);
      };
    }
  }, [enableUserBehaviorTracking]);

  useEffect(() => {
    // Error Tracking
    if (typeof window !== 'undefined') {
      const handleError = (event: ErrorEvent) => {
        if (window.gtag) {
          window.gtag('event', 'exception', {
            description: event.message,
            fatal: false,
            custom_parameters: {
              filename: event.filename,
              lineno: event.lineno,
              colno: event.colno
            }
          });
        }
      };

      const handleUnhandledRejection = (event: PromiseRejectionEvent) => {
        if (window.gtag) {
          window.gtag('event', 'exception', {
            description: event.reason?.toString() || 'Unhandled Promise Rejection',
            fatal: false
          });
        }
      };

      window.addEventListener('error', handleError);
      window.addEventListener('unhandledrejection', handleUnhandledRejection);

      return () => {
        window.removeEventListener('error', handleError);
        window.removeEventListener('unhandledrejection', handleUnhandledRejection);
      };
    }
  }, []);

  // Return null as this is a utility component
>>>>>>> origin/cursor/analyze-improve-and-deploy-application-616f
  return null;
};

// Type definitions for performance entries
interface FirstInputEntry extends PerformanceEntry {
  processingStart: number;
  processingEnd: number;
  target?: any;
}

interface LayoutShiftEntry extends PerformanceEntry {
  hadRecentInput: boolean;
  value: number;
}

interface LayoutShiftSource {
  node?: any;
  currentRect?: any;
  previousRect?: any;
}

// Extend Window interface for gtag
declare global {
  interface Window {
    gtag?: (...args: unknown[]) => void;
  }
}

export default AnalyticsTracker;